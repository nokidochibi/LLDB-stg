<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Love Like DataBase</title>
    <meta name="theme-color" content="#E63946">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-0D09G3X4F1');
    </script>

    <link rel="icon" type="image/png" href="./icon.png">
    <link rel="apple-touch-icon" href="./icon.png">
    <link rel="manifest" href='data:application/manifest+json,{"name":"Love Like DataBase","short_name":"LLDB","start_url":".","display":"standalone","background_color":"%23F8F8F8","theme_color":"%23ef4444","icons":[{"src":"./icon.png","sizes":"192x192%20512x512","type":"image/png"}]}'>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.4.4/lz-string.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">

    <style>
        /* ==========================================================================
           ã€0. GLOBALã€‘ ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ«
           ========================================================================== */
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #F8F9FA; /* Off-White for Hub */
            color: #334155;
            overflow: hidden;
            touch-action: pan-y pinch-zoom;
            -webkit-tap-highlight-color: transparent;
        }
        /* ã‚¢ãƒ—ãƒªç”»é¢ã‚³ãƒ³ãƒ†ãƒŠå®šç¾© */
        .app-screen {
            position: fixed; top: 60px; left: 0; width: 100%; height: calc(100% - 60px);
            display: none; flex-direction: column;
            overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch;
            background-color: #F8F9FA; animation: fadeIn 0.3s ease-out;
        }
        .app-screen.active { display: flex; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    </style>

    <script>
        // ==========================================================================
        // ã€0. GLOBALã€‘ å…±é€šå®šæ•°è¨­å®š
        // ==========================================================================
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
        const ICON_URL = "https://unavatar.io/twitter/noki_dochibi";
        const APP_VERSION = "v4.7.1"; /* Major Update for Renewal */
    </script>
</head>
<body class="bg-gray-50">

    <style>
        /* æš–ç°¾ãƒ¡ãƒ‹ãƒ¥ãƒ¼ & ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        #noren-menu {
            position: fixed; top: 60px; left: 0; width: 100%;
            max-height: calc(100vh - 80px); /* ç”»é¢ä¸‹ç«¯ã«å°‘ã—ä½™è£•ã‚’æŒãŸã›ã‚‹ */
            overflow-y: auto;
            -webkit-overflow-scrolling: touch; /* iOSã§ã®æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */

            background-color: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1); z-index: 50;
            transform: translateY(-120%); 
            transition: transform 0.4s cubic-bezier(0.25, 1, 0.5, 1);
            border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; border-bottom: 1px solid #f1f5f9;
            display: block; visibility: hidden;
        }
        #noren-menu.open { transform: translateY(0); visibility: visible; }
        
        .noren-item { display: flex; align-items: center; gap: 14px; padding: 18px 24px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background-color 0.2s; }
        .noren-item:active { background-color: #f8fafc; }
        .noren-icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 22px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); }
        
        #noren-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 40; display: none; opacity: 0; transition: opacity 0.3s; }
        #noren-overlay.open { display: block; opacity: 1; }

        #main-app-header {
            height: 60px; width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 16px;
            position: fixed; top: 0; z-index: 60;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s;
            /* ã‚¿ãƒƒãƒ—å¯èƒ½ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºå”† */
            cursor: pointer; 
        }

        .flower-icon {
            font-size: 24px;
            display: inline-block;
            transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .flower-icon.rotate { transform: rotate(180deg) scale(1.1); }

        #about-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); opacity: 0; transition: opacity 0.3s; }
        #about-modal.open { display: flex; opacity: 1; }
        .modal-card { background: white; width: 90%; max-width: 400px; border-radius: 24px; padding: 28px; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); transform: scale(0.95); transition: transform 0.3s; }
        #about-modal.open .modal-card { transform: scale(1); }
    </style>

    <div id="noren-overlay" onclick="toggleNoren()"></div>
    <div id="noren-menu">
        <div class="flex flex-col">
            <div class="noren-item" onclick="switchApp('live')">
                <div class="noren-icon bg-[#E63946]"><i data-lucide="mic-2" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 text-lg">LLDB Live</div>
                    <div class="text-xs text-gray-400 mt-0.5">ã‚»ãƒˆãƒª / æ¼”å¥å›æ•° / å‚¾å‘</div>
                </div>
                <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
            </div>

            <div class="noren-item" onclick="switchApp('trends')">
                <div class="noren-icon bg-[#1D3557]"><i data-lucide="trending-up" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 text-lg">LLDB Trends</div>
                    <div class="text-xs text-gray-400 mt-0.5">Youtubeå†ç”Ÿæ•° / SNSãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼è¨˜éŒ²</div>
                </div>
                <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
            </div>

            <div class="noren-item" onclick="switchApp('songHelper')">
                <div class="noren-icon bg-[#F4A261]"><i data-lucide="music" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 text-lg">LLDB Song Helper</div>
                    <div class="text-xs text-gray-400 mt-0.5">ãƒ•ãƒ¬ãƒ¼ã‚º/æ¥½æ›²æ¤œç´¢</div>
                </div>
                <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
            </div>

            <div class="noren-item" onclick="switchApp('history')">
                <div class="noren-icon bg-[#2A9D8F]"><i data-lucide="heart-handshake" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 text-lg">LLDB History</div>
                    <div class="text-xs text-gray-400 mt-0.5">ã‚ãŸã—ã¨aikoã®äººç”Ÿå¹´è¡¨</div>
                </div>
                <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
            </div>

            <div class="noren-item" onclick="openMyLLDBModal()">
                <div class="noren-icon bg-indigo-600"><i data-lucide="database" class="w-6 h-6"></i></div>
                <div class="flex-1">
                    <div class="font-bold text-gray-800 text-lg">My LLDB</div>
                    <div class="text-xs text-gray-400 mt-0.5">å‚æˆ¦è¨˜éŒ² / ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—</div>
                </div>
                <i data-lucide="settings-2" class="text-gray-300 w-5 h-5"></i>
            </div>
 
        <div class="noren-item bg-gray-50/50" onclick="openSetlistForm()">
            <div class="noren-icon bg-blue-500"><i data-lucide="send" class="w-6 h-6"></i></div>
            <div class="flex-1">
                <div class="font-bold text-gray-600 text-lg">ã‚»ãƒˆãƒªæŠ•ç¨¿</div>
                <div class="text-xs text-gray-400 mt-0.5">ã‚»ãƒˆãƒªã®æƒ…å ±æä¾›ã®å”åŠ›ï¼ˆé æ…®ã›ãšï¼ï¼‰</div>
            </div>
            <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
        </div>
            
            <div class="noren-item bg-gray-50/50" onclick="openAboutModal()">
                <div class="noren-icon bg-gray-400"><i data-lucide="info" class="w-6 h-6"></i></div>
                <div class="flex-1">
                <div class="font-bold text-gray-600 text-lg">ã“ã®ã‚¢ãƒ—ãƒªã«ã¤ã„ã¦</div>
              <div class="text-xs text-gray-400 mt-0.5">ã‚¢ãƒ—ãƒªã®èª¬æ˜ / æ›´æ–°å±¥æ­´</div>
            </div>
            <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
          </div>
    
    <div class="noren-item bg-gray-50/50" onclick="forceReloadApp()">
            <div class="noren-icon bg-gray-600"><i data-lucide="refresh-cw" class="w-6 h-6"></i></div>
            <div class="flex-1">
              <div class="font-bold text-gray-600 text-lg">æœ€æ–°ç‰ˆã‚’èª­ã¿è¾¼ã¿</div>
              <div class="text-xs text-gray-400 mt-0.5">å¼·åˆ¶å†èµ·å‹•ï¼ˆæŒ™å‹•ãŒå¤‰ãªã¨ãï¼‰</div>
            </div>
            <i data-lucide="chevron-right" class="text-gray-300 w-5 h-5"></i>
          </div>
    </div>

    <div class="py-4 flex justify-center cursor-pointer hover:bg-gray-50 active:bg-gray-100 transition rounded-b-[24px]" onclick="toggleNoren()">
      <div class="w-12 h-1.5 bg-gray-300 rounded-full"></div>
    </div>
  </div>

    <header id="main-app-header" class="bg-[#E63946] text-white transition-colors duration-300">
        <h1 class="font-black text-[22px] tracking-wide flex-1 truncate pr-2" id="header-title"><span id="header-title-text">Love Like DataBase</span> <span id="display-version">vol. </span></h1>
        
        <button id="header-menu-btn" onclick="toggleNoren()" class="p-2 rounded-full hover:bg-white/20 transition active:scale-90 flex items-center justify-center w-10 h-10">
            <span class="flower-icon select-none">ğŸŒ¸</span>
        </button>
    </header>


    <div id="about-modal" onclick="closeAboutModal()">
        <div class="modal-card" onclick="event.stopPropagation()">
            <div class="text-center mb-6">
                <h2 class="font-bold text-xl text-gray-800">Love Like DataBase</h2>
              </div>
            
            <div class="space-y-4 text-sm text-gray-600 leading-relaxed overflow-y-auto max-h-[30vh]">
                <p>ã“ã®ã‚¢ãƒ—ãƒªã¯ã€å€‹äººé–‹ç™ºè€…ãŒè¶£å‘³ã§ä½œã£ãŸã€éå…¬å¼ã®ãƒ•ã‚¡ãƒ³ã‚¢ãƒ—ãƒªã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã®èª¤ã‚Šã‚’å«ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚</p>
                <p>ä¸å…·åˆã‚„ã€Œã“ã“é–“é•ã£ã¦ã‚‹ã‚ˆï¼ã€ã¨ã„ã†ã”æŒ‡æ‘˜ã¯ã€X ã¾ã§ãŠå¯„ã›ã„ãŸã ã‘ã‚‹ã¨å¬‰ã—ã„ã§ã™ã€‚</p>
            </div>


            <div class="mt-4 flex justify-center">
                <a href="https://twitter.com/noki_dochibi" target="_blank" class="flex items-center gap-2 px-5 py-2.5 bg-black text-white rounded-full text-xs font-bold hover:bg-gray-800 transition shadow-lg active:scale-95">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-3.5 h-3.5 fill-current" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                    é–‹ç™ºè€… @noki_dochibi
                </a>
            </div>
            
            <div class="history-list mt-6">
                <div class="flex items-center gap-2 mb-3">
                    <i data-lucide="history" class="w-4 h-4 text-gray-400"></i>
                    <h3 class="font-bold text-gray-600 text-xs">æ›´æ–°å±¥æ­´</h3>
                </div>
                <div id="update-history-content" class="max-h-[300px] overflow-y-auto no-scrollbar">
                    <div class="text-center py-4 text-gray-400 text-xs animate-pulse">èª­ã¿è¾¼ã¿ä¸­...</div>
                </div>
            </div>


            <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                 <button onclick="closeAboutModal()" class="text-gray-400 text-sm font-bold hover:text-gray-600 px-4 py-2">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>

    <div id="mylldb-modal" class="fixed inset-0 bg-black/50 z-[100] hidden items-center justify-center backdrop-blur-sm opacity-0 transition-opacity duration-300" onclick="closeMyLLDBModal()">
          <div class="bg-white w-[95%] max-w-md rounded-xl shadow-2xl overflow-hidden transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
        
            <div class="bg-[#4F46E5] px-5 py-4 flex items-center justify-between">
              <div class="flex items-center gap-2 text-white">
                <i data-lucide="database" class="w-5 h-5"></i>
                <h2 class="font-bold text-lg">My LLDB è¨­å®š</h2>
              </div>
              <button onclick="closeMyLLDBModal()" class="text-white/80 hover:text-white">
                <i data-lucide="x" class="w-6 h-6"></i>
              </button>
            </div>
        
            <div class="p-6 overflow-y-auto max-h-[75vh] text-gray-600">
              
              <p class="text-sm mb-5 font-bold text-gray-500">
            å‚æˆ¦ãƒ¡ãƒ¢ã‚„èª•ç”Ÿæ—¥ã‚’ä¿å­˜ã§ãã¾ã™ã€‚<br>
            â€»é‡è¦â€»<br>
            å‚æˆ¦ãƒ¡ãƒ¢ã¯ä¿å­˜ã•ã‚Œç¶šã‘ã‚‹ä¿è¨¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>
            æ¶ˆãˆã¦ã‚‚å•é¡ŒãŒãªã„æƒ…å ±ã®ã¿ã‚’è¨˜è¼‰ã™ã‚‹ã“ã¨ã‚’<br>
            ãŠå‹§ã‚ã—ã¾ã™ã€‚
            </p>
        
              <h3 class="text-sm font-bold text-gray-700 mb-3">â–¼ãƒ‡ãƒ¼ã‚¿ä¿å­˜æ–¹æ³•ï¼ˆâ‘ ã‹â‘¡ã®ã©ã¡ã‚‰ã‹ã‚’é¸ã‚“ã§ã­ï¼‰</h3>
        
              <div class="mb-6">
                <p class="text-sm text-gray-600 mb-2 leading-relaxed">
            â‘ ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ï¼šè‡ªå‹•ã§åŒæœŸã•ã‚Œã¾ã™ã€‚<span id="active-user-count" class="text-xs text-orange-500 font-bold ml-1"></span><br>
            <span class="text-gray-400 text-[12px]">ã€€â€»æƒ…å ±ã¯æš—å·åŒ–ã•ã‚Œã€ã‚¯ãƒ©ã‚¦ãƒ‰ä¸Šã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚<br>ã€€(æš—å·åŒ–ã®ä¾‹â†’Ã¨Â¾mÃ¬Â»â€˜ÃˆÃ¥â€¦Ã§â€Â·Ã¥F&amp;Ã¥â‚¬Â¼Ã¨Â¾Â©Ã¥Â®Ã§Â¨Â¿)</span>
          </p>
        
                <div id="sync-setup-area" class="bg-indigo-50 rounded-lg p-4 border border-indigo-100 text-center">
                    <button onclick="UserDataManager.generateSyncId()" class="w-full bg-[#4F46E5] text-white font-bold py-3 rounded-lg text-sm shadow hover:bg-indigo-600 transition flex items-center justify-center gap-2 mb-3">
                        <i data-lucide="key" class="w-4 h-4"></i>
                        LLDB IDã‚’ç™ºè¡Œã™ã‚‹
                    </button>
                    <button onclick="document.getElementById('sync-input-area').classList.toggle('hidden')" class="text-xs text-[#4F46E5] underline hover:text-indigo-700">
                        ã™ã§ã«IDã‚’æŒã£ã¦ã„ã‚‹æ–¹ã¯ã“ã¡ã‚‰
                    </button>
        
                    <div id="sync-input-area" class="hidden mt-3 flex gap-2">
                        <input type="text" id="manual-sync-id" placeholder="IDã‚’å…¥åŠ›" class="flex-1 text-xs border border-gray-300 rounded px-2 py-2">
                        <button onclick="UserDataManager.setSyncIdManual()" class="bg-gray-800 text-white text-xs px-3 rounded font-bold">è¨­å®š</button>
                    </div>
                </div>
        
                <div id="sync-active-area" class="hidden bg-green-50 rounded-lg p-4 border border-green-100">
                    <div class="flex justify-between items-end mb-2">
                        <div onclick="UserDataManager.logout()" class="flex items-center gap-2 text-green-700 font-bold text-sm cursor-pointer hover:underline" title="ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ">
                            <i data-lucide="check-circle" class="w-4 h-4"></i> è‡ªå‹•åŒæœŸä¸­ <span class="text-[10px] font-normal">(è§£é™¤)</span>
                        </div>
                        <div id="last-sync-time" class="text-[10px] text-gray-400"></div>
                    </div>
                    
                    <div class="flex items-center justify-between bg-white rounded border border-green-200 px-3 py-2">
                        <div>
                            <div class="text-[10px] text-gray-400">ã‚ãªãŸã®ID</div>
                            <div id="current-sync-id" class="font-mono font-bold text-sm text-gray-700">Loading...</div>
                        </div>
                        <button onclick="navigator.clipboard.writeText(document.getElementById('current-sync-id').textContent); alert('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ')" class="text-gray-400 hover:text-green-600">
                            <i data-lucide="copy" class="w-4 h-4"></i>
                        </button>
                    </div>
                    
                    <div class="mt-2 text-center">
                         <button onclick="UserDataManager.loadFromCloud()" class="text-[10px] text-green-600/70 underline hover:text-green-800">ãƒ‡ãƒ¼ã‚¿ã‚’å†èª­ã¿è¾¼ã¿</button>
                    </div>
                </div>
              </div>
        
              <div class="mb-8">
                <p class="text-sm text-gray-600 mb-2 leading-relaxed">
                  â‘¡ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼šæ‰‹å‹•ã§ã‚¹ãƒãƒ›ã«ä¿å­˜ã—ã¦ãã ã•ã„ã€‚<br>
                  <span class="text-gray-400 text-[12px]">ã€€â€»ãƒ‡ãƒ¼ã‚¿ã¯ã‚ãªãŸã®ã‚¹ãƒãƒ›ã«ã—ã‹ä¿å­˜ã•ã‚Œã¾ã›ã‚“</span>
                </p>
                <div class="grid grid-cols-2 gap-3">
                  <button onclick="UserDataManager.backupToFile()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-xs font-bold hover:bg-gray-200 flex flex-col items-center gap-1 border border-gray-200">
                    <i data-lucide="save" class="w-5 h-5 mb-1"></i>
                    ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
                  </button>
                  <button onclick="document.getElementById('file-upload').click()" class="bg-gray-100 text-gray-600 py-3 rounded-xl text-xs font-bold hover:bg-gray-200 flex flex-col items-center gap-1 border border-gray-200">
                    <i data-lucide="folder-open" class="w-5 h-5 mb-1"></i>
                    ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
                  </button>
                  <input type="file" id="file-upload" accept=".json" class="hidden" onchange="UserDataManager.restoreFromFile(this)">
                </div>
              </div>
        
              <div>
                <h3 class="text-sm font-bold text-gray-700 mb-3">â–¼ãƒ‡ãƒ¼ã‚¿æ›¸ãå‡ºã—ï¼ˆãƒ‘ã‚½ã‚³ãƒ³ç­‰ã§è¨˜éŒ²ã‚’è¦‹ãŸã„ã¨ãç”¨ï¼‰</h3>
                <p class="text-[12px] text-gray-400 mb-2">ã€€â€»å¿…è¦ãŒãªã‘ã‚Œã°ã‚„ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚<br>ã€€</p>
                <button onclick="UserDataManager.exportCSV()" class="w-full border border-gray-300 text-gray-600 py-3 rounded-xl text-sm font-bold hover:bg-gray-50 flex items-center justify-center gap-2">
                  <i data-lucide="file-spreadsheet" class="w-4 h-4"></i>
                  å‚æˆ¦å±¥æ­´ã‚’CSVã§å‡ºåŠ›
                </button>
                <p class="text-[12px] text-gray-400 mt-2 text-center leading-tight">
                  å‚æˆ¦ãƒ¡ãƒ¢ã‚’Excelã§é–‹ã‘ã‚‹å½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚<br>
                  ã‚¢ãƒ—ãƒªãŒä½¿ãˆãªããªã£ã¦ã‚‚ã€ã‚ãªãŸã®ãƒ‡ãƒ¼ã‚¿ã‚’æ®‹ã›ã¾ã™ã€‚
                </p>
              </div>
        
            </div>
          </div>
        </div>


    <div id="app-live" class="app-screen active">
        <iframe src="./index_LLDBLive.html" class="w-full h-full border-none"></iframe>
    </div>

    <div id="app-trends" class="app-screen">
        <iframe src="./index_LLDBTrends.html" class="w-full h-full border-none"></iframe>
    </div>

    <div id="app-songHelper" class="app-screen">
        <iframe src="./index_LLDBSongHelper.html" class="w-full h-full border-none"></iframe>
    </div>

    <div id="app-history" class="app-screen">
        <iframe src="./index_LLDBHistory.html" class="w-full h-full border-none"></iframe>
    </div>


    <script>
        // â–¼ ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ–‡å­—åˆ—ã®æ•´å½¢ãƒ­ã‚¸ãƒƒã‚¯ (New) â–¼
        const versionNum = APP_VERSION.replace('v', '');
        const versionParts = versionNum.split('.');
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨: 2æ¡è¡¨ç¤º & vol. è¡¨è¨˜ (ä¾‹: vol.4.2)
        const headerVersion = `vol.${versionParts[0]}.${versionParts[1]}`;
        // Aboutç”¨: 3æ¡è¡¨ç¤º & vol. è¡¨è¨˜ (ä¾‹: vol.4.2.1)
        const aboutVersion = `vol.${versionNum}`;

        // â˜…è¿½åŠ : ã‚¢ãƒ—ãƒªåï¼ˆConfigã‚·ãƒ¼ãƒˆï¼‰ã¨å†…éƒ¨IDã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const APP_ID_MAP = {
          'LLDB Live': 'live',
          'LLDB Trends': 'trends',
          'LLDB Song Helper': 'songHelper',
          'LLDB History': 'history'
        };

        // ã‚¢ãƒ—ãƒªå®šç¾© (ã‚¿ã‚¤ãƒˆãƒ«æ›´æ–°)
        const apps = {
            'live': { title: 'Love Like DataBase', color: 'bg-[#E63946]' }, /* Red */
            'trends': { title: 'LLDB Trends', color: 'bg-[#1D3557]' },       /* Navy */
            'songHelper': { title: 'LLDB Song Helper', color: 'bg-[#F4A261]' }, /* Orange */
            'history': { title: 'LLDB History', color: 'bg-[#2A9D8F]' }      /* Teal */
        };

        // ==========================================================================
        // ã€My LLDBã€‘ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
        // ==========================================================================
        const UserDataManager = {
            DATA_KEY: 'lldb_user_data_v1', // localStorage key
            
            // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®åˆæœŸå€¤
            data: {
                version: 1,
                profile: { birthday: '' },
                attendedLives: {}, // ID: { memo: '', link: '', timestamp: ... }
                settings: { syncId: null, lastSync: null }
            },

            // 1. åˆæœŸåŒ– & ãƒ­ãƒ¼ãƒ‰
            init: function() {
                const saved = localStorage.getItem(this.DATA_KEY);
                if (saved) {
                    try {
                        // LZStringåœ§ç¸®ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“åˆ¤å®š: '{' ã§å§‹ã¾ã‚‰ãªã‘ã‚Œã°åœ§ç¸®ãƒ‡ãƒ¼ã‚¿ï¼‰
                        let parsed;
                        if (saved.trim().startsWith('{')) {
                            parsed = JSON.parse(saved);
                        } else {
                            const decompressed = LZString.decompressFromUTF16(saved);
                            parsed = JSON.parse(decompressed);
                        }
                        // ãƒãƒ¼ã‚¸ (æ–°é …ç›®ãŒå¢—ãˆãŸå ´åˆã«å¯¾å¿œ)
                        this.data = { ...this.data, ...parsed };
                    } catch (e) {
                        console.error('Data Load Error:', e);
                        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                }
                this.updateUI();
                this.broadcastData(); // å„ã‚¢ãƒ—ãƒªã¸ãƒ‡ãƒ¼ã‚¿ã‚’é…ä¿¡
                lucide.createIcons();
            },

           // 2. ä¿å­˜ (Local Storage & Auto Cloud Sync)
            save: function(skipSync = false) { // â˜…å¼•æ•°è¿½åŠ 
                try {
                    const stringified = JSON.stringify(this.data);
                    // åœ§ç¸®ã—ã¦ä¿å­˜
                    const compressed = LZString.compressToUTF16(stringified);
                    localStorage.setItem(this.DATA_KEY, compressed);
            
                    this.broadcastData();
                    console.log('User data saved locally.');
            
                    // â˜…è¿½åŠ : IDè¨­å®šæ¸ˆã¿ãªã‚‰è‡ªå‹•ã§ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸï¼ˆã‚µã‚¤ãƒ¬ãƒ³ãƒˆå®Ÿè¡Œï¼‰
                    if (!skipSync && this.data.settings.syncId) {
                        this.syncToCloud(true);
                    }
                } catch (e) {
            console.error('Save Error:', e);
            alert('å®¹é‡ä¸è¶³ã®ãŸã‚ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
            }
            },

            // 3. ãƒ‡ãƒ¼ã‚¿é…ä¿¡ (å„iframeã¸)
            broadcastData: function() {
                const frames = document.querySelectorAll('iframe');
                frames.forEach(frame => {
                    if (frame.contentWindow) {
                        frame.contentWindow.postMessage({
                            type: 'userDataUpdated',
                            data: this.data
                        }, '*');
                    }
                });
            },

            // 4. ãƒ‡ãƒ¼ã‚¿æ›´æ–°ç”¨API (å­ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰å‘¼ã°ã‚Œã‚‹)
            updateAttendedLive: function(liveId, info) {
                // info: { attended: boolean, memo: string, link: string }
                if (info.attended) {
                    this.data.attendedLives[liveId] = {
                        memo: info.memo || '',
                        link: info.link || '',
                        timestamp: Date.now()
                    };
                } else {
                    delete this.data.attendedLives[liveId];
                }
                this.save();
            },

            // --------------------------------------------------
            // Cloud Sync Logic
            // --------------------------------------------------
            generateSyncId: async function() {
                if(!confirm('æ–°ã—ã„ã€ŒLLDB IDã€ã‚’ç™ºè¡Œã—ã¾ã™ã‹ï¼Ÿ\n(ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ä¸Šæ›¸ãã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™)')) return;
                
                try {
                    // GASã§ç¢ºå®Ÿã«å—ã‘å–ã‚Œã‚‹ã‚ˆã† form-urlencoded ã§é€ä¿¡
                    const params = new URLSearchParams();
                    params.append('action', 'generate_sync_id');

                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: params
                    });
                    const json = await res.json();
                    if (json.status === 'success') {
                        this.data.settings.syncId = json.syncId;
                        this.save();
                        this.updateUI();
                        // å³åº§ã«ç©ºãƒ‡ãƒ¼ã‚¿ã§ã‚‚ä¿å­˜ã—ã¦ãŠã
                        this.syncToCloud(true); 
                        alert(`ç™ºè¡Œã—ã¾ã—ãŸï¼\nLLDB ID: ${json.syncId}\n\nã“ã®IDã‚’å¿…ãšæ§ãˆã¦ãã ã•ã„ã€‚`);
                    } else {
                        throw new Error(json.message || 'Error');
                    }
                } catch(e) {
                    console.error(e);
                    alert('é€šä¿¡ã‚¨ãƒ©ãƒ¼: IDç™ºè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            },

            setSyncIdManual: async function() { // asyncã‚’è¿½åŠ 
                const input = document.getElementById('manual-sync-id');
                const val = input.value.trim();
                if (!val) return;
                if (!confirm(`LLDB IDã€Œ${val}ã€ã‚’è¨­å®šã—ã¾ã™ã‹ã€‚\n\nâ€»OKã‚’æŠ¼ã—ãŸå¾Œã€æ•°ç§’ãŠå¾…ã¡ãã ã•ã„ã€‚\nã€€ãƒ‡ãƒ¼ã‚¿ã‚’ã“ã®ç«¯æœ«ã«å¾©å…ƒã—ã¾ã™ã€‚`)) return;
            
                this.data.settings.syncId = val;
                this.save(true); // ä¸€æ—¦ä¿å­˜(åŒæœŸã¯ã—ãªã„)
                
                // ç›´ã¡ã«å¾©å…ƒã‚’å®Ÿè¡Œ
                const success = await this.loadFromCloud(true); // true=silent mode (new)
                if (success) {
                    alert('è¨­å®šã—ã¾ã—ãŸã€‚');
                }
            },

            syncToCloud: async function(silent = false) {
                if (!this.data.settings.syncId) return;
                if (!silent && !confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ')) return;

                try {
                    // åœ§ç¸®ã•ã‚ŒãŸæ–‡å­—åˆ—ã‚’ãã®ã¾ã¾é€ã‚‹
                    const compressed = LZString.compressToUTF16(JSON.stringify(this.data));
                    
                    const params = new URLSearchParams();
                    params.append('action', 'save_user_data');
                    params.append('syncId', this.data.settings.syncId);
                    params.append('data', compressed);

                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: params
                    });
                    const json = await res.json();
                    if (json.status === 'success') {
                    this.data.settings.lastSync = new Date().toLocaleString();
                    this.save(true); // LastSyncæ›´æ–°ã®ãŸã‚(å†åŒæœŸã¯ã—ãªã„)
                    this.updateUI();
                    if(!silent) alert('ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸï¼');
                    } else {
                        throw new Error(json.message);
                    }
                } catch(e) {
                    if(!silent) alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
                }
            },

            loadFromCloud: async function(silent = false) {
                if (!this.data.settings.syncId) return false;
                if (!silent && !confirm('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã‹ï¼Ÿ\nâ€»ç¾åœ¨ã®ç«¯æœ«ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚')) return false;
            
                try {
                    const params = new URLSearchParams();
                    params.append('action', 'load_user_data');
                    params.append('syncId', this.data.settings.syncId);
            
                    const res = await fetch(GAS_API_URL, {
                        method: 'POST',
                        body: params
                    });
                    const json = await res.json();
            
                    if (json.status === 'success' && json.data) {
                        const decompressed = LZString.decompressFromUTF16(json.data);
                        const loadedData = JSON.parse(decompressed);
            
                        this.data = loadedData;
                        this.save(true); // ãƒ­ãƒ¼ã‚«ãƒ«ã«åæ˜ (å†åŒæœŸã¯ã—ãªã„)
                        this.updateUI();
                        this.broadcastData();
                        if(!silent) alert('å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸï¼');
                        return true;
                    } else {
                        alert('ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚IDã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                        return false;
                    }
                        } catch(e) {
                alert('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e);
            }
        },
        
        // â˜…è¿½åŠ : ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼ˆãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ï¼‰æ©Ÿèƒ½
        logout: function() {
            if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ\nâ€»å‚æˆ¦ãƒ¡ãƒ¢ãªã©ã¯ä¸€åº¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\nã€€å†åº¦åŒã˜IDã‚’è¨­å®šã—ãŸã‚‰å†åº¦è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚')) return;
        
            // ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸçŠ¶æ…‹ã«ãƒªã‚»ãƒƒãƒˆ
            this.data = {
                version: 1,
                profile: { birthday: '' },
                attendedLives: {},
                settings: { syncId: null, lastSync: null }
            };
        
            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ä¿å­˜
            this.save();
            
            // ç”»é¢ã¨å­ç”»é¢ã‚’æ›´æ–°
            this.updateUI();
            this.broadcastData();
        
            alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚');
        },
        
        // --------------------------------------------------
        // File Backup / Restore
        // --------------------------------------------------
            backupToFile: function() {
                const blob = new Blob([JSON.stringify(this.data, null, 2)], {type: "application/json"});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lldb_backup_${new Date().toISOString().slice(0,10)}.json`;
                a.click();
                URL.revokeObjectURL(url);
            },

            restoreFromFile: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const loaded = JSON.parse(e.target.result);
                        if (!confirm('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) return;
                        
                        this.data = loaded;
                        this.save();
                        this.updateUI();
                        this.broadcastData();
                        alert('å¾©å…ƒã—ã¾ã—ãŸï¼');
                    } catch(err) {
                        alert('ä¸æ­£ãªãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™');
                    }
                };
                reader.readAsText(file);
                // Reset input
                input.value = '';
            },

            // --------------------------------------------------
            // CSV Export (Exit Strategy)
            // --------------------------------------------------
            exportCSV: async function() {
                if (Object.keys(this.data.attendedLives).length === 0) {
                    alert('å‚æˆ¦è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                    return;
                }

                if(!confirm('å‚æˆ¦è¨˜éŒ²ã‚’CSVã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ\n(å…¬æ¼”ã‚¿ã‚¤ãƒˆãƒ«æƒ…å ±ã‚’å–å¾—ã™ã‚‹ãŸã‚å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)')) return;

                try {
                    // å…¬æ¼”åãªã©ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ç°¡æ˜“ãƒªã‚¹ãƒˆã‚’å–å¾—
                    const res = await fetch(`${GAS_API_URL}?action=getLiveBasicData`);
                    const json = await res.json();
                    
                    // ID -> Title Mapä½œæˆ
                    const liveMap = {};
                    if(json.data) {
                        json.data.forEach(t => {
                            // APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ã«åˆã‚ã›ã¦èª¿æ•´ (liveRecords: json.liveRecords ã¾ãŸã¯ json.data)
                            // getLiveBasicDataã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¯ {status, liveRecords, version}
                            const records = json.liveRecords || json.data;
                            if(records) {
                                records.forEach(l => {
                                    // l: {date, tourName, venue...}
                                    // IDã¯ date ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹
                                    liveMap[l.date] = { title: l.tourName, date: l.date, venue: l.venue };
                                });
                            }
                        });
                    }
                    
                    // ä¿®æ­£: getLiveBasicDataã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹é€ ãŒãƒ•ãƒ©ãƒƒãƒˆãªé…åˆ—ã®å ´åˆã®å¯¾å¿œ
                    if (json.liveRecords) {
                        json.liveRecords.forEach(l => {
                            liveMap[l.date] = { title: l.tourName, date: l.date, venue: l.venue };
                        });
                    }

                    // CSVç”Ÿæˆ
                    let csvContent = "\uFEFF"; // BOM
                    csvContent += "æ—¥ä»˜,ãƒ„ã‚¢ãƒ¼,ä¼šå ´,ãƒ¡ãƒ¢,ãƒªãƒ³ã‚¯\n";

                    const attendedIds = Object.keys(this.data.attendedLives).sort();
                    
                    attendedIds.forEach(id => {
                        const rec = this.data.attendedLives[id];
                        const info = liveMap[id] || { title: 'Unknown Live', date: id, venue: '-' };
                        
                        // CSVã‚¨ã‚¹ã‚±ãƒ¼ãƒ—å‡¦ç†
                        const escape = (txt) => `"${(txt || '').replace(/"/g, '""')}"`;
                        
                        const row = [
                            escape(info.date),
                            escape(info.title),
                            escape(info.venue),
                            escape(rec.memo),
                            escape(rec.link)
                        ];
                        csvContent += row.join(",") + "\n";
                    });

                    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `lldb_attended_list.csv`;
                    a.click();
                    URL.revokeObjectURL(url);

                } catch(e) {
                    console.error(e);
                    alert('CSVä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡ç’°å¢ƒã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
                }
            },

            // UIæ›´æ–°
            updateUI: function() {
                const syncId = this.data.settings.syncId;
                const setupArea = document.getElementById('sync-setup-area');
                const activeArea = document.getElementById('sync-active-area');
                const idDisplay = document.getElementById('current-sync-id');
                const lastSyncDisplay = document.getElementById('last-sync-time');

                if (syncId) {
                    setupArea.classList.add('hidden');
                    activeArea.classList.remove('hidden');
                    idDisplay.textContent = syncId;
                    lastSyncDisplay.textContent = this.data.settings.lastSync 
                        ? `æœ€çµ‚ä¿å­˜: ${this.data.settings.lastSync}` 
                        : 'æœªåŒæœŸ';
                } else {
                    setupArea.classList.remove('hidden');
                    activeArea.classList.add('hidden');
                }
            }
        };

        // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openMyLLDBModal() {
      toggleNoren(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é–‰ã˜ã‚‹
      const modal = document.getElementById('mylldb-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex'); // for flexbox centering
      setTimeout(() => modal.classList.remove('opacity-0'), 10);

      UserDataManager.init(); // å¿µã®ç‚ºUIæœ€æ–°åŒ–

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’å–å¾—ã—ã¦è¡¨ç¤º
      fetch(`${GAS_API_URL}?action=getUserCount`)
        .then(res => res.json())
        .then(json => {
          if(json.status === 'success' && json.count) {
            const el = document.getElementById('active-user-count');
            if(el) el.textContent = `(${json.count}äººãŒåˆ©ç”¨ä¸­)`;
          }
        })
        .catch(e => console.error(e));
    }

        function closeMyLLDBModal() {
            const modal = document.getElementById('mylldb-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        }

        // åˆæœŸåŒ–å®Ÿè¡Œ (DOM Loadæ™‚)
        document.addEventListener('DOMContentLoaded', () => {
            UserDataManager.init();
            
            // å­ãƒ•ãƒ¬ãƒ¼ãƒ ã‹ã‚‰ã®æ›´æ–°è¦æ±‚ã‚’å—ã‘å–ã‚‹
            window.addEventListener('message', (event) => {
                if (event.data.type === 'updateUserLiveRecord') {
                    // { id, attended, memo, link }
                    UserDataManager.updateAttendedLive(
                        event.data.id, 
                        event.data
                    );
                }
                // â˜…è¿½åŠ : èª•ç”Ÿæ—¥æ›´æ–°ã®å—ã‘å–ã‚Š
                else if (event.data.type === 'updateUserBirth') {
                UserDataManager.data.profile.birthday = event.data.birthday;
                UserDataManager.save();
                console.log('Birthday updated via History App:', event.data.birthday);
                }
                // â˜…è¿½åŠ : Liveã‚¢ãƒ—ãƒªã‹ã‚‰ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èµ·å‹•è¦æ±‚
                else if (event.data.type === 'openMyLLDB') {
                openMyLLDBModal();
                }
                });
        });

        // ã‚¢ãƒ—ãƒªåˆ‡ã‚Šæ›¿ãˆ
        function switchApp(appName) {
            document.querySelectorAll('.app-screen').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('app-' + appName);
            if(target) target.classList.add('active');

            // ãƒ˜ãƒƒãƒ€ãƒ¼æ›´æ–°
            const header = document.getElementById('main-app-header');
            const title = document.getElementById('header-title');
            if(apps[appName]) {
                // Tailwindã®JITã‚«ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹(bg-[#...])ã‚’å‹•çš„ã«é©ç”¨ã™ã‚‹ãŸã‚ã€styleå±æ€§ã§ã¯ãªãclassNameã‚’æ›´æ–°
                header.className = `${apps[appName].color} text-white transition-colors duration-300 flex items-center justify-between px-4 fixed top-0 z-30 shadow-sm w-full h-[60px]`;
                
                // ã‚¿ã‚¤ãƒˆãƒ«ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’æ›´æ–°ã—ã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¡¨ç¤ºç”¨ã®spanã¯æ¶ˆã•ãªã„ã‚ˆã†ã«ã™ã‚‹
                const titleText = document.getElementById('header-title-text');
                if (titleText) titleText.textContent = apps[appName].title;

                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·ã¯ã€ŒLiveã€ã‚¢ãƒ—ãƒªã®æ™‚ã ã‘è¡¨ç¤ºã—ã€ä»–ã§ã¯éš ã™
                const versionEl = document.getElementById('display-version');
                if (versionEl) versionEl.style.display = (appName === 'live') ? 'inline' : 'none';
            }

            // æš–ç°¾ã‚’é–‰ã˜ã‚‹
            const menu = document.getElementById('noren-menu');
            if(menu.classList.contains('open')) toggleNoren();
            
            lucide.createIcons();
            
            // GA4: ä»®æƒ³ãƒšãƒ¼ã‚¸ãƒ“ãƒ¥ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆé€ä¿¡
            if (typeof gtag === 'function') {
                gtag('event', 'screen_view', {
                    'screen_name': apps[appName].title,
                    'app_name': 'LLDB'
                });
            }
        }

        // å…±é€šUIåˆ¶å¾¡ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
        function toggleNoren() {
            const menu = document.getElementById('noren-menu');
            const overlay = document.getElementById('noren-overlay');
            const flower = document.querySelector('.flower-icon');

            if(menu.classList.contains('open')) {
                // Close
                menu.classList.remove('open'); 
                overlay.classList.remove('open');
                flower.classList.remove('rotate'); // å›è»¢ãƒªã‚»ãƒƒãƒˆ
                setTimeout(() => { 
                    menu.style.visibility='hidden'; 
                    overlay.style.display='none'; 
                }, 400); // transitionæ™‚é–“ã¨åˆã‚ã›ã‚‹
            } else {
                // Open
                menu.style.visibility='visible'; 
                overlay.style.display='block';
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚¯ãƒ©ã‚¹ä»˜ä¸ã§ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç™ºç«
                setTimeout(() => { 
                    menu.classList.add('open'); 
                    overlay.classList.add('open');
                    flower.classList.add('rotate'); // å›è»¢ï¼
                }, 10);
            }
        }

        function openAboutModal() {
            toggleNoren();
            setTimeout(() => {
                const modal = document.getElementById('about-modal');
                modal.classList.add('open');
            }, 300);
        }

        function closeAboutModal() {
            const modal = document.getElementById('about-modal');
            modal.classList.remove('open');
        }

        let isUpdateHistoryLoaded = false; // èª­ã¿è¾¼ã¿å®Œäº†ãƒ•ãƒ©ã‚°

        async function loadUpdateHistory() {
            // ã™ã§ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„
            if (isUpdateHistoryLoaded) return;

            const container = document.getElementById('update-history-content');
            
            try {
                console.log("Start loading update history in background...");
                // APIã¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
                const response = await fetch(`${GAS_API_URL}?action=getUpdateHistory`);
                const json = await response.json();

                // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆB2ã‚»ãƒ«ï¼‰ã‚’çœŸã£å…ˆã«åæ˜ ï¼ˆå±¥æ­´ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšï¼‰
                if (json.version_all) {
                    const versionElement = document.getElementById('display-version');
                    if (versionElement) {
                        versionElement.textContent = 'vol.' + json.version_all;
                    }
                }

                if (json.status === 'success' && json.data && json.data.length > 0) {
                    // HTMLã‚’ç”Ÿæˆ
                    let html = '<div class="flex flex-col gap-3">';
                    json.data.forEach(item => {
                        html += `
                            <div class="border-b border-gray-100 pb-2 last:border-0">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-mono text-gray-400">${item.date}</span>
                                    <span class="text-[10px] font-bold bg-gray-100 text-gray-600 px-1.5 py-0.5 rounded">${item.version}</span>
                                </div>
                                <p class="text-xs text-gray-600 leading-relaxed">${item.content}</p>
                            </div>
                        `;
                    });
                    html += '</div>';
                    
                    if (container) {
                        container.innerHTML = html;
                        isUpdateHistoryLoaded = true;
                    }
                } else {
                    if (container) container.innerHTML = '<p class="text-center text-gray-400 text-xs py-4">æ›´æ–°å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</p>';
                }
            } catch (e) {
                console.error("Update history load failed:", e);
                if (container) container.innerHTML = '<p class="text-center text-red-400 text-xs py-4">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>';
            }
        }

        // ã‚»ãƒˆãƒªæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã¸ã®é·ç§»å‡¦ç†
        function openSetlistForm() {
            if (confirm('ã‚»ãƒˆãƒªæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ ã«ç§»å‹•ã—ã¾ã™ã‹ï¼Ÿ')) {
                toggleNoren();
                window.location.href = 'https://nokidochibi.github.io/LLDB_SetoriForm/';
            }
        }

        // å¼·åˆ¶å†èµ·å‹•æ©Ÿèƒ½
        function forceReloadApp() {
          if (!confirm('ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆè¡¨ç¤ºãŒãŠã‹ã—ã„æ™‚ãªã©ã«ãŠä½¿ã„ãã ã•ã„ï¼‰')) return;
          toggleNoren();
          localStorage.clear();
          setTimeout(() => {
            window.location.reload();
          }, 300);
        }

        // Configæ›´æ–°ãƒã‚§ãƒƒã‚¯
        async function checkRemoteConfig() {
            try {
                console.log("Checking remote config...");
                const response = await fetch(`${GAS_API_URL}?action=getAppVersions`);
                const json = await response.json();
                
                const localVersions = JSON.parse(localStorage.getItem('lldb_data_versions') || '{}');
                let hasUpdate = false;
                
                Object.keys(json).forEach(appName => {
                    const remoteId = json[appName];
                    const appKey = APP_ID_MAP[appName];
                    if (!appKey) return;

                    const localId = localVersions[appKey];
                    if (localId !== remoteId) {
                        console.log(`Update found for ${appName}: ${localId} -> ${remoteId}`);
                        localVersions[appKey] = remoteId;
                        hasUpdate = true;
                        const iframe = document.querySelector(`#app-${appKey} iframe`);
                        if (iframe && iframe.contentWindow) {
                            iframe.contentWindow.postMessage({
                                type: 'forceUpdateData',
                                newVersion: remoteId
                            }, '*');
                        }
                    }
                });

                if (hasUpdate) {
                    localStorage.setItem('lldb_data_versions', JSON.stringify(localVersions));
                }
            } catch (e) {
                console.error("Config check failed:", e);
            }
        }

        // --- DOMContentLoaded ---
        document.addEventListener('DOMContentLoaded', () => {
            // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãƒã‚§ãƒƒã‚¯
            const savedVer = localStorage.getItem('lldb_version');
            if (savedVer !== APP_VERSION) {
                localStorage.clear();
                localStorage.setItem('lldb_version', APP_VERSION);
                console.log(`Version updated to ${APP_VERSION}. Cache cleared.`);
            }

            // 2. Iframeã®URLã‚’è¨­å®šã—ã¦èª­ã¿è¾¼ã¿ã‚’é–‹å§‹ã•ã›ã‚‹ï¼ˆå„ªå…ˆåº¦â‘ ï¼šãƒ©ã‚¤ãƒ–æƒ…å ±å–å¾—ã®é–‹å§‹ï¼‰
            document.querySelectorAll('iframe').forEach(iframe => {
                const currentSrc = iframe.getAttribute('src');
                if (currentSrc) {
                    const separator = currentSrc.includes('?') ? '&' : '?';
                    iframe.setAttribute('src', `${currentSrc}${separator}v=${APP_VERSION}`);
                }
            });

            // 3. ã‚¢ãƒ—ãƒªã®åˆæœŸç”»é¢ã‚’è¡¨ç¤ºã™ã‚‹ï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼‰
            const hash = window.location.hash;
            if (hash === '#song') { switchApp('songHelper'); } 
            else if (hash === '#trends') { switchApp('trends'); } 
            else if (hash === '#history') { switchApp('history'); } 
            else { switchApp('live'); }

            // 4. ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã‚’é–‹å§‹ï¼ˆå„ªå…ˆåº¦â‘¡ï¼šã‚¹ãƒ—ã‚·ã®4.6å–å¾—ãªã©ï¼‰
            loadUpdateHistory();
            checkRemoteConfig();
            
            const aboutVerEl = document.getElementById('about-version-display');
            if(aboutVerEl) aboutVerEl.textContent = aboutVersion;

            lucide.createIcons();

            const header = document.getElementById('main-app-header');
            if(header) {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('#header-menu-btn')) return;

                    const activeScreen = document.querySelector('.app-screen.active');
                    if (!activeScreen) return;

                    activeScreen.scrollTo({ top: 0, behavior: 'smooth' });
                    const iframe = activeScreen.querySelector('iframe');
                    if (iframe && iframe.contentWindow) {
                        try {
                            const doc = iframe.contentDocument || iframe.contentWindow.document;
                            iframe.contentWindow.scrollTo({ top: 0, behavior: 'smooth' });
                            doc.body.scrollTo({ top: 0, behavior: 'smooth' });
                            doc.documentElement.scrollTo({ top: 0, behavior: 'smooth' });
                            
                            const mobileFrame = doc.querySelector('.mobile-frame');
                            if (mobileFrame) mobileFrame.scrollTo({ top: 0, behavior: 'smooth' });
                            
                            const chatContainers = doc.querySelectorAll('main[id^="chat-container-"]');
                            chatContainers.forEach(el => {
                                if (!el.classList.contains('hidden')) {
                                    el.scrollTo({ top: 0, behavior: 'smooth' });
                                }
                            });
                        } catch(err) {}
                    }
                });
            }
        });

        // å­iframeã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å¾…ã¡å—ã‘
        window.addEventListener('message', (event) => {
            if (event.data.type === 'requestLiveSearch') {
                switchApp('live'); 
                const liveIframe = document.querySelector('#app-live iframe');
                if (liveIframe && liveIframe.contentWindow) {
                    setTimeout(() => {
                        liveIframe.contentWindow.postMessage({
                            type: 'execLiveSearch',
                            tourName: event.data.tourName
                        }, '*');
                    }, 100);
                }
            }
        });
    </script>
</body>
</html>
