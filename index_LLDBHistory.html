<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LLDB History</title>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      // iframeå†…ã§ã®é‡è¤‡è¨ˆæ¸¬ã‚’é˜²ããŸã‚ã€è‡ªå‹•PVé€ä¿¡ã¯OFFã«ã—ã€å¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®ã¿æ‰‹å‹•ã§é€ã‚‹è¨­å®š
      gtag('config', 'G-0D09G3X4F1', { 'send_page_view': false });
    </script>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           Base & Theme Colors (Teal Theme)
           ========================================= */
        :root {
            --bg-color: #F8F9FA;
            --accent-color: #2A9D8F;
            --accent-light: #e0f2f1;
            --accent-dark: #1F7A6F;
            --text-main: #334155;
            --nav-height: 85px;        
            --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ã®é«˜ã•åˆ†ã‚’ç¢ºä¿ */
            padding-bottom: calc(var(--nav-height) + 20px + env(safe-area-inset-bottom));
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .card-base {
            background-color: white;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            padding: 20px;
            margin-bottom: 16px;
            border: 1px solid rgba(0,0,0,0.03);
        }

        /* ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ */
        select {
            font-size: 15px !important;
            padding: 12px 14px !important;
            border-radius: 12px !important;
            border: 1px solid #cbd5e1 !important;
            background-color: #fff !important;
            width: 100%;
            color: var(--text-main);
            font-weight: bold;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }

        /* å¹´è¡¨ãƒ†ãƒ¼ãƒ–ãƒ« */
        .history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
        .history-table th {
            position: sticky;
            top: 0;
            background-color: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            color: var(--text-main);
            border-bottom: 2px solid var(--accent-light);
            font-size: 11px;
            font-weight: 700;
            padding: 12px 2px;
            z-index: 20;
            white-space: nowrap;
            text-align: center;
        }
        .history-table th:first-child { border-top-left-radius: 12px; }
        .history-table th:last-child { border-top-right-radius: 12px; }

        .history-table td {
            padding: 10px 4px;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
            font-size: 11px;
            height: 44px;
            word-wrap: break-word;
            background-color: white;
        }
        .history-table tr:last-child td:first-child { border-bottom-left-radius: 12px; }
        .history-table tr:last-child td:last-child { border-bottom-right-radius: 12px; }
        .history-table tr:nth-child(even) td { background-color: #fcfcfc; } 
        
        .lifestage-text { font-size: 10px; color: #64748b; font-weight: bold; text-align: center; display: block; }
        .lifestage-highlight { background-color: var(--accent-light); border-radius: 4px; padding: 2px 4px; color: var(--accent-color); }

        .event-chip { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-bottom: 3px; line-height: 1.3; border: 1px solid transparent; max-width: 100%; }
        .chip-live { background-color: #fef2f2; color: #ef4444; border-color: #fecaca; }
        .chip-single { background-color: #f0f9ff; color: #0284c7; border-color: #bae6fd; }
        .chip-album { background-color: #fefce8; color: #854d0e; border-color: #fef08a; }

        /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
        nav {
            position: fixed !important;
            bottom: 0; left: 0; right: 0;
            display: flex !important;
            border-top: 1px solid #e5e7eb;
            z-index: 50; width: 100%;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.02);
        }
        nav > div { display: flex; width: 100%; height: 100%; }

        .tab-item {
            flex: 1; display: flex; flex-direction: column;
            align-items: center; justify-content: flex-start;
            padding-top: 12px; gap: 4px;
            color: #94a3b8; cursor: pointer; transition: all 0.2s;
            background-color: transparent; height: 100%;
        }
        .tab-item.active { color: var(--accent-color); }
        .tab-item.active svg { stroke-width: 2.5px; }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ä»Šæ—¥ã®è‡ªåˆ†ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .cd-jacket {
            aspect-ratio: 1/1;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background-color: #f1f5f9;
            width: 100%;
            pointer-events: none;        /* ç”»åƒã¸ã®ã‚¿ãƒƒãƒãƒ»ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šã‚’ç„¡åŠ¹åŒ–ï¼ˆã“ã‚ŒãŒä¸€ç•ªåŠ¹ãã¾ã™ï¼‰ */
            -webkit-touch-callout: none; /* iOS Safariã§é•·æŠ¼ã—ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ç„¡åŠ¹åŒ– */
            user-select: none;           /* ç”»åƒã‚’é¸æŠã§ããªã„ã‚ˆã†ã«ã™ã‚‹ */
            -webkit-user-drag: none;     /* ç”»åƒã®ãƒ‰ãƒ©ãƒƒã‚°ã‚’ç¦æ­¢ */
        }
        
        /* ---------------------------------------------------------
           â˜…NEW: ãƒãƒƒãƒ—ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰æ©Ÿèƒ½ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«è¿½åŠ  (å†ä¿®æ­£ç‰ˆ)
           --------------------------------------------------------- */
        :root {
            /* æ—¢å­˜å¤‰æ•°ã«è¿½åŠ  */
            --cell-gap: 2px;
            --border-album: #FF69B4; /* aiko Pink */
            --border-single: #F97316; /* Orange-500 */
            --border-other: #94A3B8; /* Slate-400 */
        }

        /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸå…¨ä½“ */
        .grid-scroll-area {
            overflow: auto;
            max-height: 70vh; /* é«˜ã•åˆ¶é™ */
            position: relative;
            overscroll-behavior: contain;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-x pan-y pinch-zoom; /* ãƒ”ãƒ³ãƒã‚ºãƒ¼ãƒ è¨±å¯ */
        }

        /* ã‚°ãƒªãƒƒãƒ‰æœ¬ä½“ */
        .disco-grid {
            display: grid;
            /* å¹´åˆ—(36px) + 12ãƒ¶æœˆåˆ† (æœ€å°40px, æ‹¡å¤§æ™‚ã¯ç”»é¢ã«åˆã‚ã›ã¦ä¼¸ç¸®) */
            grid-template-columns: 36px repeat(12, minmax(40px, 1fr));
            gap: var(--cell-gap);
            
            /* é‡è¦: å¹…ã®è¨­å®š */
            width: 100%; 
            min-width: 100%; /* ã“ã‚Œã§ã€Œãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç”»é¢ã„ã£ã±ã„ã€ã‚’å®Ÿç¾ */
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ (æœˆ) ã®å›ºå®š */
        .header-row {
            position: sticky; 
            top: 0; 
            z-index: 40;
            background-color: rgba(248, 249, 250, 0.98);
            backdrop-filter: blur(4px);
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 4px; padding-top: 2px;
            margin-bottom: 0;
            
            /* ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’è¦ªã«åˆã‚ã›ã‚‹ */
            display: grid;
            grid-template-columns: 36px repeat(12, minmax(40px, 1fr));
            gap: var(--cell-gap);
        }
        
        /* å·¦ä¸Šäº¤ç‚¹ã®å›ºå®š */
        .header-corner {
            position: sticky;
            left: 0;
            z-index: 50;
            background-color: rgba(248, 249, 250, 0.98);
        }

        .header-cell { 
            text-align: center; font-size: 9px; font-weight: bold; color: #94a3b8; 
            height: 32px; display: flex; flex-direction: column; justify-content: flex-end; padding-bottom: 2px;
        }

        /* ç¸¦è»¸ (å¹´) ã®å›ºå®š */
        .year-cell {
            position: sticky;
            left: 0;
            z-index: 30;
            background-color: rgba(248, 249, 250, 0.95);
            border-right: 1px solid #f1f5f9;
            
            font-size: 10px; font-weight: 900; color: #cbd5e1;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            line-height: 1;
        }

        /* æ¡ˆå†…æ–‡ */
        .zoom-hint {
            text-align: center; font-size: 10px; color: #94a3b8; margin-top: 8px; padding-bottom: 4px;
        }

        .birth-cake { font-size: 10px; margin-bottom: -2px; display: block; animation: bounce 2s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-2px); } }

        .year-label { display: block; }
        .age-label { 
            font-size: 8px; color: var(--accent-color); margin-top: 1px; 
            font-weight: bold; opacity: 0.8; white-space: nowrap; transform: scale(0.9);
        }

        .jacket-cell {
            aspect-ratio: 1 / 1; background-color: #e2e8f0; border-radius: 3px;
            position: relative; overflow: hidden; transition: transform 0.1s;
        }
        .jacket-cell:active { transform: scale(0.9); }
        
        .jacket-img-base {
            width: 100%; height: 100%; object-fit: cover; display: block;
            box-sizing: border-box;
        }

        /* æ ç·šã‚¹ã‚¿ã‚¤ãƒ« */
        .border-album { border: 2px solid var(--border-album); }
        .border-single { border: 2px solid var(--border-single); }
        .border-other { border: 2px solid var(--border-other); }

        /* é‡ã­åˆã‚ã›ã‚¹ã‚¿ã‚¤ãƒ« */
        .stacked-1 {
            position: absolute; top: 2px; left: 2px; /* å°‘ã—å†…å´ã«é…ç½® */
            width: 60%; height: 60%; z-index: 1;     /* ã‚µã‚¤ã‚ºã‚’ç¸®å° */
            border-radius: 2px;
        }
        .stacked-2 {
            position: absolute; bottom: 2px; right: 2px; /* å°‘ã—å†…å´ã«é…ç½® */
            width: 60%; height: 60%; z-index: 2;         /* ã‚µã‚¤ã‚ºã‚’ç¸®å° */
            border-radius: 2px;
            box-shadow: -1px -1px 2px rgba(0,0,0,0.2);
        }

        /* å­£ç¯€ã®èƒŒæ™¯è‰² */
        .season-winter { background-color: #eff6ff; }
        .season-spring { background-color: #fff1f2; }
        .season-summer { background-color: #ecfeff; }
        .season-autumn { background-color: #fff7ed; }

        /* å­£ç¯€ã®çµµæ–‡å­—ï¼ˆé€ã‹ã—ï¼‰ */
        .empty-cell {
            border-radius: 2px; display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .empty-cell::after {
            font-size: 14px; opacity: 0.15; pointer-events: none; filter: grayscale(30%);
        }
        .empty-cell.season-winter::after { content: 'â„ï¸'; }
        .empty-cell.season-spring::after { content: 'ğŸŒ¸'; }
        .empty-cell.season-summer::after { content: 'ğŸŒ»'; }
        .empty-cell.season-autumn::after { content: 'ğŸ'; }

        .future-cell { border: 1px dashed rgba(0,0,0,0.05); }
        .birth-month-header { color: var(--accent-color); font-weight: 900; }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«æ‹¡å¼µ */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100;
            display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px);
            opacity: 0; transition: opacity 0.2s; padding: 16px;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal-card-expanded {
            background: white; width: 100%; max-width: 360px; border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(0.95); transition: transform 0.2s;
            max-height: 85vh; overflow-y: auto; overflow-x: hidden;
        }
        .modal-overlay.open .modal-card-expanded { transform: scale(1); }

        /* ---------------------------------------------------------
           â˜…NEW: ãƒ©ã‚¤ãƒ–ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆè©³ç´°ç‰ˆï¼‰
           --------------------------------------------------------- */
        .live-text-cell {
            width: 100%; height: 100%;
            display: flex; 
            flex-direction: column; /* è¤‡æ•°ã‚ã‚‹å ´åˆã¯ç¸¦ã«ç©ã‚€ */
            overflow: hidden;
            border-radius: 2px;
        }
        .live-text-item {
            flex: 1; /* å‡ç­‰ã«é«˜ã•ã‚’åˆ†å‰² */
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            
            font-size: 6px; /* æŒ‡å®š: 6px */
            line-height: 1.0; /* è¡Œé–“ã‚’è©°ã‚ã‚‹ */
            text-align: center;
            font-weight: 900;
            
            white-space: normal; /* æŒ‡å®š: æŠ˜ã‚Šè¿”ã—æœ‰åŠ¹ */
            word-break: break-all; /* å˜èªã®é€”ä¸­ã§ã‚‚æŠ˜ã‚Šè¿”ã™ */
            overflow: hidden;
            padding: 0 1px;
            border: 0.5px solid transparent; /* å¢ƒç•Œç·šç”¨ */
        }

        /* ãƒ„ã‚¢ãƒ¼ã‚¿ã‚¤ãƒ—åˆ¥ã®é…è‰² (Liveã‚¢ãƒ—ãƒªã®ãŸã™ãè‰²ã«æº–æ‹ ) */
        /* Pop: èµ¤ (#E63946) */
        .live-pop { 
            background-color: #fff1f2; color: #E63946; border-color: #fecaca; 
        }
        /* Rock: é’ (#00BFFF) */
        .live-rock { 
            background-color: #f0f9ff; color: #00BFFF; border-color: #bae6fd; 
        }
        /* Aloha: é»„ (#FFD700) â€»è¦–èªæ€§ã®ãŸã‚æ–‡å­—ã¯å°‘ã—æš—ãã€èƒŒæ™¯ã‚’é»„è‰²ã« */
        .live-aloha { 
            background-color: #fefce8; color: #d97706; border-color: #fef08a; 
        }
        /* Event/Other: ç° (#9CA3AF) */
        .live-other { 
            background-color: #f8fafc; color: #9CA3AF; border-color: #e2e8f0; 
        }
    </style>
</head>
<body>

    <main class="w-full max-w-lg mx-auto">
        
        <!-- å…¥åŠ›ã‚¨ãƒªã‚¢ -->
        <div id="input-area" class="card-base m-4 bg-white">
            <div class="flex items-end gap-3">
                <div class="flex-1">
                    <label class="block text-xs font-bold text-gray-400 mb-1.5 ml-1">ç”Ÿå¹´æœˆæ—¥ã‚’é¸æŠã—ã¦ã­</label>
                    <div class="flex gap-2">
                        <select id="year" class="flex-[3]"></select>
                        <select id="month" class="flex-[2]"></select>
                        <select id="day" class="flex-[2]"></select>
                    </div>
                </div>
                <button onclick="generateHistory()" class="bg-[#2A9D8F] hover:bg-[#1F7A6F] text-white font-bold p-3.5 rounded-xl shadow-md transition-transform active:scale-95 flex-shrink-0">
                    <i data-lucide="check" class="w-6 h-6"></i>
                </button>
            </div>
        </div>

        <div id="content-area" class="hidden fade-in px-2">
            
            <!-- å¹´è¡¨ã‚¿ãƒ– (å¤‰æ›´ãªã—) -->
            <div id="view-history" class="hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th style="width: 12%;">å¹´æœˆ</th>
                                <th style="width: 8%;">å¹´é½¢</th>
                                <th style="width: 15%;">ãƒ©ã‚¤ãƒ•<br>ã‚¹ãƒ†ãƒ¼ã‚¸</th>
                                <th style="width: 35%;">LIVE</th>
                                <th style="width: 30%;">CD</th>
                            </tr>
                        </thead>
                        <tbody id="timeline-body"></tbody>
                    </table>
                </div>
                <div class="h-8"></div>
            </div>

            <!-- â˜…NEW: ãƒãƒƒãƒ—ï¼ˆã‚°ãƒªãƒƒãƒ‰ï¼‰ã‚¿ãƒ– -->
            <div id="view-map" class="hidden">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 pb-2 pt-1 overflow-hidden">
                    <!-- ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸãƒ©ãƒƒãƒ‘ãƒ¼ -->
                    <div class="grid-scroll-area">
                        <!-- ãƒ”ãƒ³ãƒã‚¤ãƒ³ãƒ»ã‚¢ã‚¦ãƒˆå¯¾è±¡ã®ã‚³ãƒ³ãƒ†ãƒŠ -->
                        <div id="grid-container" class="disco-grid">
                            <!-- JSã§ç”Ÿæˆ -->
                        </div>
                    </div>
                    <!-- æ¡ˆå†…æ–‡ -->
                    <p class="zoom-hint">â€»ï¼’æœ¬æŒ‡ã§æ‹¡å¤§/ç¸®å°ã§ãã‚‹ã‚ˆ</p>
                </div>
            </div>
            
            <!-- ä»Šæ—¥ã®è‡ªåˆ†ã‚¿ãƒ– -->
            <div id="view-today" class="hidden p-2">
                
                <!-- 1. ä»Šæ—¥ã®ã‚ãªãŸã®æ—¥æ•° -->
                <div class="bg-white rounded-2xl shadow-sm p-6 mb-6 border border-gray-100 text-center relative overflow-hidden">
                    <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2">ä»Šæ—¥ã®ã‚ãªãŸ</h3>
                    <div class="flex items-baseline justify-center gap-1">
                        <!-- ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’èª¿æ•´ (text-5xl -> text-3xl) -->
                        <span id="user-days" class="text-2xl sm:text-3xl font-black text-[#2A9D8F] tracking-tight">0</span>
                    </div>
                </div>

                <!-- 2. ã¤ãªãã®ãƒ†ã‚­ã‚¹ãƒˆ -->
                <div class="text-center mb-6">
                    <div class="inline-block bg-gray-100 text-gray-600 text-xs font-bold px-4 py-2 rounded-full shadow-inner border border-gray-200">
                        ãã®ã“ã‚ aikoãŒãƒªãƒªãƒ¼ã‚¹ã—ãŸCDã¯...
                    </div>
                    <div class="h-4 w-0.5 bg-gray-200 mx-auto mt-1"></div>
                </div>

                <!-- 3. CDæƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
                <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden relative">
                    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼éƒ¨åˆ† -->
                    <div class="bg-[#2A9D8F] p-4 text-white text-center">
                         <div class="inline-block bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold mb-1 backdrop-blur-sm border border-white/30">
                             <span id="match-cd-type">TYPE</span>
                         </div>
                         <h2 id="match-cd-title" class="text-lg font-bold leading-tight">Title Loading...</h2>
                    </div>

                    <div class="p-5">
                        <!-- ã‚¸ãƒ£ã‚±ãƒƒãƒˆç”»åƒã‚¨ãƒªã‚¢ (IDä»˜ä¸ãƒ»æ§‹é€ å¤‰æ›´) -->
                        <div id="today-jacket-container" class="flex gap-4 mb-6 justify-center items-center">
                            <div id="today-wrapper-first" class="flex-1 relative group w-full hidden">
                                <img id="match-img-first" src="" class="cd-jacket" alt="åˆå›ç›¤" onerror="this.src='https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image'">
                            </div>
                            <div id="today-wrapper-regular" class="flex-1 relative group w-full hidden">
                                <img id="match-img-regular" src="" class="cd-jacket" alt="é€šå¸¸ç›¤" onerror="this.src='https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image'">
                            </div>
                            <!-- ä¸¡æ–¹ãªã„å ´åˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ç”¨ -->
                            <div id="today-wrapper-none" class="flex-1 relative group w-full hidden max-w-[60%]">
                                <img src="https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image" class="cd-jacket" alt="No Image">
                            </div>
                        </div>

                        <!-- åéŒ²æ›² -->
                        <div class="mb-6">
                            <h4 class="text-xs font-bold text-gray-400 border-b border-gray-100 pb-1 mb-2 flex items-center gap-1">
                                <i data-lucide="music" class="w-3 h-3"></i> åéŒ²æ›²
                            </h4>
                            <div id="match-tracks" class="text-sm text-gray-600 leading-relaxed font-medium bg-gray-50 p-4 rounded-xl border border-dashed border-gray-200">
                                <!-- Tracks will be inserted here -->
                            </div>
                        </div>

                        <!-- ãƒªãƒªãƒ¼ã‚¹æ—¥ãƒ»aikoå¹´é½¢ -->
                        <div class="bg-[#e0f2f1] rounded-xl p-4 flex flex-col gap-2 text-xs">
                            <div class="flex justify-between items-center border-b border-[#2A9D8F]/10 pb-2">
                                <div class="text-[#1F7A6F] font-bold opacity-70">ãƒªãƒªãƒ¼ã‚¹æ—¥</div>
                                <div id="match-release-date" class="font-bold text-gray-700">----/--/--</div>
                            </div>
                            <div class="flex justify-between items-center pt-1">
                                <div class="text-[#1F7A6F] font-bold opacity-70">å½“æ™‚ã®aiko</div>
                                <div id="match-aiko-days" class="font-bold text-[#2A9D8F] text-right">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="h-8"></div>
            </div>
        </div>

        <div id="loading" class="hidden text-center py-20">
            <div class="animate-spin text-[#2A9D8F] mb-3 mx-auto w-10 h-10"><i data-lucide="loader-2" class="w-10 h-10"></i></div>
            <p class="text-sm text-gray-400 animate-pulse">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...<br>
                ãã‚Œã¾ã§æ°—é•·ã«å¾…ã¤ã¨ã—ã‚ˆã†ã‹
            </p>
        </div>
    </main>

    <nav>
        <div>
            <div onclick="switchTab('history')" class="tab-item active" data-tab="history">
                <i data-lucide="scroll" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">å¹´è¡¨</span>
            </div>
            <!-- è¿½åŠ ã“ã“ã‹ã‚‰ -->
            <div onclick="switchTab('map')" class="tab-item" data-tab="map">
                <i data-lucide="grid" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒãƒƒãƒ—</span>
            </div>
            <!-- è¿½åŠ ã“ã“ã¾ã§ -->
            <div onclick="switchTab('today')" class="tab-item" data-tab="today">
                <i data-lucide="user" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ä»Šæ—¥ã®è‡ªåˆ†</span>
            </div>
        </div>
    </nav>
    <!-- â˜…NEW: ã‚°ãƒªãƒƒãƒ‰è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="detail-modal" class="modal-overlay" onclick="closeModal()">
        <div class="modal-card-expanded" onclick="event.stopPropagation()">
            <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ (å¹´æœˆ) -->
            <div class="bg-[#2A9D8F] p-4 text-white text-center sticky top-0 z-10 shadow-sm">
                 <h2 id="modal-header-date" class="text-xl font-black leading-tight tracking-widest font-mono">YYYY.MM</h2>
            </div>

            <div class="p-5">
                <!-- CDæƒ…å ±ãƒªã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒŠ -->
                <div id="modal-cd-list" class="space-y-12">
                    <!-- JSã§å‹•çš„ç”Ÿæˆ -->
                </div>

                <!-- å…±é€šæƒ…å ±ï¼ˆè‡ªåˆ†ãƒ»ãƒ©ã‚¤ãƒ–ï¼‰ -->
                <div id="modal-common-info" class="space-y-4 pt-8 mt-8 border-t-2 border-dashed border-gray-100">
                     <!-- ã‚ãªãŸã®æƒ…å ± -->
                    <div class="space-y-2">
                        <h4 class="text-xs font-bold text-gray-400 flex items-center gap-1 border-b border-gray-100 pb-1">
                            <i data-lucide="user" class="w-3 h-3"></i> å½“æ™‚ã®ã‚ãªãŸ
                        </h4>
                        <div class="bg-gray-50 rounded-xl p-3 text-xs flex justify-between items-center border border-gray-100">
                            <div class="font-bold text-gray-500">å¹´é½¢: <span id="modal-user-age" class="text-gray-800 text-sm ml-1"></span></div>
                            <div class="font-bold text-[#2A9D8F] bg-white px-3 py-1 rounded-full shadow-sm border border-gray-100" id="modal-user-stage"></div>
                        </div>
                    </div>

                    <!-- ãƒ©ã‚¤ãƒ–æƒ…å ± -->
                    <div id="modal-live-section" class="space-y-2 hidden">
                        <h4 class="text-xs font-bold text-gray-400 flex items-center gap-1 border-b border-gray-100 pb-1">
                            <i data-lucide="mic-2" class="w-3 h-3 text-red-400"></i> ã“ã®æœˆã®LIVE
                        </h4>
                        <div id="modal-live-list" class="space-y-2"></div>
                    </div>
                </div>
                
                <div class="pt-6">
                     <button onclick="closeModal()" class="w-full py-3 text-sm font-bold text-gray-500 hover:bg-gray-50 rounded-xl border border-gray-200">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
        const AIKO_BIRTH = new Date(1975, 10, 22); // 1975/11/22
        const CACHE_KEY = 'lldb_data_history_v7_1_fix';

        let allData = null;
        let birthDate = null;
        let loadingPromise = null; // â˜…è¿½åŠ 

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            populateDates();
            
            // â˜…è¿½åŠ : å³æ™‚èª­ã¿è¾¼ã¿é–‹å§‹
            startDataLoading();
            
            const savedBirth = localStorage.getItem('lldb_user_birth');
            if (savedBirth) {
                const [y, m, d] = savedBirth.split('-');
                document.getElementById('year').value = y;
                document.getElementById('month').value = parseInt(m);
                document.getElementById('day').value = parseInt(d);
            }
        });

        // â˜…è¿½åŠ : ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
        function startDataLoading() {
            loadingPromise = new Promise(async (resolve) => {
                // ã™ã§ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å³çµ‚äº†
                if (allData) {
                    resolve(allData);
                    return;
                }

                // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèª
                try {
                    const cache = localStorage.getItem(CACHE_KEY);
                    if (cache) {
                        allData = JSON.parse(cache);
                        resolve(allData);
                        return;
                    }
                } catch (e) { console.error("Cache Error", e); }

                // 2. APIãƒ•ã‚§ãƒƒãƒ
                try {
                    const res = await fetch(`${GAS_API_URL}?action=getHistoryData`);
                    const json = await res.json();
                    allData = json;
                    try { localStorage.setItem(CACHE_KEY, JSON.stringify(json)); } catch(e){}
                    resolve(allData);
                } catch (e) {
                    console.error(e);
                    resolve(null); // ã‚¨ãƒ©ãƒ¼æ™‚ã¯null
                }
            });
        }

        function populateDates() {
            const yEl = document.getElementById('year'), mEl = document.getElementById('month'), dEl = document.getElementById('day');
            const currentYear = new Date().getFullYear();
            for (let i = currentYear; i >= 1950; i--) yEl.add(new Option(i, i, false, i === 1998));
            for (let i = 1; i <= 12; i++) mEl.add(new Option(i, i, false, i === 7));
            for (let i = 1; i <= 31; i++) dEl.add(new Option(i, i, false, i === 17));
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-item').forEach(el => {
                el.classList.toggle('active', el.dataset.tab === tabName);
            });
            document.getElementById('view-history').classList.toggle('hidden', tabName !== 'history');
            document.getElementById('view-map').classList.toggle('hidden', tabName !== 'map');
            document.getElementById('view-today').classList.toggle('hidden', tabName !== 'today');
            
            if (tabName === 'today') {
                if (allData && birthDate) renderTodayStats();
                safeTrackEvent('screen_view', { screen_name: 'History_TodayMe' });
            } 
            else if (tabName === 'map') {
                if (allData && birthDate) renderGrid(allData.listData);
                safeTrackEvent('screen_view', { screen_name: 'History_Map' });
            }
            lucide.createIcons();
        }

        async function generateHistory() {
            const y = document.getElementById('year').value;
            const m = document.getElementById('month').value;
            const d = document.getElementById('day').value;
            birthDate = new Date(y, m - 1, d);
            localStorage.setItem('lldb_user_birth', `${y}-${m}-${d}`);

            // GA4 Tracking
            safeTrackEvent('generate_lead', {
                item_category: 'history_timeline'
            });

            document.getElementById('loading').classList.remove('hidden');
            document.getElementById('content-area').classList.add('hidden');

            // â˜…ä¿®æ­£: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾…ã¡ãƒ­ã‚¸ãƒƒã‚¯
            if (!allData) {
                // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰èª­ã¿è¾¼ã¿ã®å®Œäº†ã‚’å¾…ã¤
                await loadingPromise;
                
                if (!allData) {
                    alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    document.getElementById('loading').classList.add('hidden');
                    return;
                }
            }

            renderTimeline();
            renderGrid(allData.listData);
            renderTodayStats(); 
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content-area').classList.remove('hidden');
            
            const currentTabEl = document.querySelector('.tab-item.active');
            const targetTab = currentTabEl ? currentTabEl.dataset.tab : 'history';
            switchTab(targetTab);
        }

        function requestSearchInLive(tourName) {
          window.parent.postMessage({
            type: 'requestLiveSearch',
            tourName: tourName
          }, '*');
        }

        function calculateDetailedAge(birthDate, targetDate) {
            let b = new Date(birthDate);
            let t = new Date(targetDate);
            b.setHours(0,0,0,0);
            t.setHours(0,0,0,0);

            let years = t.getFullYear() - b.getFullYear();
            let months = t.getMonth() - b.getMonth();
            let days = t.getDate() - b.getDate();

            if (days < 0) {
                months--;
                const prevMonthLastDay = new Date(t.getFullYear(), t.getMonth(), 0).getDate();
                days += prevMonthLastDay;
            }
            if (months < 0) {
                years--;
                months += 12;
            }
            
            const msPerDay = 1000 * 60 * 60 * 24;
            const totalDays = Math.floor((t - b) / msPerDay);

            return `${years}æ­³${months}ã‚«æœˆ${days}æ—¥<br><span class="text-sm font-normal text-gray-400">ï¼ˆ${totalDays.toLocaleString()}æ—¥ï¼‰</span>`;
        }

        function getLifeStage(targetDate, birth) {
            const getSchoolCohort = (d) => {
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                return (m <= 3 || (m === 4 && d.getDate() === 1)) ? y - 1 : y;
            };
            const getFiscalYear = (d) => {
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                return (m <= 3) ? y - 1 : y;
            }
            const birthYearCohort = getSchoolCohort(birth);
            const targetYearFiscal = getFiscalYear(targetDate);
            const grade = targetYearFiscal - birthYearCohort;
            
            if (grade < 7) return 'æœªå°±å­¦';
            if (grade === 7) return 'å°å­¦1å¹´';
            if (grade === 8) return 'å°å­¦2å¹´';
            if (grade === 9) return 'å°å­¦3å¹´';
            if (grade === 10) return 'å°å­¦4å¹´';
            if (grade === 11) return 'å°å­¦5å¹´';
            if (grade === 12) return 'å°å­¦6å¹´';
            if (grade === 13) return 'ä¸­å­¦1å¹´';
            if (grade === 14) return 'ä¸­å­¦2å¹´';
            if (grade === 15) return 'ä¸­å­¦3å¹´';
            if (grade === 16) return 'é«˜æ ¡1å¹´';
            if (grade === 17) return 'é«˜æ ¡2å¹´';
            if (grade === 18) return 'é«˜æ ¡3å¹´';
            if (grade === 19) return 'å¤§å­¦1å¹´';
            if (grade === 20) return 'å¤§å­¦2å¹´';
            if (grade === 21) return 'å¤§å­¦3å¹´';
            if (grade === 22) return 'å¤§å­¦4å¹´';
            if (grade > 22) return 'ç«‹æ´¾ãªå¤§äºº';
            return '';
        }

        function renderTimeline() {
            const tbody = document.getElementById('timeline-body');
            tbody.innerHTML = '';
            const startYear = birthDate.getFullYear();
            const startMonth = birthDate.getMonth();
            const now = new Date();
            const endYear = now.getFullYear();
            const endMonth = now.getMonth();
            const eventsMap = {}; 
            
            if (allData.historyData && Array.isArray(allData.historyData)) {
                allData.historyData.forEach(row => {
                    if (!row.date) return;
                    const d = new Date(row.date);
                    const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                    if (!eventsMap[key]) eventsMap[key] = { lives: new Set(), singles: [], albums: [] };
                    if (row.live) eventsMap[key].lives.add(row.live);
                    if (row.single) eventsMap[key].singles.push(row.single);
                    if (row.album) eventsMap[key].albums.push(row.album);
                });
            }

            let current = new Date(startYear, startMonth, 1);
            const end = new Date(endYear, endMonth, 1);
            let prevYear = -1;

            while (current <= end) {
                const y = current.getFullYear();
                const m = current.getMonth() + 1;
                const key = `${y}-${m}`;
                let age = y - birthDate.getFullYear();
                if (m < (birthDate.getMonth() + 1)) age--;
                const stageText = getLifeStage(current, birthDate);
                const isHighlight = (m === 4 && (stageText.includes('1å¹´') || stageText === 'ç«‹æ´¾ãªå¤§äºº'));
                const stageHtml = `<span class="lifestage-text ${isHighlight ? 'lifestage-highlight' : ''}">${stageText}</span>`;
                let liveHtml = '';
                let cdHtml = '';
                
                if (eventsMap[key]) {
                    eventsMap[key].lives.forEach(liveName => { 
                          const safeName = liveName.replace(/'/g, "\\'");
                          liveHtml += `<div class="event-chip chip-live cursor-pointer active:scale-95 transition-transform" onclick="requestSearchInLive('${safeName}')">${liveName}</div>`; 
                        });
                    eventsMap[key].singles.forEach(s => { cdHtml += `<div class="event-chip chip-single">S: ${s}</div>`; });
                    eventsMap[key].albums.forEach(a => { cdHtml += `<div class="event-chip chip-album">Al: ${a}</div>`; });
                }

                const yearDisplay = (y !== prevYear) ? `<span class="text-xs font-bold block text-gray-500">${y}</span>` : '';
                prevYear = y;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center text-gray-400 font-mono border-r border-gray-100">
                        ${yearDisplay}
                        <span class="text-[10px] text-gray-300">${m}æœˆ</span>
                    </td>
                    <td class="text-center font-bold text-[#2A9D8F] border-r border-gray-100">${age >= 0 ? age : ''}</td>
                    <td class="text-center border-r border-gray-100">${stageHtml}</td>
                    <td class="pl-1">${liveHtml}</td>
                    <td class="pl-1">${cdHtml}</td>
                `;
                tbody.appendChild(tr);
                current.setMonth(current.getMonth() + 1);
            }
        }

        function renderTodayStats() {
            if (!birthDate || !allData.listData) return;

            const today = new Date();
            const ageString = calculateDetailedAge(birthDate, today);
            
            document.getElementById('user-days').innerHTML = ageString;

            let bestMatch = null;
            let minDiff = Infinity;
            
            const msPerDay = 1000 * 60 * 60 * 24;
            const userBirthClean = new Date(birthDate); userBirthClean.setHours(0,0,0,0);
            const todayClean = new Date(today); todayClean.setHours(0,0,0,0);
            const userDays = Math.floor((todayClean - userBirthClean) / msPerDay);

            allData.listData.forEach(cd => {
                if (!cd.releaseDate) return;
                const releaseDate = new Date(cd.releaseDate);
                releaseDate.setHours(0,0,0,0);
                
                const aikoDaysAtRelease = Math.floor((releaseDate - AIKO_BIRTH) / msPerDay);
                
                const diff = Math.abs(userDays - aikoDaysAtRelease);
                
                if (diff < minDiff) {
                    minDiff = diff;
                    bestMatch = {
                        ...cd,
                        releaseDateObj: releaseDate,
                        formattedRelease: `${releaseDate.getFullYear()}/${releaseDate.getMonth() + 1}/${releaseDate.getDate()}`
                    };
                }
            });

            if (bestMatch) {
                document.getElementById('match-cd-title').innerText = bestMatch.title || 'Unknown Title';
                document.getElementById('match-cd-type').innerText = bestMatch.type || 'CD';
                
                // --- ç”»åƒè¡¨ç¤ºåˆ¶å¾¡ãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ) ---
                const img1Url = bestMatch.img1;
                const img2Url = bestMatch.img2;
                
                const elFirst = document.getElementById('match-img-first');
                const elRegular = document.getElementById('match-img-regular');
                const wrapFirst = document.getElementById('today-wrapper-first');
                const wrapRegular = document.getElementById('today-wrapper-regular');
                const wrapNone = document.getElementById('today-wrapper-none');

                // ä¸€æ—¦ãƒªã‚»ãƒƒãƒˆ
                wrapFirst.classList.add('hidden');
                wrapRegular.classList.add('hidden');
                wrapNone.classList.add('hidden');
                wrapFirst.classList.remove('max-w-[60%]');
                wrapRegular.classList.remove('max-w-[60%]');

                if (img1Url || img2Url) {
                    // ã©ã¡ã‚‰ã‹ã€ã‚ã‚‹ã„ã¯ä¸¡æ–¹ã‚ã‚‹å ´åˆ
                    if (img1Url) {
                        elFirst.src = img1Url;
                        wrapFirst.classList.remove('hidden');
                    }
                    if (img2Url) {
                        elRegular.src = img2Url;
                        wrapRegular.classList.remove('hidden');
                    }

                    // ç‰‡æ–¹ã—ã‹ãªã„å ´åˆã¯ä¸­å¤®å¯„ã›ï¼†ã‚µã‚¤ã‚ºèª¿æ•´
                    if (!img1Url || !img2Url) {
                        if (img1Url) wrapFirst.classList.add('max-w-[60%]');
                        if (img2Url) wrapRegular.classList.add('max-w-[60%]');
                    }
                } else {
                    // ä¸¡æ–¹ãªã„å ´åˆ
                    wrapNone.classList.remove('hidden');
                }
                // ---------------------------------------

                let tracksHtml = '';
                if (bestMatch.tracks) {
                    const tracks = String(bestMatch.tracks).split(/[\n]/).map(t => t.trim()).filter(t => t);
                    if (tracks.length > 0) {
                        tracksHtml = '<div class="flex flex-col gap-1">';
                        tracks.forEach(t => {
                            tracksHtml += `<div class="text-gray-700 leading-normal">${t}</div>`;
                        });
                        tracksHtml += '</div>';
                    } else {
                        tracksHtml = `<div class="text-gray-700 leading-normal">${bestMatch.tracks}</div>`;
                    }
                } else {
                    tracksHtml = '<span class="text-gray-400">æƒ…å ±ãªã—</span>';
                }
                document.getElementById('match-tracks').innerHTML = tracksHtml;

                document.getElementById('match-release-date').innerText = bestMatch.formattedRelease;
                
                const aikoAgeString = calculateDetailedAge(AIKO_BIRTH, bestMatch.releaseDateObj);
                document.getElementById('match-aiko-days').innerHTML = aikoAgeString;
            }
        }

        // renderGridé–¢æ•°ã®é‡è¤‡å®šç¾©ã‚’è§£æ¶ˆ
        function renderGrid(listData) {
            const container = document.getElementById('grid-container');
            if(!listData) return;

            // 1. CDãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ—ä½œæˆ
            const releaseMap = {};
            listData.forEach(item => {
                if(!item.releaseDate) return;
                const d = new Date(item.releaseDate);
                const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                if (!releaseMap[key]) releaseMap[key] = [];
                releaseMap[key].push(item);
            });

            Object.keys(releaseMap).forEach(key => {
                releaseMap[key].sort((a, b) => new Date(a.releaseDate) - new Date(b.releaseDate));
            });

            // 2. ãƒ©ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ—ä½œæˆ
            const liveMap = {};
            if (allData && allData.historyData) {
                allData.historyData.forEach(row => {
                    if (!row.date || !row.live) return;
                    const d = new Date(row.date);
                    const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
                    if (!liveMap[key]) liveMap[key] = [];
                    if (!liveMap[key].includes(row.live)) {
                        liveMap[key].push(row.live);
                    }
                });
            }

            const startYear = 1998;
            const currentYear = new Date().getFullYear();
            const endYear = currentYear; 
            const birthMonth = birthDate.getMonth() + 1; // ã“ã“ã§å®šç¾©ã‚’ä½¿ç”¨

            let html = '';
            
            // --- ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ç”Ÿæˆ ---
            html += `<div class="header-row col-span-full">`;
            html += `<div class="header-corner"></div>`; // å·¦ä¸Šå›ºå®šç”¨
            for (let m = 1; m <= 12; m++) {
                const isBirthMonth = (m === birthMonth);
                const cakeHtml = isBirthMonth ? '<span class="birth-cake">ğŸ‚</span>' : '';
                html += `<div class="header-cell ${isBirthMonth ? 'birth-month-header' : ''}">${cakeHtml}${m}</div>`;
            }
            html += `</div>`;
            // --------------------------------

            for (let y = startYear; y <= endYear; y++) {
                let ageLabel = '';
                const birthYear = birthDate.getFullYear();
                if (y >= birthYear) {
                    const age = y - birthYear;
                    ageLabel = `<span class="age-label">${age}æ­³</span>`;
                }

                html += `<div class="year-cell"><span class="year-label">${y}</span>${ageLabel}</div>`;

                for (let m = 1; m <= 12; m++) {
                    const key = `${y}-${m}`;
                    const items = releaseMap[key];
                    const lives = liveMap[key];
                    const isFuture = new Date(y, m-1) > new Date();
                    
                    let colClass = '';
                    if (m === 12 || m === 1 || m === 2) colClass = 'season-winter';
                    else if (m >= 3 && m <= 5) colClass = 'season-spring';
                    else if (m >= 6 && m <= 8) colClass = 'season-summer';
                    else if (m >= 9 && m <= 11) colClass = 'season-autumn';

                    if (items && items.length > 0) {
                        const dataJson = JSON.stringify(items).replace(/"/g, '&quot;');
                        let contentHtml = '';
                        if (items.length === 1) {
                            const item = items[0];
                            const imgUrl = item.img2 || item.img1 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Image';
                            const borderClass = getBorderClass(item.type);
                            contentHtml = `<img src="${imgUrl}" loading="lazy" class="jacket-img-base ${borderClass}">`;
                        } else {
                            const first = items[0];
                            const last = items[items.length - 1];
                            const img1 = first.img2 || first.img1 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Image';
                            const img2 = last.img2 || last.img1 || 'https://placehold.co/100x100/e2e8f0/94a3b8?text=No+Image';
                            const border1 = getBorderClass(first.type);
                            const border2 = getBorderClass(last.type);
                            contentHtml = `<img src="${img1}" class="jacket-img-base stacked-1 ${border1}"><img src="${img2}" class="jacket-img-base stacked-2 ${border2}">`;
                        }
                        html += `<div class="jacket-cell cursor-pointer shadow-sm" onclick="openModal(this)" data-items="${dataJson}">${contentHtml}</div>`;
                    } else if (lives && lives.length > 0) {
                        let liveHtml = '';
                        lives.forEach(name => {
                            let shortName = name.replace(/Love Like Pop/i, 'LLP').replace(/Love Like Rock/i, 'LLR').replace(/Love Like Aloha/i, 'LLA').replace(/ vol\./i, '').replace(/è¿½åŠ å…¬æ¼”/g, '').replace(/(\d+)\.\d+/g, '$1');
                            let typeClass = 'live-other';
                            const nLower = name.toLowerCase();
                            if (nLower.includes('love like pop')) typeClass = 'live-pop';
                            else if (nLower.includes('love like rock')) typeClass = 'live-rock';
                            else if (nLower.includes('love like aloha')) typeClass = 'live-aloha';
                            liveHtml += `<span class="live-text-item ${typeClass}">${shortName}</span>`;
                        });
                        const firstLiveName = lives[0].replace(/'/g, "\\'");
                        html += `<div class="live-text-cell cursor-pointer" onclick="requestSearchInLive('${firstLiveName}')">${liveHtml}</div>`;
                    } else {
                        if (isFuture) { html += `<div class="future-cell ${colClass}"></div>`; } 
                        else { html += `<div class="empty-cell ${colClass}"></div>`; }
                    }
                }
            }
            container.innerHTML = html;
        }

        function getBorderClass(type) {
            if (!type) return 'border-other';
            const t = type.toLowerCase();
            if (t.includes('album') || t.includes('ã‚¢ãƒ«ãƒãƒ ')) return 'border-album';
            if (t.includes('single') || t.includes('ã‚·ãƒ³ã‚°ãƒ«')) return 'border-single';
            return 'border-other';
        }

        function openModal(el) {
            const items = JSON.parse(el.dataset.items);
            if (!items || items.length === 0) return;

            const firstDate = new Date(items[0].releaseDate);
            const dateStr = `${firstDate.getFullYear()}.${firstDate.getMonth() + 1}`;
            document.getElementById('modal-header-date').textContent = dateStr;

            const listContainer = document.getElementById('modal-cd-list');
            listContainer.innerHTML = '';

            items.forEach(data => {
                const d = new Date(data.releaseDate);
                const fullDateStr = `${d.getFullYear()}.${d.getMonth() + 1}.${d.getDate()}`;
                const aikoAge = calculateDetailedAge(AIKO_BIRTH, d);
                
                let tracksHtml = '';
                if (data.tracks) {
                    const tracks = String(data.tracks).split(/[\n]/).map(t => t.trim()).filter(t => t);
                    if (tracks.length > 0) {
                        tracksHtml = '<div class="flex flex-col gap-1">';
                        tracks.forEach(t => {
                            tracksHtml += `<div class="text-gray-700 leading-normal">${t}</div>`;
                        });
                        tracksHtml += '</div>';
                    } else {
                        tracksHtml = `<div class="text-gray-700 leading-normal">${data.tracks}</div>`;
                    }
                } else { tracksHtml = '<span class="text-gray-400">æƒ…å ±ãªã—</span>'; }

                // --- ç”»åƒã‚¨ãƒªã‚¢ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ (ä¿®æ­£ç‰ˆ) ---
                let imagesHtml = '';
                const img1 = data.img1;
                const img2 = data.img2;

                if (img1 && img2) {
                    // 2æšã‚ã‚‹å ´åˆ: ä¸¦åˆ—è¡¨ç¤º
                    imagesHtml = `
                        <div class="flex gap-3 mb-5">
                            <div class="flex-1 relative group w-full">
                                <img src="${img1}" class="cd-jacket" alt="åˆå›ç›¤" onerror="this.src='https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image'">
                            </div>
                            <div class="flex-1 relative group w-full">
                                <img src="${img2}" class="cd-jacket" alt="é€šå¸¸ç›¤" onerror="this.src='https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image'">
                            </div>
                        </div>`;
                } else if (img1 || img2) {
                    // 1æšã®ã¿ã®å ´åˆ: ä¸­å¤®å¯„ã›ãƒ»ã‚µã‚¤ã‚ºåˆ¶é™
                    const targetImg = img1 || img2;
                    imagesHtml = `
                        <div class="flex justify-center mb-5">
                            <div class="w-2/3 relative group">
                                <img src="${targetImg}" class="cd-jacket" alt="CD" onerror="this.src='https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image'">
                            </div>
                        </div>`;
                } else {
                    // ä¸¡æ–¹ãªã„å ´åˆ: No Imageã‚’ä¸­å¤®ã«
                    imagesHtml = `
                        <div class="flex justify-center mb-5">
                            <div class="w-2/3 relative group">
                                <img src="https://placehold.co/200x200/e2e8f0/94a3b8?text=No+Image" class="cd-jacket" alt="No Image">
                            </div>
                        </div>`;
                }
                // -------------------------------------

                const cardHtml = `
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="bg-gray-50 px-4 py-3 border-b border-gray-100 flex justify-between items-center">
                            <span class="text-xs font-bold bg-white px-2 py-1 rounded border border-gray-200">${data.type || 'CD'}</span>
                            <span class="text-xs font-mono text-gray-400">${fullDateStr}</span>
                        </div>
                        <div class="p-4">
                            <h3 class="text-lg font-bold text-gray-800 leading-tight mb-4 text-center">${data.title}</h3>
                            
                            ${imagesHtml}

                            <div class="bg-[#e0f2f1]/50 rounded-lg p-3 text-xs flex justify-between items-center mb-4">
                                <span class="font-bold text-[#1F7A6F] opacity-70">å½“æ™‚ã®aiko</span>
                                <span class="font-bold text-[#2A9D8F] text-right">${aikoAge}</span>
                            </div>

                            <div>
                                <h4 class="text-xs font-bold text-gray-400 flex items-center gap-1 border-b border-gray-100 pb-1 mb-2">
                                    <i data-lucide="music" class="w-3 h-3"></i> åéŒ²æ›²
                                </h4>
                                <div class="text-sm text-gray-600 leading-relaxed font-medium bg-gray-50 p-3 rounded-lg border border-dashed border-gray-200">
                                    ${tracksHtml}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', cardHtml);
            });

            const userAge = calculateAgeAtDate(birthDate, firstDate);
            const userStage = getLifeStage(firstDate, birthDate);
            document.getElementById('modal-user-age').textContent = `${userAge}æ­³`;
            document.getElementById('modal-user-stage').textContent = userStage;

            const liveListEl = document.getElementById('modal-live-list');
            const liveSection = document.getElementById('modal-live-section');
            liveListEl.innerHTML = '';
            
            const targetKey = `${firstDate.getFullYear()}-${firstDate.getMonth() + 1}`;
            const addedLives = new Set();
            let liveFound = false;
            
            if (allData && allData.historyData) {
                allData.historyData.forEach(row => {
                    if (!row.date) return;
                    const rd = new Date(row.date);
                    if (`${rd.getFullYear()}-${rd.getMonth() + 1}` === targetKey && row.live) {
                        if (!addedLives.has(row.live)) {
                            addedLives.add(row.live);
                            liveFound = true;
                            const safeName = row.live.replace(/'/g, "\\'");
                            const div = document.createElement('div');
                            div.className = 'p-2 bg-red-50 text-red-600 rounded-lg text-xs font-bold border border-red-100 flex justify-between items-center cursor-pointer active:scale-95 transition-transform';
                            div.innerHTML = `<span>${row.live}</span> <i data-lucide="chevron-right" class="w-3 h-3"></i>`;
                            div.onclick = () => { closeModal(); requestSearchInLive(safeName); };
                            liveListEl.appendChild(div);
                        }
                    }
                });
            }
            
            if (liveFound) {
                liveSection.classList.remove('hidden');
                lucide.createIcons();
            } else {
                liveSection.classList.add('hidden');
            }

            const overlay = document.getElementById('detail-modal');
            overlay.classList.add('open');
            document.querySelector('.modal-card-expanded').scrollTop = 0;
            
            safeTrackEvent('select_content', { content_type: 'map_detail', item_name: items[0].title });
        }

        function closeModal() {
            document.getElementById('detail-modal').classList.remove('open');
        }

        function calculateAgeAtDate(birth, target) {
            let age = target.getFullYear() - birth.getFullYear();
            const m = target.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && target.getDate() < birth.getDate())) age--;
            return age;
        }
        
        function safeTrackEvent(eventName, params) {
            try {
                if (typeof gtag === 'function') {
                    gtag('event', eventName, params);
                }
            } catch (e) {
                console.warn('GA4 Tracking Error:', e);
            }
        }
    </script>
</body>
</html>
