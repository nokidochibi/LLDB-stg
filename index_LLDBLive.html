<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LLDB Live</title>
<meta name="theme-color" content="#ef4444">

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  // iframeå†…ã§ã®é‡è¤‡è¨ˆæ¸¬ã‚’é˜²ããŸã‚ã€è‡ªå‹•PVé€ä¿¡ã¯OFFã«ã—ã€å¿…è¦ãªã‚¤ãƒ™ãƒ³ãƒˆã®ã¿æ‰‹å‹•ã§é€ã‚‹è¨­å®š
  gtag('config', 'G-0D09G3X4F1', { 'send_page_view': false });
</script>

<!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root {
  --aiko-pink: #FF69B4;
  --aiko-red: #E63946; /* ãƒ†ãƒ¼ãƒã‚«ãƒ©ãƒ¼çµ±ä¸€ */
  --aiko-yellow: #FFD700;
  --aiko-blue: #00BFFF;
  --aiko-bg: #F8F9FA;
  --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --nav-height: 85px;
  --accent-light: #fef2f2;
}
* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }

html { height: 100%; } /* htmlã«ã‚‚é«˜ã•ã‚’æŒ‡å®š */

body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
  background-color: var(--aiko-bg);
  color: #334155;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  height: 100%; /* 100vhã‹ã‚‰å¤‰æ›´ã—ã¦è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹ */
  margin: 0;
  touch-action: pan-y pinch-zoom;
  user-select: none;
  -webkit-user-select: none;
  overflow: hidden; /* Bodyè‡ªä½“ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ç¦æ­¢ï¼ˆäºŒé‡ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢ï¼‰ */
}

body.detail-view nav { display: none !important; }

@media screen and (max-device-width: 1024px) and (orientation: landscape) {
  body.landscape nav { display: none !important; }
}

/* mobile-frameã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’ä¸€å…ƒç®¡ç† */
.mobile-frame { 
  width: 100%; 
  max-width: 100%; 
  height: 100%; 
  background-color: #F8F9FA; 
  position: relative; 
  overflow-y: auto; /* scrollã‹ã‚‰autoã«å¤‰æ›´ï¼ˆå¿…è¦ãªæ™‚ã ã‘å‡ºã™ï¼‰ */
  overflow-x: hidden; 
  -webkit-overflow-scrolling: touch; /* iOSã§ã®æ…£æ€§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
  /* ãƒ•ãƒƒã‚¿ãƒ¼ã®é«˜ã• + ä½™ç™½ ã‚’ã“ã“ã«ç§»å‹• */
  padding-bottom: calc(var(--nav-height) + 20px + env(safe-area-inset-bottom));
}

/* â˜…è¿½åŠ : è©³ç´°ç”»é¢ï¼ˆdetail-viewï¼‰ã®æ™‚ã¯ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ¼ãŒæ¶ˆãˆã‚‹ã®ã§ã€ä¸‹ã®ä½™ç™½ã‚’ç‹­ãã™ã‚‹ */
body.detail-view .mobile-frame {
  padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;
}

#confetti-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}

.card-base {
  background-color: white;
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(0,0,0,0.03);
}

nav {
  position: fixed !important;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex !important;
  border-top: 1px solid #e5e7eb;
  z-index: 50;
  width: 100%;
  background-color: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  height: calc(var(--nav-height) + env(safe-area-inset-bottom));
  padding-bottom: env(safe-area-inset-bottom);
  box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.02);
}
nav > div {
  display: flex;
  width: 100%;
  justify-content: space-between;
  height: 100%;
}

.tab-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding-top: 12px;
  gap: 4px;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.2s;
  background-color: transparent;
  height: 100%;
  position: relative;
}

.tab-item.active {
  color: var(--aiko-red);
}
.tab-item.active svg {
  stroke-width: 2.5px;
}

.setlist-item {
  padding: 5px 0;
  margin-bottom: 0;
  background-color: transparent;
  border-bottom: 1px solid #f3f4f6;
  font-size: 15px;
  line-height: 1.5;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 38px;
  border-left: 4px solid transparent; 
  padding-left: 8px;
}
.setlist-item:last-child { border-bottom: none; }

.setlist-medley-title {
  border-left-color: var(--aiko-yellow) !important;
  background-color: #fffbeb !important;
}

.setlist-medley {
  border-left-color: var(--aiko-yellow) !important;
  background-color: transparent !important;
}

.setlist-encore-header {
  margin-top: 16px;
  margin-bottom: 6px;
  font-weight: 800;
  color: var(--aiko-red);
  font-size: 16px;
  padding: 4px 8px;
  background-color: #fef2f2;
  border-left: 4px solid var(--aiko-red);
  border-radius: 0 4px 4px 0;
}

.setlist-encore {
  border-left-color: var(--aiko-red) !important;
  background-color: transparent !important;
}

.setlist-left-content {
  display: flex;
  align-items: baseline;
  width: 60%;
  flex: none;
  padding-right: 8px;
}

.setlist-item-number {
  display: inline-block;
  min-width: 24px;
  flex-shrink: 0;
  font-weight: normal;
  color: #9CA3AF;
  font-size: 12px;
}
.setlist-item-title {
  font-weight: 600;
  color: #334155;
  overflow-wrap: break-word;
}

.timeline-container {
  flex: 1;
  height: 30px;
  display: flex;
  align-items: center;
  position: relative;
  padding-left: 8px;
  cursor: pointer;
}
.timeline-bar {
  width: 100%;
  height: 3px;
  background-color: #e2e8f0;
  border-radius: 2px;
  position: relative;
}
.timeline-dot {
  width: 12px;
  height: 12px;
  border-radius: 50%;
  position: absolute;
  top: 50%;
  transform: translate(-50%, -50%);
  border: 2px solid white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  background-color: var(--aiko-pink);
  z-index: 10;
  transition: transform 0.1s;
}
.year-tooltip {
  position: absolute;
  bottom: 16px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #334155;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 10px;
  font-weight: bold;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 20;
}
.year-tooltip::after {
  content: "";
  position: absolute;
  top: 100%;
  left: 50%;
  margin-left: -4px;
  border-width: 4px;
  border-style: solid;
  border-color: #334155 transparent transparent transparent;
}
.timeline-dot.active {
  transform: translate(-50%, -50%) scale(1.3);
}
.timeline-dot.active .year-tooltip {
  opacity: 1;
}

.history-grid-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  border-top: 1px solid #e5e7eb;
  padding-bottom: 20px;
}
.history-grid-header {
  position: sticky;
  top: 0; 
  background-color: rgba(248, 249, 250, 0.95);
  backdrop-filter: blur(5px);
  z-index: 30;
  border-bottom: 1px solid #e5e7eb;
}

.history-row {
  display: grid;
  grid-template-columns: 48px 1fr 1fr 1fr;
  min-height: 40px;
  border-bottom: 1px dashed #f1f5f9;
  position: relative;
}
.history-row.year-start {
  border-top: 2px solid #cbd5e1;
  margin-top: -1px;
}

.col-date {
  font-size: 10px;
  font-weight: bold;
  color: #94a3b8;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  align-items: center;
  padding-top: 6px;
  background-color: #f8fafc;
  border-right: 1px solid #e2e8f0;
  line-height: 1.2;
}
.col-date .year {
  font-size: 12px;
  color: #475569;
  font-weight: 800;
}

.col-live, .col-single, .col-album {
  position: relative;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 4px 2px;
  overflow: hidden;
}
.col-single, .col-album {
  border-left: 1px dashed #f1f5f9;
}

.history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.history-table th {
  position: sticky;
  top: 0;
  background-color: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  color: #334155;
  border-bottom: 2px solid var(--accent-light);
  font-size: 11px;
  font-weight: 700;
  padding: 12px 2px;
  z-index: 20;
  white-space: nowrap;
  text-align: center;
}
.history-table th:first-child { border-top-left-radius: 12px; }
.history-table th:last-child { border-top-right-radius: 12px; }

.history-table td {
  padding: 10px 4px;
  border-bottom: 1px solid #f1f5f9;
  vertical-align: middle;
  font-size: 11px;
  height: 44px;
  word-wrap: break-word;
  background-color: white;
}
.history-table tr:last-child td:first-child { border-bottom-left-radius: 12px; }
.history-table tr:last-child td:last-child { border-bottom-right-radius: 12px; }
.history-table tr:nth-child(even) td { background-color: #fcfcfc; } 

.lifestage-text { font-size: 10px; color: #64748b; font-weight: bold; text-align: center; display: block; }
.lifestage-highlight { background-color: var(--accent-light); border-radius: 4px; padding: 2px 4px; color: var(--aiko-red); }

.event-chip { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-bottom: 3px; line-height: 1.3; border: 1px solid transparent; max-width: 100%; cursor: pointer; }
.chip-live { background-color: #fef2f2; color: #ef4444; border-color: #fecaca; }
.chip-single { background-color: #f0f9ff; color: #0284c7; border-color: #bae6fd; cursor: default; }
.chip-album { background-color: #fefce8; color: #854d0e; border-color: #fef08a; cursor: default; }

.tap-trigger {
  touch-action: manipulation;
  user-select: none;
  -webkit-user-select: none;
}

main { padding: 12px; }
body.detail-view main { padding-top: 16px; padding-bottom: 32px; }

input, select { 
    font-size: 14px !important;
    padding: 10px 12px !important;
    border-radius: 12px !important; 
    border: 1px solid #cbd5e1 !important; background-color: #fff !important; 
}
button { font-size: 13px !important; }

.clickable-item { cursor: pointer; transition: background-color 0.2s; }
.clickable-item:hover { background-color: #f8fafc; }

.action-btn {
  padding: 8px 12px;
  border-radius: 10px;
  font-size: 12px;
  font-weight: bold;
  cursor: pointer;
  border: none;
  white-space: nowrap;
  flex-shrink: 0;
}

.clear-btn { background-color: #ef4444; color: white; box-shadow: 0 2px 4px rgba(239,68,68,0.3); }
.setlist-btn { background-color: var(--aiko-blue); color: white; box-shadow: 0 2px 4px rgba(0,191,255,0.3); }

.venue-tabs { 
    display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 16px; gap: 0; 
    position: sticky; top: 0px; background: #F8F9FA; z-index: 40; padding-top: 8px;
}
.venue-tab { 
    flex: 1; padding: 10px;
    text-align: center; cursor: pointer; font-weight: bold; font-size: 13px; 
    color: #94a3b8; border-bottom: 2px solid transparent; 
    margin-bottom: -2px; transition: all 0.2s; 
}
.venue-tab.active { color: var(--aiko-red); border-bottom-color: var(--aiko-red); }

.toggle-checkbox {
  position: absolute;
  opacity: 0;
  width: 0;
  height: 0;
}
.toggle-label {
  width: 40px;
  height: 22px;
  background-color: #e2e8f0;
  border-radius: 9999px;
  position: relative;
  cursor: pointer;
  transition: background-color 0.3s;
  display: block;
}
.toggle-label:before {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  background-color: white;
  border-radius: 50%;
  transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
  box-shadow: 0 1px 2px rgba(0,0,0,0.2);
}
.toggle-checkbox:checked + .toggle-label {
  background-color: var(--aiko-red);
}
.toggle-checkbox:checked + .toggle-label:before {
  transform: translateX(18px);
}

.back-button-circle {
  width: 44px; height: 44px;
  border-radius: 50%; background-color: rgba(255, 255, 255, 0.9);
  box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center;
  cursor: pointer; position: fixed; top: 16px; left: 16px; z-index: 1001; backdrop-filter: blur(4px); border: 1px solid #f1f5f9;
}
.back-button-circle svg { width: 22px; height: 22px; stroke: var(--aiko-red); stroke-width: 2.5; }

.modal-overlay { 
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 2000; 
    display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); 
}
.modal-content { 
    background: white; border-radius: 16px; padding: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative;
    box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); 
}
.modal-close { 
    position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; background: #f1f5f9; border-radius: 50%; 
    display: flex; align-items: center; justify-content: center; font-size: 18px; color: #64748b; cursor: pointer; 
}

.rank-number { display: inline-block; min-width: 28px; text-align: right; margin-right: 10px; flex-shrink: 0; font-size: 16px; font-weight: 800; font-style: italic; }
.song-title, .venue-name { flex: 1; word-break: break-word; font-size: 16px; font-weight: 700; line-height: 1.4; }
.song-count { white-space: nowrap; flex-shrink: 0; font-size: 15px; font-weight: bold; color: #64748b; }
.song-count span { font-size: 10px; font-weight: normal; margin-left: 2px; }

.live-card { position: relative; overflow: hidden; padding-bottom: 14px; border: 1px solid rgba(0,0,0,0.03); }
.live-card-label {
  position: absolute;
  top: 16px;
  right: -42px;
  transform: rotate(45deg);
  background-color: var(--aiko-red);
  color: white;
  padding: 3px 0;
  width: 140px;
  text-align: center;
  font-size: 11px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  z-index: 1;
}
.live-card-label.rock { background-color: var(--aiko-blue); }
.live-card-label.aloha { background-color: var(--aiko-yellow); color: #333; }
.live-card-label.other { background-color: #9CA3AF; }

.text-aiko-pink { color: var(--aiko-pink); }
.text-aiko-red { color: var(--aiko-red); }

.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease-out;
  pointer-events: none;
}

.spin-once {
  animation: spin 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.tap-highlight {
    animation: highlight 0.3s ease-out;
}
@keyframes highlight {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); color: var(--aiko-red); }
    100% { transform: scale(1); }
} 

/* Loading Placeholder */
.loading-placeholder {
    animation: pulse-bg 1.5s infinite;
    background-color: #f3f4f6;
    height: 80px;
    border-radius: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center; /* ãƒ†ã‚­ã‚¹ãƒˆè‡ªä½“ã‚’ä¸­å¤®æƒãˆ */
    padding: 0 16px;    /* å·¦å³ã«ä½™ç™½ã‚’æŒãŸã›ã¦çª®å±ˆã•ã‚’é˜²ã */
    color: #cbd5e1;
    font-weight: bold;
    font-size: 14px;
}
@keyframes pulse-bg {
    0% { background-color: #f3f4f6; }
    50% { background-color: #e5e7eb; }
    100% { background-color: #f3f4f6; }
}

/* --- My LLDBç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
.attended-badge {
  display: inline-flex; align-items: center; gap: 4px;
  background-color: #ecfccb; color: #4d7c0f; font-size: 10px; font-weight: bold;
  padding: 2px 8px; border-radius: 99px; border: 1px solid #bef264;
  margin-left: auto;
}
.attendance-toggle-container {
  display: flex; align-items: center; justify-content: space-between;
  background-color: #f0fdf4; border: 1px solid #bbf7d0;
  padding: 12px 16px; border-radius: 12px; margin-bottom: 12px;
}
.attendance-toggle-label { font-weight: bold; color: #166534; font-size: 14px; display: flex; align-items: center; gap: 6px; }
.user-memo-area {
  background-color: #fff; border: 1px dashed #cbd5e1; border-radius: 12px;
  padding: 12px; margin-bottom: 24px; position: relative;
}
.user-memo-area.has-content { background-color: #f8fafc; border-style: solid; }
.memo-placeholder { text-align: center; color: #94a3b8; font-size: 12px; cursor: pointer; padding: 8px; }
.memo-content { font-size: 13px; color: #334155; white-space: pre-wrap; line-height: 1.6; }
.memo-link { display: block; margin-top: 8px; font-size: 12px; color: #3b82f6; text-decoration: none; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
.memo-edit-btn {
  position: absolute; top: 8px; right: 8px;
  background: #f1f5f9; color: #64748b; border-radius: 6px; 
  padding: 4px 8px; font-size: 11px; cursor: pointer; font-weight: bold;
}
.filter-toggle-row { display: flex; align-items: center; justify-content: flex-end; margin-top: 8px; }
.filter-toggle-label { font-size: 11px; font-weight: bold; color: #64748b; margin-right: 8px; }
</style>
</head>
<body>
<!-- ç´™å¹é›ªç”¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
<canvas id="confetti-canvas"></canvas>

<div id="app" class="mobile-frame bg-[#F8F9FA]">

<main id="main-content" style="opacity: 0; transition: opacity 0.5s;">
  <div id="live-detail" style="display:none"></div>

  <!-- å…¬æ¼”ã‚¿ãƒ– -->
  <div id="tab-search" class="tab-content" style="display:block">
    <p class="text-gray-400 mb-1 text-xs text-right font-mono">Data updated: <span id="last-update-date">-</span></p>
    <div class="card-base bg-white border-0">
  <div class="flex gap-2 mb-2 items-center">
    <!-- å·¦å´: æ¤œç´¢çª“ (flex-1 ã§å¹…50%ç¢ºä¿) -->
    <div class="relative flex-1">
        <input type="text" id="search-input" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" class="w-full px-3 py-2 bg-gray-50 border-gray-200 focus:ring-2 focus:ring-red-200 focus:border-red-400 transition">
    </div>
    
    <!-- å³å´: ãƒˆã‚°ãƒ«ã‚»ãƒƒãƒˆ (flex-1 ã§æ®‹ã‚Š50%ç¢ºä¿ã—ã€ä¸­èº«ã‚’æ¨ªä¸¦ã³å³å¯„ã›) -->
    <div class="flex-1 flex items-center justify-end gap-2">
        <div class="flex items-center gap-1 cursor-pointer tap-trigger" onclick="window.parent.postMessage({type: 'openMyLLDB'}, '*')">
        <span class="text-[12px] font-bold text-gray-500">å‚æˆ¦ã—ãŸãƒ©ã‚¤ãƒ–ã®ã¿</span>
        <i data-lucide="info" class="w-3 h-3 text-gray-400"></i>
        </div>
        <div class="relative inline-block align-middle select-none shrink-0">
            <input type="checkbox" id="attended-filter-toggle" class="toggle-checkbox" />
            <label for="attended-filter-toggle" class="toggle-label" style="transform: scale(0.9); display:block;"></label>
        </div>
    </div>
  </div>

  <div class="flex flex-col gap-2 mb-2">
    <select id="tour-select" class="w-full text-gray-700 bg-gray-50 border-gray-200"><option value="">ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–</option><option value="pop">Love Like Pop</option><option value="rock">Love Like Rock</option><option value="aloha">Love Like Aloha</option><option value="other">ãã®ä»–ã®Event</option></select>
    <div class="flex gap-2">
      <select id="year-select" class="flex-1 text-gray-700 bg-gray-50 border-gray-200"><option value="">ã™ã¹ã¦ã®å¹´</option></select>
      <select id="region-select" class="flex-1 text-gray-700 bg-gray-50 border-gray-200"><option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option></select>
    </div>
  </div>

  <div class="flex gap-2 items-center">
    <div class="flex-1">
        <input type="text" id="song-filter-input" placeholder="æ›²åã§çµã‚Šè¾¼ã¿ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰" class="w-full bg-gray-100 text-gray-500 border-dashed" readonly>
    </div>
    <button id="clear-all-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
  </div>
</div>

    <div id="omikuji-trigger-area" class="my-4 py-1 tap-trigger select-none cursor-pointer text-gray-600 hover:text-gray-800 transition-colors bg-white/50 rounded-xl p-3 border border-dashed border-gray-200 text-center">
      <h3 class="font-bold text-base flex items-center justify-center gap-2">
        <span id="omikuji-icon" class="inline-block text-lg">ğŸ«</span>
        <span>
          <span id="display-count-text">è¡¨ç¤ºä¸­ã®å…¬æ¼”æ•°</span>: 
          <span id="display-count" class="text-lg text-aiko-red">0</span> / <span id="total-count">0</span>
        </span>
      </h3>
    </div>

    <div id="live-list-container" class="space-y-3">
        <!-- åˆæœŸãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ -->
        <div class="loading-placeholder">ä»Šæ—¥ã‚‚éƒ½åˆã‚ˆãç”Ÿãã‚‹...</div>
        <div class="loading-placeholder">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        <div class="loading-placeholder">å°‘ã—å¾…ã£ã¦ã¦ã­...</div>
    </div>
  </div>

  <!-- æ¥½æ›²ã‚¿ãƒ– -->
  <div id="tab-song" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-aiko-red"></i> å¹´åˆ¥æ¼”å¥å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="live-count-chart" style="height:220px; max-height:220px"></canvas>
      </div>
    </div>

    <div class="card-base bg-white border-0 mb-4">
      <div class="flex gap-2 mb-3 items-center">
        <div class="relative flex-1">
            <input type="text" id="song-search-input" placeholder="æ¥½æ›²åã§æ¤œç´¢" class="w-full px-3 bg-gray-50 border-gray-200">
        </div>
        <button id="song-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
      <div class="flex justify-between items-center text-lg font-semibold">
        <span class="text-gray-500">å…¨æ¥½æ›²: <span id="total-songs" class="font-bold text-gray-800">-</span> æ›²</span>
        <select id="song-sort" class="text-aiko-red font-bold border-none bg-transparent focus:ring-0" style="padding:0!important; width:auto!important; border:none!important;">
          <option value="count-desc">æ¼”å¥å›æ•° é™é †</option><option value="count-asc">æ¼”å¥å›æ•° æ˜‡é †</option>
        </select>
      </div>
    </div>

    <div class="flex justify-between items-center mt-6 mb-3 px-1">
      <h3 id="song-ranking-header" class="font-bold text-gray-700 text-lg cursor-pointer select-none tap-trigger flex items-center gap-2">
        <span id="song-ranking-icon" class="inline-block">ğŸ¸</span> æ¼”å¥å›æ•°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      </h3>
      <div class="flex items-center gap-2 bg-white px-2 py-1 rounded-full shadow-sm border border-gray-100">
        <span class="text-[10px] font-bold text-gray-500">ãƒ¡ãƒ‰ãƒ¬ãƒ¼<br>è¾¼ã¿</span>
        <div class="relative inline-block align-middle select-none">
            <input type="checkbox" name="toggle" id="medley-toggle" class="toggle-checkbox" checked/>
            <label for="medley-toggle" class="toggle-label"></label>
        </div>
      </div>
    </div>
    
    <div id="song-ranking-container"></div>
  </div>

  <!-- å ´æ‰€ã‚¿ãƒ– -->
  <div id="tab-venue" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="bar-chart" class="w-4 h-4 text-aiko-red"></i> å¹´åˆ¥é–‹å‚¬å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="venue-live-count-chart" style="height:220px; max-height:220px"></canvas>
      </div>
    </div>
    <div class="card-base bg-white border-0 mb-0 rounded-b-none pb-4">
      <div class="flex gap-2 items-center">
        <div class="relative flex-1">
            <input type="text" id="venue-search-input" placeholder="ä¼šå ´ / éƒ½é“åºœçœŒã§æ¤œç´¢" class="w-full px-3 bg-gray-50 border-gray-200">
        </div>
        <button id="venue-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="venue-show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
    </div>
    <div class="venue-tabs mb-3">
      <div class="venue-tab active" data-venue-tab="venue" id="venue-tab-header">ä¼šå ´ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
      <div class="venue-tab" data-venue-tab="region" id="region-tab-header">éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </div>
    <div id="venue-ranking-container" class="mt-2"></div>
    <div id="region-ranking-container" class="mt-2" style="display:none"></div>
  </div>
   
  <!-- å‚¾å‘ã‚¿ãƒ– -->
  <div id="tab-pattern" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="disc" class="w-4 h-4 text-aiko-red"></i> ã‚¢ãƒ«ãƒãƒ åˆ¥æ¼”å¥å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="album-chart" style="height:300px; max-height:300px"></canvas>
      </div>
    </div>

    <div class="mb-5">
        <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="clock" class="w-4 h-4 text-gray-400"></i> æœ€è¿‘æ¼”å¥ã•ã‚Œã¦ã„ãªã„æ›² TOP 10</h3>
        <p class="text-gray-400 mb-2 ml-1 text-xs">â€»éå»ã«1åº¦ã§ã‚‚æ¼”å¥ã•ã‚ŒãŸæ›²ãŒå¯¾è±¡</p>
        <div id="not-played-recently-songs" class="card-base bg-white p-2"></div>
    </div>

    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ¬ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›² TOP 10</h3>
    <div id="opening-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ‘ ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«æ›² TOP 10</h3>
    <div id="encore-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ å¤§ãƒˆãƒªæ›² TOP 10</h3>
    <div id="last-songs" class="card-base bg-white p-2"></div></div>
  </div>

  <!-- è»Œè·¡ã‚¿ãƒ– (Historyã‚¢ãƒ—ãƒªç§»æ¤ãƒ‡ã‚¶ã‚¤ãƒ³) -->
  <div id="tab-history" class="tab-content" style="display:none">
    <div class="mb-3 px-1">
      <h3 class="font-bold text-gray-700 text-base flex items-center gap-2"><i data-lucide="history" class="w-4 h-4 text-aiko-red"></i> LIVE/CDã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³</h3>
    </div>
    
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
      <table class="history-table">
        <thead>
          <tr>
            <th style="width: 15%;">å¹´æœˆ</th>
            <th style="width: 10%;">å¹´é½¢</th>
            <th style="width: 40%;">LIVE</th>
            <th style="width: 35%;">CD</th>
          </tr>
        </thead>
        <tbody id="timeline-body">
          <!-- JSã§è‡ªå‹•ç”Ÿæˆ -->
        </tbody>
      </table>
    </div>
    <div class="text-center mt-6 mb-4 text-gray-400 text-xs tracking-widest">
      <p>ã€œ FUTURE ã€œ</p>
    </div>
  </div>

</main>

<div id="loading-container" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; z-index:9000; display:flex; align-items:center; justify-content:center;">
  <div class="text-center py-20 font-bold select-none overflow-hidden" style="color: white; text-shadow: 0 0 15px white;">
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-1" class="opacity-0">ç”·å­ãƒ¼!!</span> <span id="loading-text-2" class="opacity-0">å¥³å­ãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-3" class="opacity-0">ãã†ã§ãªã„äººãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:56px; line-height:1.2; margin-top:16px;">
      <span id="loading-text-4" class="opacity-0">ãœãƒ¼</span><span id="loading-text-5" class="opacity-0">ã„ã‚“ã£...!!!</span>
    </p>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<div id="memo-modal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeMemoModal()">&times;</span>
    <h3 class="font-bold text-lg mb-4 text-gray-700">ğŸ“ å‚æˆ¦ãƒ¡ãƒ¢</h3>
    <div class="mb-6">
      <label class="block text-xs font-bold text-gray-500 mb-1">ã²ã¨ã“ã¨ãƒ¡ãƒ¢</label>
      <textarea id="memo-textarea" class="w-full p-3 border border-gray-300 rounded-lg text-sm h-40 focus:ring-2 focus:ring-aiko-red focus:border-transparent" placeholder="åº§å¸­ã€èª°ã¨è¡Œã£ãŸã‹ã€noteã‚„Xãªã©ã®ãƒªãƒ³ã‚¯ãªã©..."></textarea>
    </div>
    <div class="flex gap-2">
      <button onclick="saveMemo()" class="flex-1 bg-[#E63946] text-white py-3 rounded-xl font-bold shadow">ä¿å­˜ã™ã‚‹</button>
      <button onclick="deleteMemo()" class="flex-none bg-gray-200 text-gray-600 py-3 px-4 rounded-xl font-bold">å‰Šé™¤</button>
    </div>
  </div>
</div>

<!-- æ–°ãƒ‡ã‚¶ã‚¤ãƒ³ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
<nav>
  <div class="flex w-full">
    <a href="#" class="tab-item active" data-tab="search">
      <i data-lucide="calendar-days" style="width:24px;height:24px"></i>
      <span class="text-[10px] font-bold">å…¬æ¼”</span>
    </a>
    <a href="#" class="tab-item" data-tab="song">
      <i data-lucide="music" style="width:24px;height:24px"></i>
      <span class="text-[10px] font-bold">æ¥½æ›²</span>
    </a>
    <a href="#" class="tab-item" data-tab="venue">
      <i data-lucide="map-pin" style="width:24px;height:24px"></i>
      <span class="text-[10px] font-bold">å ´æ‰€</span>
    </a>
    <a href="#" class="tab-item" data-tab="pattern">
      <i data-lucide="bar-chart-3" style="width:24px;height:24px"></i>
      <span class="text-[10px] font-bold">å‚¾å‘</span>
    </a>
    <a href="#" class="tab-item" data-tab="history">
      <i data-lucide="footprints" style="width:24px;height:24px"></i>
      <span class="text-[10px] font-bold">è»Œè·¡</span>
    </a>
  </div>
</nav>

</div>

<script>
// GASã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
const API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
const CACHE_KEY = 'lldb_data_v4_1_update_history_v6'; // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼å¤‰æ›´
const AIKO_BIRTH = new Date(1975, 10, 22); // 1975/11/22

// â˜…è¿½åŠ : ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ä¿æŒç”¨
let userUserData = { attendedLives: {} };

let appInitializedResolver;
const appInitializedPromise = new Promise(resolve => {
  appInitializedResolver = resolve;
});

let animationFinishedResolver;
const animationFinishedPromise = new Promise(resolve => {
  animationFinishedResolver = resolve;
});

let hasCheckedTodayEvents = false; // â˜…è¿½åŠ : è¨˜å¿µæ—¥ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãƒ•ãƒ©ã‚°

document.addEventListener('DOMContentLoaded', () => {
    // ã‚¢ãƒ—ãƒªã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å®šæ•°ï¼ˆã“ã“ã‚’æ›´æ–°ã™ã‚‹ã ã‘ã§å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ãŒã‹ã‹ã‚Šã¾ã™ï¼‰
    const CURRENT_VERSION = 'v4.4.7'; 
    const VERSION_KEY = 'lldb_installed_version';
    
    // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ç¢ºèª
    const savedVersion = localStorage.getItem(VERSION_KEY);

    // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒé•ã†ï¼ˆå¤ã„ã€ã¾ãŸã¯åˆå›ï¼‰å ´åˆ
    if (savedVersion !== CURRENT_VERSION) {
        console.log(`Version Updated: ${savedVersion} -> ${CURRENT_VERSION}`);
        
        // 1. å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¸€æƒã™ã‚‹
        localStorage.clear();
        
        // 2. æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³æƒ…å ±ã‚’ä¿å­˜ã™ã‚‹
        localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
        
        // â€»ã“ã‚Œã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒç„¡ã„çŠ¶æ…‹ã«ãªã‚‹ãŸã‚ã€ã“ã®ä¸‹ã®å‡¦ç†ã§
        // è‡ªå‹•çš„ã«ã€Œãƒ‡ãƒ¼ã‚¿å–å¾—(é•·ãƒ­ãƒ¼ãƒ‰)ã€ã¸ã¨åˆ†å²ã—ã¾ã™ã€‚
    }
  // ã¾ãšã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹ã‹ç¢ºèª (try-catchã§å®‰å…¨ã«)
  let isCachedLoaded = false;
  try {
    const cachedData = localStorage.getItem(CACHE_KEY);
    if (cachedData) {
      // ãƒ‘ãƒ¼ã‚¹ã—ã¦ã¿ã¦å•é¡Œãªã‘ã‚Œã°ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šã¨åˆ¤å®š
      JSON.parse(cachedData);
      isCachedLoaded = true;
    }
  } catch (e) {
    console.warn("Cache check failed:", e);
  }

  // 1. ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’æœ€å„ªå…ˆã§é–‹å§‹
  // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æœ‰ç„¡ã«é–¢ã‚ã‚‰ãšã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯å¿…ãšã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã‚‹
  // ä¿®æ­£: å¼•æ•°ã‚’ 'fast' ã‹ã‚‰ 'smart' ã«å¤‰æ›´ï¼ˆé–¢æ•°å†…éƒ¨ã®åˆ¤å®šæ–‡å­—åˆ—ã«åˆã‚ã›ã‚‹ï¼‰
  startLoadingAnimation(isCachedLoaded ? 'smart' : 'normal');

  // 2. ãã®ä»–ã®åˆæœŸåŒ–å‡¦ç† (ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ­¢ã¾ã‚‰ãªã„ã‚ˆã†ã«)
  try { if (typeof lucide !== 'undefined') lucide.createIcons(); } catch(e) {}
  try { setupRandomTriggers(); } catch(e) {}

  // 3. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚Œã°ãã‚Œã‚’ä½¿ã„ã€ãªã‘ã‚Œã°fetch)
  loadAllData(isCachedLoaded);

  // 4. ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ã¨åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã£ã¦ç”»é¢ã‚’è¡¨ç¤º
  Promise.all([appInitializedPromise, animationFinishedPromise])
    .then(() => {
      finishLoading();
    })
    .catch(e => {
      console.error("Loading process failed:", e);
      // ä¸‡ãŒä¸€PromiseãŒrejectã•ã‚Œã¦ã‚‚ç”»é¢ã¯å‡ºã™
      finishLoading();
    });
});

let allLiveRecords = [], 
    songStats = {},                   
    songStatsNoMedley = {},         
    patternStats = {}, 
    lastPlayedStats = {}, 
    albumData = [], 
    songData = {}, 
    historyData = [], 
    listData = [], // â˜…è¿½åŠ : CDãªã©ã®ãƒ‡ãƒ¼ã‚¿ã‚’å…¥ã‚Œã‚‹å ´æ‰€
    anniversaryQueue = []; // â˜…ä¿®æ­£: ã‚«ãƒ³ãƒã‚’ã‚»ãƒŸã‚³ãƒ­ãƒ³ã«å¤‰æ›´
let chartInstances = {};

let selectedVenueInfo = null;
let currentDisplayingRecord = null;
let lastScrollPosition = 0; // â˜…è¿½åŠ : ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®è¨˜æ†¶ç”¨

function saveToCache(data) {
  try {
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
  } catch (e) {
    console.warn("Cache save failed:", e);
    if (e.name === 'QuotaExceededError' || e.message.includes('quota')) {
       console.log("Clearing old cache...");
       localStorage.clear(); 
       try {
         localStorage.setItem(CACHE_KEY, JSON.stringify(data));
       } catch (e2) {
         console.error("Retry failed. App will run without cache.", e2);
       }
    }
  }
}

// ä¿®æ­£å¾Œ: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒã‚ã‚‹å ´åˆã¯ãƒ•ã‚§ãƒƒãƒã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦é«˜é€ŸåŒ–
async function loadAllData(useCache = false) {
  // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ãƒ¢ãƒ¼ãƒ‰ãªã‚‰ã€é€šä¿¡ã›ãšã«å³çµ‚äº†ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯DOMContentLoadedå†…ã§æ—¢ã«ã‚»ãƒƒãƒˆæ¸ˆï¼‰
  if (useCache) {
      try {
          const cachedRaw = localStorage.getItem(CACHE_KEY);
          if (cachedRaw) {
              const cachedData = JSON.parse(cachedRaw);
              console.log("Loaded from cache.");
              initializeApp(cachedData);
              return; 
          }
      } catch (e) {
          console.warn("Cache load failed, falling back to fetch", e);
          // å¤±æ•—ã—ãŸã‚‰fetchã¸ç¶™ç¶š
      }
  }

  // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãªã„ã€ã¾ãŸã¯å¼·åˆ¶ãƒªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã®ã¿é€šä¿¡ã™ã‚‹
  try {
    const response = await fetch(`${API_URL}?action=getAllData`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    const data = await response.json();

    if (data.status === 'error') {
        throw new Error(data.message);
    }

    saveToCache(data);
    initializeApp(data);

  } catch (error) {
      handleError(error); 
  }
}

// â–¼â–¼â–¼ å¤‰æ›´ç®‡æ‰€: é–¢æ•°å…¨ä½“ã‚’å·®ã—æ›¿ãˆï¼ˆè¦‹åˆ‡ã‚Šç™ºè»Šãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ ï¼‰ â–¼â–¼â–¼
function startLoadingAnimation(mode) {
  // 'smart' (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Š): 1.2ç§’ç¨‹åº¦ã§å®Œäº†ã™ã‚‹é«˜é€Ÿç‰ˆ
  // 'normal' (ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—): 3.8ç§’ç¨‹åº¦ã®ãƒªã‚ºãƒ é‡è¦–ç‰ˆ
  
  const delays = (mode === 'smart') 
    // Smart: å…¨ä½“ã§1200msç¨‹åº¦
    ? [{ id: 'loading-text-1', delay: 0 }, { id: 'loading-text-2', delay: 200 }, { id: 'loading-text-3', delay: 400 }, { id: 'loading-text-4', delay: 600 }, { id: 'loading-text-5', delay: 800 }]
    // Normal: å…¨ä½“ã§3000msç¨‹åº¦
    : [{ id: 'loading-text-1', delay: 1000 }, { id: 'loading-text-2', delay: 1900 }, { id: 'loading-text-3', delay: 2800 }, { id: 'loading-text-4', delay: 3800 }, { id: 'loading-text-5', delay: 4600 }];
  
  delays.forEach(item => {
    setTimeout(() => {
      const element = document.getElementById(item.id);
      if (element) element.classList.remove('opacity-0');
    }, item.delay);
  });

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†äºˆå®šæ™‚é–“ã«åˆã‚ã›ã¦ç”»é¢ã‚’é–‹æ”¾ï¼ˆè¦‹åˆ‡ã‚Šç™ºè»Šï¼‰
  // ãƒ‡ãƒ¼ã‚¿ãŒæœªåˆ°ç€ã§ã‚‚ã€HTMLå´ã§ç”¨æ„ã—ãŸã€Œæ­Œè©ãƒ•ãƒ¬ãƒ¼ã‚ºã€ãŒè¡¨ç¤ºã•ã‚Œã‚‹
  setTimeout(() => {
    finishLoading();
  }, (mode === 'smart' ? 1200 : 5500));
}

let isLoadingFinished = false; // â˜…è¿½åŠ : é‡è¤‡å®Ÿè¡Œé˜²æ­¢ãƒ•ãƒ©ã‚°

function finishLoading() {
  if (isLoadingFinished) return; // â˜…è¿½åŠ : æ—¢ã«å®Ÿè¡Œæ¸ˆã¿ãªã‚‰ã“ã“ã§ã‚¹ãƒˆãƒƒãƒ—
  isLoadingFinished = true;      // â˜…è¿½åŠ : å®Ÿè¡Œæ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹

  startConfetti();
  const loadingDiv = document.getElementById('loading-container');
  if (loadingDiv) {
      loadingDiv.classList.add('fade-out');
      setTimeout(() => { loadingDiv.style.display = 'none'; }, 500);
  }
  const mainContent = document.getElementById('main-content');
  if (mainContent) {
      mainContent.style.opacity = '1';
  }
  // â˜…è¿½åŠ : ä»Šæ—¥ã¯ä½•ã®æ—¥ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹
  setTimeout(checkTodayEvents, 800);
  
  // åˆæœŸåŒ–å®Œäº†Promiseã‚’è§£æ±º
  if (animationFinishedResolver) animationFinishedResolver();
}

function initializeApp(data) {
  allLiveRecords = data.liveRecords || [];
  albumData = data.albumData || [];
  songData = data.songData || {};
  historyData = data.historyData || []; 
  listData = data.listData || []; // â˜…è¿½åŠ 

  // â˜…ä¿®æ­£: æ›´æ–°å±¥æ­´B2ã‚»ãƒ«(data.lastUpdate)ã®å€¤ã‚’å„ªå…ˆã—ã¦è¡¨ç¤º
  const updateEl = document.getElementById('last-update-date');
  if (updateEl) {
    if (data.lastUpdate) {
        // B2ã‚»ãƒ«ã®å€¤ãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤º
        updateEl.textContent = data.lastUpdate;
    } else if (allLiveRecords.length > 0) {
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ—¥ä»˜ã‚’è¨ˆç®—
        try {
            const latestDate = allLiveRecords.reduce((latest, rec) => {
                const d = new Date(rec.date);
                return d > latest ? d : latest;
            }, new Date(0));
            
            if (!isNaN(latestDate.getTime())) {
                updateEl.textContent = `${latestDate.getFullYear()}/${('0' + (latestDate.getMonth() + 1)).slice(-2)}/${('0' + latestDate.getDate()).slice(-2)}`;
            }
        } catch(e) { console.error(e); }
    }
  }

  analyzeSongStats(allLiveRecords);
  analyzePatterns(allLiveRecords);
  analyzeLastPlayed(allLiveRecords);
  populateFilters(allLiveRecords);
  
  if (historyData.length > 0) {
      renderHistoryTab();
  }

  const searchInput = document.getElementById('search-input');
  if (searchInput && !searchInput.hasAttribute('data-listener-attached')) {
    setupEventListeners();
    searchInput.setAttribute('data-listener-attached', 'true');
  }

  applyFilters();
  checkOrientation();
  window.addEventListener('resize', checkOrientation);

  renderLiveCountChart();
  renderAlbumChart();
  renderSongRanking(); 
  renderPatternStats();
  renderLastPlayedRanking();
  renderVenueRanking();
  renderVenueLiveCountChart();

  // â˜…è¿½åŠ : ãƒ‡ãƒ¼ã‚¿åˆ°ç€ãŒé…ã‚Œã¦ã€ã™ã§ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ãŒæ¶ˆãˆã¦ã„ãŸå ´åˆã®ä¿é™º
  const loadingDiv = document.getElementById('loading-container');
  if (loadingDiv && loadingDiv.style.display === 'none') {
      checkTodayEvents();
  }
  
  // åˆæœŸåŒ–å®Œäº†Promiseã‚’è§£æ±º
  if (appInitializedResolver) appInitializedResolver();
}

function formatTourName(name) {
  if (!name) return "";
  let n = name;
  
  n = n.split(/[ã€œ~]/)[0];
  
  if (n.match(/Love Like (Pop|Rock|Aloha)/i)) {
      n = n.replace(/Love Like /i, '');
      n = n.replace(/ vol\.?/i, ''); 
      n = n.replace(/è¿½åŠ å…¬æ¼”/g, ''); 
      n = n.trim();
      n = n.replace(/\s+/g, '');
  }
  return n.trim();
}

// -----------------------------------------------------------
// ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ»å¹´é½¢è¨ˆç®—ç”¨é–¢æ•° (from History App)
// -----------------------------------------------------------
function getLifeStage(targetDate, birth) {
  // ãƒ©ã‚¤ãƒ•ã‚¹ãƒ†ãƒ¼ã‚¸åˆ—å‰Šé™¤ã«ä¼´ã„æœªä½¿ç”¨ã«ãªã‚Šã¾ã—ãŸãŒã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯è‡ªä½“ã¯ä¿æŒ
  const getSchoolCohort = (d) => {
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    return (m <= 3 || (m === 4 && d.getDate() === 1)) ? y - 1 : y;
  };
  const getFiscalYear = (d) => {
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    return (m <= 3) ? y - 1 : y;
  }
  const birthYearCohort = getSchoolCohort(birth);
  const targetYearFiscal = getFiscalYear(targetDate);
  const grade = targetYearFiscal - birthYearCohort;
  
  if (grade < 7) return 'æœªå°±å­¦';
  if (grade === 7) return 'å°å­¦1å¹´';
  if (grade === 8) return 'å°å­¦2å¹´';
  if (grade === 9) return 'å°å­¦3å¹´';
  if (grade === 10) return 'å°å­¦4å¹´';
  if (grade === 11) return 'å°å­¦5å¹´';
  if (grade === 12) return 'å°å­¦6å¹´';
  if (grade === 13) return 'ä¸­å­¦1å¹´';
  if (grade === 14) return 'ä¸­å­¦2å¹´';
  if (grade === 15) return 'ä¸­å­¦3å¹´';
  if (grade === 16) return 'é«˜æ ¡1å¹´';
  if (grade === 17) return 'é«˜æ ¡2å¹´';
  if (grade === 18) return 'é«˜æ ¡3å¹´';
  if (grade === 19) return 'å¤§å­¦1å¹´';
  if (grade === 20) return 'å¤§å­¦2å¹´';
  if (grade === 21) return 'å¤§å­¦3å¹´';
  if (grade === 22) return 'å¤§å­¦4å¹´';
  if (grade > 22) return 'aiko';
  return '';
}

function renderHistoryTab() {
    const tbody = document.getElementById('timeline-body');
    if (!tbody) return;
    tbody.innerHTML = '';

    // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºã‚’è¿½åŠ 
    if (!historyData || historyData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center py-8 text-gray-400 text-xs">ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...<br>è¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</td></tr>';
        return;
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒƒãƒ—ã®ä½œæˆ
    const eventsMap = {}; 
    historyData.forEach(row => {
        if (!row.date) return;
        const d = new Date(row.date);
        const key = `${d.getFullYear()}-${d.getMonth() + 1}`;
        if (!eventsMap[key]) eventsMap[key] = { lives: new Set(), singles: [], albums: [] };
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³A: æ–°æ–¹å¼ (App_Live.gsã§è‡ªå‹•ç”Ÿæˆ: type + title)
        if (row.type) {
            if (row.type === 'live') eventsMap[key].lives.add(formatTourName(row.title));
            if (row.type === 'single') eventsMap[key].singles.push(row.title);
            if (row.type === 'album') eventsMap[key].albums.push(row.title);
        }
        // ãƒ‘ã‚¿ãƒ¼ãƒ³B: æ—§æ–¹å¼ (App_History.gs / history_å¹´è¡¨ã‚·ãƒ¼ãƒˆ: live, single, albumãƒ—ãƒ­ãƒ‘ãƒ†ã‚£)
        // Historyã‚¢ãƒ—ãƒªã¨åŒã˜ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€å ´åˆã¯ã“ã¡ã‚‰ãŒä½¿ã‚ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
        else {
            if (row.live) eventsMap[key].lives.add(formatTourName(row.live));
            if (row.single) eventsMap[key].singles.push(row.single);
            if (row.album) eventsMap[key].albums.push(row.album);
        }
    });

    // è¡¨ç¤ºé–‹å§‹ï¼š1996å¹´8æœˆ (ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¼ã‚ºæ´»å‹•æœŸ)
    // è¨ˆç®—åŸºæº–ï¼š1975å¹´ (aikoèª•ç”Ÿæ—¥)
    let current = new Date(1996, 7, 1);
    const end = new Date(); // ç¾åœ¨ã¾ã§
    let prevYear = -1;

    while (current <= end) {
        const y = current.getFullYear();
        const m = current.getMonth() + 1;
        const key = `${y}-${m}`;
        
        // å¹´é½¢è¨ˆç®—
        let age = y - AIKO_BIRTH.getFullYear();
        if (m < (AIKO_BIRTH.getMonth() + 1)) age--;
        
        let liveHtml = '';
        let cdHtml = '';
        
        if (eventsMap[key]) {
            eventsMap[key].lives.forEach(liveName => { 
                const safeName = liveName.replace(/'/g, "\\'");
                // Liveåã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰æ¤œç´¢ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
                liveHtml += `<div class="event-chip chip-live" onclick="findAndShowLive('${y}/${m}/01', '${safeName}')">${liveName}</div>`; 
            });
            eventsMap[key].singles.forEach(s => { cdHtml += `<div class="event-chip chip-single">S: ${s}</div>`; });
            eventsMap[key].albums.forEach(a => { cdHtml += `<div class="event-chip chip-album">Al: ${a}</div>`; });
        }

        const yearDisplay = (y !== prevYear) ? `<span class="text-xs font-bold block text-gray-500">${y}</span>` : '';
        prevYear = y;

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td class="text-center text-gray-400 font-mono border-r border-gray-100">
                ${yearDisplay}
                <span class="text-[10px] text-gray-300">${m}æœˆ</span>
            </td>
            <td class="text-center font-bold text-aiko-red border-r border-gray-100">${age >= 0 ? age : ''}</td>
            <td class="pl-1">${liveHtml}</td>
            <td class="pl-1">${cdHtml}</td>
        `;
        tbody.appendChild(tr);
        current.setMonth(current.getMonth() + 1);
    }
}

window.findAndShowLive = function(dateStr, tourName) {
    document.getElementById('search-input').value = tourName;
    document.getElementById('tour-select').value = '';
    document.getElementById('year-select').value = '';
    document.getElementById('region-select').value = '';
    document.getElementById('song-filter-input').value = '';
    switchToTab('search');
    applyFilters();
}

// -----------------------------------------------------------
// ãã®ä»–
// -----------------------------------------------------------
function setupRandomTriggers() {
  function createDoubleTapHandler(callback) {
    let tapCount = 0;
    let timer = null;
    let lastTouchX = 0;
    let lastTouchY = 0;

    const reset = () => {
        tapCount = 0;
        if (timer) {
            clearTimeout(timer);
            timer = null;
        }
    };

    const handler = (e) => {
        if (e.type === 'touchstart') {
            lastTouchX = e.changedTouches[0].screenX;
            lastTouchY = e.changedTouches[0].screenY;
            return;
        }

        if (e.type === 'touchend') {
            const touch = e.changedTouches[0];
            if (Math.abs(touch.screenX - lastTouchX) > 10 || Math.abs(touch.screenY - lastTouchY) > 10) {
                reset();
                return;
            }
        }

        tapCount++;
        
        if (tapCount === 1) {
            timer = setTimeout(reset, 350); 
        } else if (tapCount === 2) {
            e.preventDefault();
            reset();
            
            const target = e.currentTarget;
            target.classList.remove('tap-highlight');
            void target.offsetWidth;
            target.classList.add('tap-highlight');
            
            callback();
        }
    };

    return {
        touchstart: handler,
        touchend: handler,
        dblclick: (e) => {
            e.preventDefault();
            callback();
        }
    };
  }

  const omikujiArea = document.getElementById('omikuji-trigger-area');
  if (omikujiArea) {
    const handlers = createDoubleTapHandler(() => { 
        // â˜…è¿½åŠ : ãŠã¿ãã˜æ©Ÿèƒ½ã®åˆ©ç”¨è¨ˆæ¸¬
        safeTrackEvent('select_content', { content_type: 'random_trigger', item_id: 'omikuji_double_tap' });
        playOmikuji(); 
    });
    omikujiArea.addEventListener('touchstart', handlers.touchstart, {passive: false});
    omikujiArea.addEventListener('touchend', handlers.touchend, {passive: false});
    omikujiArea.addEventListener('dblclick', handlers.dblclick);
  }

  const songHeader = document.getElementById('song-ranking-header');
  if (songHeader) {
    const handlers = createDoubleTapHandler(() => {
        // â˜…è¿½åŠ : ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—è¨ˆæ¸¬
        safeTrackEvent('select_content', { content_type: 'random_trigger', item_id: 'song_ranking_double_tap' });
        const icon = document.getElementById('song-ranking-icon');
        if (icon) {
            icon.classList.remove('spin-once');
            void icon.offsetWidth; 
            icon.classList.add('spin-once');
        }
        const songs = Object.keys(songStats);
        if (songs.length === 0) return;
        const randomSong = songs[Math.floor(Math.random() * songs.length)];
        setTimeout(() => {
            selectSong(randomSong);
            // ä¿®æ­£ç®‡æ‰€: appã‚³ãƒ³ãƒ†ãƒŠã®æœ€ä¸Šéƒ¨ã¸ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã•ã›ã‚‹
            document.getElementById('app').scrollTo({ top: 0, behavior: 'smooth' });
        }, 600);
    });
    
    songHeader.addEventListener('touchstart', handlers.touchstart, {passive: false});
    songHeader.addEventListener('touchend', handlers.touchend, {passive: false});
    songHeader.addEventListener('dblclick', handlers.dblclick);
  }

  ['venue-tab-header', 'region-tab-header'].forEach(id => {
      const el = document.getElementById(id);
      if(el) {
          const handlers = createDoubleTapHandler(() => {
              if(!el.classList.contains('active')) return;
              // â˜…è¿½åŠ : å ´æ‰€ã‚¿ãƒ–ãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—è¨ˆæ¸¬
              safeTrackEvent('select_content', { content_type: 'random_trigger', item_id: id + '_double_tap' });

              if(id === 'venue-tab-header') {
                  const venues = [];
                  allLiveRecords.forEach(rec => {
                        const v = rec.region === 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : `${rec.venue} (${rec.region})`;
                        if (!venues.includes(v)) venues.push(v);
                  });
                  if(venues.length > 0) {
                      const randomVenue = venues[Math.floor(Math.random() * venues.length)];
                      selectVenue(randomVenue);
                  }
              } else {
                  const regions = [];
                  allLiveRecords.forEach(rec => {
                      if (rec.region && !regions.includes(rec.region)) regions.push(rec.region);
                  });
                  if(regions.length > 0) {
                      const randomRegion = regions[Math.floor(Math.random() * regions.length)];
                      selectRegion(randomRegion);
                  }
              }
          });
          el.addEventListener('touchstart', handlers.touchstart, {passive: false});
          el.addEventListener('touchend', handlers.touchend, {passive: false});
          el.addEventListener('dblclick', handlers.dblclick);
      }
  });
}

function playOmikuji() {
    const icon = document.getElementById('omikuji-icon');
    icon.classList.remove('spin-once');
    void icon.offsetWidth; 
    icon.classList.add('spin-once');

    const randomLive = allLiveRecords[Math.floor(Math.random() * allLiveRecords.length)];
    setTimeout(() => {
        showOmikujiResult(randomLive);
    }, 600);
}

function showOmikujiResult(rec) {
    // â˜…è¿½åŠ : ãŠã¿ãã˜çµæœè¡¨ç¤ºã®è¨ˆæ¸¬
    safeTrackEvent('earn_virtual_currency', { 
        virtual_currency_name: 'omikuji', 
        value: 1, 
        item_name: rec.tourName 
    });

    const tourNameLower = rec.tourName.toLowerCase();
    let labelType = 'other', labelText = 'Event';
    if (tourNameLower.includes('love like pop')) { labelType = 'pop'; labelText = 'POP'; }
    else if (tourNameLower.includes('love like rock')) { labelType = 'rock'; labelText = 'ROCK'; }
    else if (tourNameLower.includes('love like aloha')) { labelType = 'aloha'; labelText = 'ALOHA'; }

    document.getElementById('modal-body').innerHTML = `
        <h2 class="font-bold text-center text-xl mb-4 text-aiko-pink">ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ã‚»ãƒˆãƒªğŸ¤</h2>
        <div class="card-base live-card cursor-pointer shadow-md" onclick="closeModal(); showLiveDetail(allLiveRecords.find(r => r.date === '${rec.date}' && r.tourName === '${rec.tourName}'))">
        <div class="live-card-label ${labelType}">${labelText}</div>
        <p class="text-gray-500 font-medium text-xs">${rec.date} (${rec.dayOfWeek})</p>
        <p class="font-bold mt-1 text-gray-800 text-lg leading-tight">${rec.tourName}</p>
        <p class="text-gray-600 text-sm mt-1">${rec.venue} (${rec.region})</p>
        <p class="mt-2 font-semibold text-aiko-pink text-sm">ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ: ${rec.songCount}æ›²</p>
      </div>
      <p class="text-center text-gray-400 text-xs mt-2">ğŸ‘† ã‚¿ãƒƒãƒ—ã§è©³ç´°ã¸</p>
    `;
    document.getElementById('modal-overlay').style.display = 'flex';
}

function startConfetti() {
  const canvas = document.getElementById('confetti-canvas');
  const ctx = canvas.getContext('2d');
  let width = window.innerWidth;
  let height = window.innerHeight;
  canvas.width = width;
  canvas.height = height;

  const particles = [];
  const colors = ['#FFD700', '#C0C0C0', '#E5E4E2', '#DAA520', '#FF69B4', '#ef4444', '#FFA500']; 
  
  // ä¸­å¤®ã‹ã‚‰å¼¾ã‘ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
  class ExplosionParticle {
    constructor() {
      // å…ƒã‚³ãƒ¼ãƒ‰ã§ã¯ç‰¹å®šã®è¦ç´ ï¼ˆtour-selectï¼‰ã®ä½ç½®ã‚’å–å¾—ã—ã¦ã„ã¾ã—ãŸãŒã€
      // å˜ä½“å‹•ä½œã®ãŸã‚ç”»é¢ä¸­å¤®ã‚’èµ·ç‚¹ã¨ã™ã‚‹ã‚ˆã†ã«èª¿æ•´ã—ã¦ã„ã¾ã™ã€‚
      const menuRect = document.getElementById('tour-select')?.getBoundingClientRect();
      const originX = menuRect ? (menuRect.left + menuRect.width / 2) : (width / 2);
      const originY = menuRect ? (menuRect.top + menuRect.height / 2) : (height / 2);

      this.x = originX;
      this.y = originY;
      
      this.color = colors[Math.floor(Math.random() * colors.length)];
      this.w = Math.random() * 8 + 4;
      this.h = Math.random() * 4 + 2; 
      
      const angle = Math.random() * Math.PI * 2;
      const velocity = Math.random() * 18 + 10; 
      this.vx = Math.cos(angle) * velocity;
      this.vy = Math.sin(angle) * velocity - 8; 
      
      this.gravity = 0.4;
      this.friction = 0.92; 
      this.rotation = Math.random() * 360;
      this.rotationSpeed = (Math.random() - 0.5) * 20;
      this.alpha = 1;
    }
    update() {
      this.vy += this.gravity;
      this.vx *= this.friction;
      this.vy *= this.friction;
      this.x += this.vx;
      this.y += this.vy;
      this.rotation += this.rotationSpeed;
      if (this.y > height + 20) this.alpha -= 0.05; 
    }
    draw(ctx) {
      if (this.alpha <= 0) return;
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.rotation * Math.PI / 180);
      ctx.globalAlpha = this.alpha;
      ctx.fillStyle = this.color;
      ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
      ctx.restore();
    }
  }

  // ä¸Šç©ºã‹ã‚‰é™ã£ã¦ãã‚‹éŠ€ãƒ†ãƒ¼ãƒ—
  class CannonParticle {
    constructor() {
      this.x = Math.random() * width; 
      // ç”»é¢ä¸Šéƒ¨ã®è¦‹ãˆãªã„ä½ç½®ã‹ã‚‰ã‚¹ã‚¿ãƒ¼ãƒˆ
      this.y = - (Math.random() * 300 + 100); 
      
      this.color = colors[Math.floor(Math.random() * colors.length)];
      this.w = Math.random() * 8 + 4; 
      this.h = Math.random() * 60 + 30; // ãƒ†ãƒ¼ãƒ—ã®é•·ã•
      this.vy = Math.random() * 5 + 5; // è½ä¸‹é€Ÿåº¦
      this.vx = (Math.random() - 0.5) * 10; // æ¨ªæºã‚Œ
      this.gravity = 0.2; 
      this.friction = 0.94; 
      this.angle = Math.random() * 360;
      this.angleSpeed = (Math.random() - 0.5) * 15;
      this.flip = 0;
      this.flipSpeed = Math.random() * 0.2 + 0.05;
    }
    update() {
      this.vy += this.gravity;
      this.vx *= this.friction;
      this.x += this.vx;
      this.y += this.vy;
      if (this.vy > 6) this.vy *= 0.95; // è½ä¸‹é€Ÿåº¦åˆ¶é™ï¼ˆç©ºæ°—æŠµæŠ—é¢¨ï¼‰
      this.angle += this.angleSpeed;
      this.flip += this.flipSpeed;
    }
    draw(ctx) {
      // ç”»é¢å¤–ã®ä¸‹ã«è½ã¡ãŸã‚‰æç”»ã—ãªã„
      if (this.y > height + 100 && this.vy > 0) return;
      
      ctx.save();
      ctx.translate(this.x, this.y);
      ctx.rotate(this.angle * Math.PI / 180);
      const scaleY = Math.cos(this.flip); // å›è»¢ã«ã‚ˆã‚‹ã€Œã²ã‚‰ã²ã‚‰ã€åŠ¹æœ
      ctx.scale(1, scaleY);
      ctx.fillStyle = this.color;
      ctx.fillRect(-this.w/2, -this.h/2, this.w, this.h);
      ctx.restore();
    }
  }

  // 1. ã¯ã˜ã‘ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆExplosionï¼‰ã‚’ç”Ÿæˆ
  for (let i = 0; i < 200; i++) {
    particles.push(new ExplosionParticle());
  }

  // 2. å°‘ã—é…ã‚Œã¦é™ã£ã¦ãã‚‹ãƒ†ãƒ¼ãƒ—ï¼ˆCannon/Confettiï¼‰ã‚’ç”Ÿæˆ
  setTimeout(() => {
      for (let i = 0; i < 100; i++) {
        particles.push(new CannonParticle());
      }
  }, 350); 

  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ—
  function animate() {
    ctx.clearRect(0, 0, width, height);
    let activeParticles = 0;
    
    particles.forEach(p => {
      p.update();
      p.draw(ctx);
      // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãŒç”»é¢å†…ã€ã‚ã‚‹ã„ã¯æ´»å‹•ä¸­ã‹ãƒã‚§ãƒƒã‚¯
      if (p.alpha > 0 && (p.y < height + 100 || (p.vy && p.vy < 0))) {
          activeParticles++;
      }
    });
    
    // ã¾ã å‹•ã„ã¦ã„ã‚‹ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ãŒã„ã‚Œã°ãƒ«ãƒ¼ãƒ—ç¶™ç¶š
    if (activeParticles > 0) {
      requestAnimationFrame(animate);
    } else {
      ctx.clearRect(0, 0, width, height);
    }
  }
    
  animate();
    
  // ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
  const resizeHandler = () => {
    width = window.innerWidth;
    height = window.innerHeight;
    canvas.width = width;
    canvas.height = height;
  };
  window.addEventListener('resize', resizeHandler);
}

function checkOrientation() {
  if ('ontouchend' in document && window.innerWidth > window.innerHeight) {
    document.body.classList.add('landscape');
  } else {
    document.body.classList.remove('landscape');
  }
}

const chartCommonOptions = {
  responsive: true,
  maintainAspectRatio: false,
  plugins: { legend: { display: false } },
  scales: {
    x: { ticks: { font: { size: 10 } } },
    y: { ticks: { font: { size: 10 } } }
  }
};

function renderAlbumChart() {
  const canvas = document.getElementById('album-chart');
  if (!canvas || !albumData.length) return;
  if (chartInstances.album) {
    chartInstances.album.destroy();
    chartInstances.album = null;
  }
  chartInstances.album = new Chart(canvas, {
    type: 'bar',
    data: {
      labels: albumData.map(item => item.albumName),
      datasets: [{
        label: 'æ¼”å¥å›æ•°',
        data: albumData.map(item => item.playCount),
        backgroundColor: 'rgba(255, 105, 180, 0.8)',
        borderColor: 'rgba(255, 105, 180, 1)',
        borderWidth: 1,
        borderRadius: 4
      }]
    },
    options: {
      ...chartCommonOptions,
      indexAxis: 'y',
      plugins: {
        legend: { display: false },
        datalabels: {
          color: 'white',
          anchor: 'end',
          align: 'start',
          offset: 4,
          font: { weight: 'bold', size: 11 },
          formatter: (value) => value > 0 ? value : ''
        }
      },
      scales: {
        x: { beginAtZero: true, ticks: { font: { size: 10 } } },
        y: { ticks: { font: { size: 10 }, autoSkip: false } }
      }
    },
    plugins: [ChartDataLabels]
  });
}

function renderLiveCountChart() {
  const canvas = document.getElementById('live-count-chart');
  if (!canvas) return;
  if (chartInstances.liveCount) chartInstances.liveCount.destroy();

  const liveCountsByYear = allLiveRecords.reduce((acc, rec) => {
    if (rec.year) acc[rec.year] = (acc[rec.year] || 0) + 1;
    return acc;
  }, {});

  const songToSearch = document.getElementById('song-search-input').value.trim();
  const isMedleyIncluded = document.getElementById('medley-toggle').checked;

  const songPlaysByYear = {};
  if (songToSearch) {
    allLiveRecords.forEach(rec => {
      if (!rec.year) return;
      
      let inMedley = false;
      let count = 0;

      rec.setlist.forEach(s => {
        if (s === '__MEDLEY_START__') { inMedley = true; return; }
        if (s === '__MEDLEY_END__') { inMedley = false; return; }
        
        // ãƒ¡ãƒ‰ãƒ¬ãƒ¼é™¤å¤–è¨­å®šã§ã€ã‹ã¤ç¾åœ¨ãƒ¡ãƒ‰ãƒ¬ãƒ¼ä¸­ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        if (!isMedleyIncluded && inMedley) return;

        const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
        if (clean.toLowerCase() === songToSearch.toLowerCase()) {
            count++;
        }
      });

      if (count > 0) songPlaysByYear[rec.year] = (songPlaysByYear[rec.year] || 0) + count;
    });
  }

  const years = Object.keys(liveCountsByYear).sort((a, b) => a - b);
  const totalLiveData = years.map(year => liveCountsByYear[year]);
  const songPlayData = years.map(year => songPlaysByYear[year] || 0);

  const datasets = [{
    label: 'æ¥½æ›²æ¼”å¥',
    data: songPlayData,
    backgroundColor: 'rgba(255, 105, 180, 0.8)',
    borderColor: 'rgba(255, 105, 180, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: {
      display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
      color: 'gray',
      anchor: 'end',
      align: 'end',
      offset: -2,
      font: { size: 10, weight: 'bold' },
      formatter: val => val
    }
  }, {
    label: 'ãã®ä»–',
    data: totalLiveData.map((total, i) => Math.max(0, total - songPlayData[i])),
    backgroundColor: 'rgba(229, 231, 235, 0.8)',
    borderColor: 'rgba(229, 231, 235, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: { display: false }
  }];

  chartInstances.liveCount = new Chart(canvas, {
    type: 'bar',
    data: { labels: years, datasets },
    plugins: [ChartDataLabels],
    options: {
      ...chartCommonOptions,
      scales: {
        x: {
          stacked: true,
          ticks: { font: { size: 10 }, maxRotation: 90, minRotation: 90, autoSkip: false }
        },
        y: { stacked: true, beginAtZero: true, min: 0, ticks: { font: { size: 10 }, stepSize: 5 } }
      }
    }
  });
}

function renderVenueLiveCountChart() {
  const canvas = document.getElementById('venue-live-count-chart');
  if (!canvas) return;
  if (chartInstances.venueLiveCount) chartInstances.venueLiveCount.destroy();

  const liveCountsByYear = allLiveRecords.reduce((acc, rec) => {
    if (rec.year) acc[rec.year] = (acc[rec.year] || 0) + 1;
    return acc;
  }, {});

  const selectedPlaysByYear = {};
  if (selectedVenueInfo) {
    allLiveRecords.forEach(rec => {
      if (!rec.year) return;
      let isMatch = false;
      if (selectedVenueInfo.type === 'venue') {
        const venueKey = rec.region === 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' ? 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³' : `${rec.venue} (${rec.region})`;
        if (venueKey === selectedVenueInfo.name) isMatch = true;
      } else if (selectedVenueInfo.type === 'region') {
        if (rec.region === selectedVenueInfo.name) isMatch = true;
      }
      if (isMatch) selectedPlaysByYear[rec.year] = (selectedPlaysByYear[rec.year] || 0) + 1;
    });
  }

  const years = Object.keys(liveCountsByYear).sort((a, b) => a - b);
  const totalLiveData = years.map(year => liveCountsByYear[year]);
  const selectedPlayData = years.map(year => selectedPlaysByYear[year] || 0);

  const datasets = [{
    label: 'é¸æŠå ´æ‰€',
    data: selectedPlayData,
    backgroundColor: 'rgba(255, 105, 180, 0.8)',
    borderColor: 'rgba(255, 105, 180, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: {
      display: ctx => ctx.dataset.data[ctx.dataIndex] > 0,
      color: 'gray',
      anchor: 'end',
      align: 'end',
      offset: -2,
      font: { size: 10, weight: 'bold' },
      formatter: val => val
    }
  }, {
    label: 'ãã®ä»–',
    data: totalLiveData.map((total, i) => Math.max(0, total - selectedPlayData[i])),
    backgroundColor: 'rgba(229, 231, 235, 0.8)',
    borderColor: 'rgba(229, 231, 235, 1)',
    borderWidth: 1,
    stack: 'stack1',
    datalabels: { display: false }
  }];

  chartInstances.venueLiveCount = new Chart(canvas, {
    type: 'bar',
    data: { labels: years, datasets },
    plugins: [ChartDataLabels],
    options: {
      ...chartCommonOptions,
      scales: {
        x: {
          stacked: true,
          ticks: { font: { size: 10 }, maxRotation: 90, minRotation: 90, autoSkip: false }
        },
        y: { stacked: true, beginAtZero: true, min: 0, ticks: { font: { size: 10 }, stepSize: 5 } }
      }
    }
  });
}

function analyzeSongStats(records) {
  songStats = {};
  songStatsNoMedley = {};

  // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã«ã‚ã‚‹å…¨æ›²ã‚’0å›ã§åˆæœŸåŒ–
  if (songData) {
    Object.keys(songData).forEach(songName => {
      // ã‚«ã‚®ã‚«ãƒƒã‚³ä»˜ãï¼ˆã‚«ãƒãƒ¼æ›²ãªã©ï¼‰ã¯åˆæœŸåŒ–ã‚‚ã—ãªã„ï¼ˆé™¤å¤–ï¼‰
      if (!songName.includes('[') && !songName.includes(']')) {
          songStats[songName] = 0;
          songStatsNoMedley[songName] = 0;
      }
    });
  }

  records.forEach(rec => {
    let inMedley = false;
    rec.setlist.forEach(s => {
      if (s === '__MEDLEY_START__') { inMedley = true; return; }
      if (s === '__MEDLEY_END__') { inMedley = false; return; }

      const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
      
      // é™¤å¤–åˆ¤å®š: ãƒ¡ãƒ‰ãƒ¬ãƒ¼æ–‡å­—ã€ã¾ãŸã¯ [] ã‚’å«ã‚€æ›²
      if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) {
        // å…¨é›†è¨ˆï¼ˆãƒ¡ãƒ‰ãƒ¬ãƒ¼è¾¼ã¿ï¼‰
        songStats[clean] = (songStats[clean] || 0) + 1;
        // ãƒ¡ãƒ‰ãƒ¬ãƒ¼é™¤å¤–é›†è¨ˆ
        if (!inMedley) {
            songStatsNoMedley[clean] = (songStatsNoMedley[clean] || 0) + 1;
        }
      }
    });
  });
}

function analyzePatterns(records) {
  const o = {}, e = {}, l = {};
  records.forEach(rec => {
    // ãƒ¡ãƒ‰ãƒ¬ãƒ¼åŒºé–“ã‚’å®Œå…¨ã«é™¤å¤–ã—ã¦ãƒªã‚¹ãƒˆã‚’ä½œæˆã™ã‚‹
    const cleanSetlist = [];
    let inMedley = false;
