<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>LLDB Live</title>
<meta name="theme-color" content="#ef4444">

<script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-0D09G3X4F1', { 'send_page_view': false });
</script>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

<style>
:root {
  --aiko-pink: #FF69B4;
  --aiko-red: #E63946;
  --aiko-yellow: #FFD700;
  --aiko-blue: #00BFFF;
  --aiko-bg: #F8F9FA;
  --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
  --nav-height: 85px;
  --accent-light: #fef2f2;
}
* { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
html { height: 100%; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', 'Hiragino Kaku Gothic ProN', Meiryo, sans-serif;
  background-color: var(--aiko-bg);
  color: #334155;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  height: 100%;
  margin: 0;
  touch-action: pan-y pinch-zoom;
  user-select: none;
  -webkit-user-select: none;
  overflow: hidden;
}
body.detail-view nav { display: none !important; }

@media screen and (max-device-width: 1024px) and (orientation: landscape) {
  body.landscape nav { display: none !important; }
}

.mobile-frame { 
  width: 100%; 
  max-width: 100%; 
  height: 100%; 
  background-color: #F8F9FA; 
  position: relative; 
  overflow-y: auto;
  overflow-x: hidden; 
  -webkit-overflow-scrolling: touch;
  padding-bottom: calc(var(--nav-height) + 20px + env(safe-area-inset-bottom));
}

body.detail-view .mobile-frame {
  padding-bottom: calc(20px + env(safe-area-inset-bottom)) !important;
}

#confetti-canvas {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
  z-index: 9999;
}

.card-base {
  background-color: white;
  border-radius: 16px;
  box-shadow: var(--card-shadow);
  padding: 12px;
  margin-bottom: 12px;
  border: 1px solid rgba(0,0,0,0.03);
}

nav {
  position: fixed !important;
  bottom: 0;
  left: 0;
  right: 0;
  display: flex !important;
  border-top: 1px solid #e5e7eb;
  z-index: 50;
  width: 100%;
  background-color: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  height: calc(var(--nav-height) + env(safe-area-inset-bottom));
  padding-bottom: env(safe-area-inset-bottom);
  box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.02);
}

.tab-item {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  padding-top: 12px;
  gap: 4px;
  color: #94a3b8;
  cursor: pointer;
  transition: all 0.2s;
  background-color: transparent;
  height: 100%;
  position: relative;
}

.tab-item.active { color: var(--aiko-red); }
.tab-item.active svg { stroke-width: 2.5px; }

.setlist-item {
  padding: 5px 0;
  border-bottom: 1px solid #f3f4f6;
  font-size: 15px;
  line-height: 1.5;
  display: flex;
  align-items: center;
  justify-content: space-between;
  min-height: 38px;
  border-left: 4px solid transparent; 
  padding-left: 8px;
}
.setlist-item:last-child { border-bottom: none; }
.setlist-medley-title { border-left-color: var(--aiko-yellow) !important; background-color: #fffbeb !important; }
.setlist-medley { border-left-color: var(--aiko-yellow) !important; }
.setlist-encore-header {
  margin-top: 16px;
  margin-bottom: 6px;
  font-weight: 800;
  color: var(--aiko-red);
  font-size: 16px;
  padding: 4px 8px;
  background-color: #fef2f2;
  border-left: 4px solid var(--aiko-red);
  border-radius: 0 4px 4px 0;
}
.setlist-encore { border-left-color: var(--aiko-red) !important; }

.setlist-left-content { display: flex; align-items: baseline; width: 60%; flex: none; padding-right: 8px; }
.setlist-item-number { display: inline-block; min-width: 24px; flex-shrink: 0; color: #9CA3AF; font-size: 12px; }
.setlist-item-title { font-weight: 600; color: #334155; overflow-wrap: break-word; }

.timeline-container { flex: 1; height: 30px; display: flex; align-items: center; position: relative; padding-left: 8px; cursor: pointer; }
.timeline-bar { width: 100%; height: 3px; background-color: #e2e8f0; border-radius: 2px; position: relative; }
.timeline-dot {
  width: 12px; height: 12px; border-radius: 50%; position: absolute; top: 50%;
  transform: translate(-50%, -50%); border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  background-color: var(--aiko-pink); z-index: 10; transition: transform 0.1s;
}
.year-tooltip {
  position: absolute; bottom: 16px; left: 50%; transform: translateX(-50%);
  background-color: #334155; color: white; padding: 2px 6px; border-radius: 4px;
  font-size: 10px; font-weight: bold; white-space: nowrap; pointer-events: none;
  opacity: 0; transition: opacity 0.2s; z-index: 20;
}
.year-tooltip::after {
  content: ""; position: absolute; top: 100%; left: 50%; margin-left: -4px;
  border-width: 4px; border-style: solid; border-color: #334155 transparent transparent transparent;
}
.timeline-dot.active { transform: translate(-50%, -50%) scale(1.3); }
.timeline-dot.active .year-tooltip { opacity: 1; }

.history-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.history-table th {
  position: sticky; top: 0; background-color: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(8px); color: #334155; border-bottom: 2px solid var(--accent-light);
  font-size: 11px; font-weight: 700; padding: 12px 2px; z-index: 20; text-align: center;
}
.history-table td { padding: 10px 4px; border-bottom: 1px solid #f1f5f9; font-size: 11px; height: 44px; background-color: white; }

.event-chip { display: inline-block; padding: 3px 8px; border-radius: 6px; font-size: 10px; font-weight: bold; margin-bottom: 3px; line-height: 1.3; border: 1px solid transparent; max-width: 100%; cursor: pointer; }
.chip-live { background-color: #fef2f2; color: #ef4444; border-color: #fecaca; }
.chip-single { background-color: #f0f9ff; color: #0284c7; border-color: #bae6fd; cursor: default; }
.chip-album { background-color: #fefce8; color: #854d0e; border-color: #fef08a; cursor: default; }

.tap-trigger { touch-action: manipulation; user-select: none; }
main { padding: 12px; }
body.detail-view main { padding-top: 16px; padding-bottom: 32px; }

input, select { font-size: 14px !important; padding: 10px 12px !important; border-radius: 12px !important; border: 1px solid #cbd5e1 !important; background-color: #fff !important; }
button { font-size: 13px !important; }

.clickable-item { cursor: pointer; transition: background-color 0.2s; }
.clickable-item:hover { background-color: #f8fafc; }

.action-btn { padding: 8px 12px; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; border: none; white-space: nowrap; }
.clear-btn { background-color: #ef4444; color: white; }
.setlist-btn { background-color: var(--aiko-blue); color: white; }

.venue-tabs { display: flex; border-bottom: 2px solid #e2e8f0; margin-bottom: 16px; position: sticky; top: 0px; background: #F8F9FA; z-index: 40; padding-top: 8px; }
.venue-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; font-size: 13px; color: #94a3b8; border-bottom: 2px solid transparent; margin-bottom: -2px; }
.venue-tab.active { color: var(--aiko-red); border-bottom-color: var(--aiko-red); }

.toggle-checkbox { position: absolute; opacity: 0; width: 0; height: 0; }
.toggle-label { width: 40px; height: 22px; background-color: #e2e8f0; border-radius: 9999px; position: relative; cursor: pointer; transition: background-color 0.3s; display: block; }
.toggle-label:before { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background-color: white; border-radius: 50%; transition: transform 0.3s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
.toggle-checkbox:checked + .toggle-label { background-color: var(--aiko-red); }
.toggle-checkbox:checked + .toggle-label:before { transform: translateX(18px); }

.back-button-circle { width: 44px; height: 44px; border-radius: 50%; background-color: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; position: fixed; top: 16px; left: 16px; z-index: 1001; }
.back-button-circle svg { width: 22px; height: 22px; stroke: var(--aiko-red); stroke-width: 2.5; }

.modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.6); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; backdrop-filter: blur(2px); }
.modal-content { background: white; border-radius: 16px; padding: 20px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; position: relative; }
.modal-close { position: absolute; top: 12px; right: 12px; width: 28px; height: 28px; background: #f1f5f9; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }

.rank-number { display: inline-block; min-width: 28px; text-align: right; margin-right: 10px; flex-shrink: 0; font-size: 16px; font-weight: 800; font-style: italic; }
.song-title, .venue-name { flex: 1; word-break: break-word; font-size: 16px; font-weight: 700; }
.song-count { white-space: nowrap; flex-shrink: 0; font-size: 15px; font-weight: bold; color: #64748b; }
.song-count span { font-size: 10px; font-weight: normal; margin-left: 2px; }

.live-card { position: relative; overflow: hidden; padding-bottom: 14px; }
.live-card-label { position: absolute; top: 16px; right: -42px; transform: rotate(45deg); background-color: var(--aiko-red); color: white; padding: 3px 0; width: 140px; text-align: center; font-size: 11px; font-weight: bold; z-index: 1; }
.live-card-label.rock { background-color: var(--aiko-blue); }
.live-card-label.aloha { background-color: var(--aiko-yellow); color: #333; }
.live-card-label.other { background-color: #9CA3AF; }

.fade-out { opacity: 0; transition: opacity 0.5s; pointer-events: none; }
.spin-once { animation: spin 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

.loading-placeholder { animation: pulse-bg 1.5s infinite; background-color: #f3f4f6; height: 80px; border-radius: 16px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; color: #cbd5e1; font-weight: bold; }
@keyframes pulse-bg { 0%, 100% { background-color: #f3f4f6; } 50% { background-color: #e5e7eb; } }

/* --- My LLDBç”¨ã‚¹ã‚¿ã‚¤ãƒ« --- */
.attended-badge { display: inline-flex; align-items: center; gap: 4px; background-color: #ecfccb; color: #4d7c0f; font-size: 10px; font-weight: bold; padding: 2px 8px; border-radius: 99px; border: 1px solid #bef264; }
.attendance-toggle-container { display: flex; align-items: center; justify-content: space-between; background-color: #f0fdf4; border: 1px solid #bbf7d0; padding: 12px 16px; border-radius: 12px; margin-bottom: 12px; }
.attendance-toggle-label { font-weight: bold; color: #166534; font-size: 14px; display: flex; align-items: center; gap: 6px; }
.user-memo-area { background-color: #fff; border: 1px dashed #cbd5e1; border-radius: 12px; padding: 12px; margin-bottom: 24px; position: relative; }
.user-memo-area.has-content { background-color: #f8fafc; border-style: solid; }
.memo-placeholder { text-align: center; color: #94a3b8; font-size: 12px; cursor: pointer; padding: 8px; }
.memo-content { font-size: 13px; color: #334155; white-space: pre-wrap; line-height: 1.6; }
.memo-edit-btn { position: absolute; top: 8px; right: 8px; background: #f1f5f9; color: #64748b; border-radius: 6px; padding: 4px 8px; font-size: 11px; cursor: pointer; font-weight: bold; }

/* è¨˜éŒ²ã‚¿ãƒ– ãƒ©ãƒ³ã‚­ãƒ³ã‚°èª¿æ•´ */
#user-song-ranking-container .rank-number { font-size: 16px; width: 28px; text-align: right; }
#user-song-ranking-container .song-title { font-size: 16px; }
#user-song-ranking-container .song-count { font-size: 15px; }

.text-aiko-pink { color: var(--aiko-pink); }
.text-aiko-red { color: var(--aiko-red); }
.text-aiko-yellow { color: #facc15; }
.text-aiko-blue { color: #3b82f6; }
</style>
</head>
<body>
<canvas id="confetti-canvas"></canvas>

<div id="app" class="mobile-frame bg-[#F8F9FA]">
<main id="main-content" style="opacity: 0; transition: opacity 0.5s;">
  <div id="live-detail" style="display:none"></div>

  <div id="tab-search" class="tab-content" style="display:block">
    <p class="text-gray-400 mb-1 text-xs text-right font-mono">Data updated: <span id="last-update-date">-</span></p>
    <div class="card-base bg-white border-0">
      <div class="flex gap-2 mb-2 items-center">
        <div class="relative flex-1">
          <input type="text" id="search-input" placeholder="ãƒ•ãƒªãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢" class="w-full px-3 py-2 bg-gray-50 border-gray-200">
        </div>
        <div class="flex-1 flex items-center justify-end gap-2">
          <div class="flex items-center gap-1 cursor-pointer tap-trigger" onclick="window.parent.postMessage({type: 'openMyLLDB'}, '*')">
            <span class="text-[12px] font-bold text-gray-500">å‚æˆ¦ã—ãŸãƒ©ã‚¤ãƒ–ã®ã¿</span>
            <i data-lucide="info" class="w-3 h-3 text-gray-400"></i>
          </div>
          <div class="relative inline-block align-middle select-none shrink-0">
            <input type="checkbox" id="attended-filter-toggle" class="toggle-checkbox" />
            <label for="attended-filter-toggle" class="toggle-label" style="transform: scale(0.9);"></label>
          </div>
        </div>
      </div>

      <div class="flex flex-col gap-2 mb-2">
        <select id="tour-select" class="w-full text-gray-700 bg-gray-50 border-gray-200">
          <option value="">ã™ã¹ã¦ã®ãƒ©ã‚¤ãƒ–</option>
          <option value="pop">Love Like Pop</option>
          <option value="rock">Love Like Rock</option>
          <option value="aloha">Love Like Aloha</option>
          <option value="other">ãã®ä»–ã®Event</option>
        </select>
        <div class="flex gap-2">
          <select id="year-select" class="flex-1 text-gray-700 bg-gray-50 border-gray-200"><option value="">ã™ã¹ã¦ã®å¹´</option></select>
          <select id="region-select" class="flex-1 text-gray-700 bg-gray-50 border-gray-200"><option value="">ã™ã¹ã¦ã®éƒ½é“åºœçœŒ</option></select>
        </div>
      </div>

      <div class="flex gap-2 items-center">
        <div class="flex-1">
          <input type="text" id="song-filter-input" placeholder="æ›²åã§çµã‚Šè¾¼ã¿ï¼ˆæ¥½æ›²ã‚¿ãƒ–ã‹ã‚‰é¸æŠï¼‰" class="w-full bg-gray-100 text-gray-500 border-dashed" readonly>
        </div>
        <button id="clear-all-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
      </div>
    </div>

    <div id="omikuji-trigger-area" class="my-4 py-1 tap-trigger select-none cursor-pointer text-gray-600 bg-white/50 rounded-xl p-3 border border-dashed border-gray-200 text-center">
      <h3 class="font-bold text-base flex items-center justify-center gap-2">
        <span id="omikuji-icon" class="inline-block text-lg">ğŸ«</span>
        <span>è¡¨ç¤ºä¸­ã®å…¬æ¼”æ•°: <span id="display-count" class="text-lg text-aiko-red">0</span> / <span id="total-count">0</span></span>
      </h3>
    </div>

    <div id="live-list-container" class="space-y-3">
      <div class="loading-placeholder">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

  <div id="tab-song" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-aiko-red"></i> å¹´åˆ¥æ¼”å¥å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="live-count-chart" style="height:220px; max-height:220px"></canvas>
      </div>
    </div>

    <div class="card-base bg-white border-0 mb-4">
      <div class="flex gap-2 mb-3 items-center">
        <div class="relative flex-1">
          <input type="text" id="song-search-input" placeholder="æ¥½æ›²åã§æ¤œç´¢" class="w-full px-3 bg-gray-50 border-gray-200">
        </div>
        <button id="song-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
      <div class="flex justify-between items-center">
        <span class="text-gray-500 text-sm">å…¨æ¥½æ›²: <span id="total-songs" class="font-bold text-gray-800">-</span> æ›²</span>
        <div class="flex items-center gap-2">
          <span class="text-[12px] font-bold text-gray-500">ãƒ¡ãƒ‰ãƒ¬ãƒ¼è¾¼ã¿</span>
          <div class="relative inline-block align-middle select-none shrink-0">
            <input type="checkbox" id="medley-toggle" class="toggle-checkbox" checked/>
            <label for="medley-toggle" class="toggle-label" style="transform: scale(0.85);"></label>
          </div>
        </div>
      </div>
    </div>

    <div class="flex items-center mt-6 mb-3 px-1 gap-1">
      <h3 id="song-ranking-header" class="font-bold text-gray-700 text-[15px] flex-1 cursor-pointer select-none tap-trigger flex items-center gap-1">
        <span id="song-ranking-icon" class="inline-block">ğŸ¸</span> ãƒ©ãƒ³ã‚­ãƒ³ã‚°
      </h3>
      <div class="flex gap-1 items-center shrink-0">
        <div onclick="updateSongSort('count')" class="flex items-center gap-0.5 bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-all">
          <span class="text-[11px] font-bold text-gray-600">æ¼”å¥å›æ•°</span>
          <i id="sort-icon-count" data-lucide="chevron-down" class="w-3 h-3 text-aiko-red"></i>
        </div>
        <div onclick="updateSongSort('year')" class="flex items-center gap-0.5 bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-all">
          <span class="text-[11px] font-bold text-gray-600">(æœ€çµ‚æ¼”å¥å¹´)</span>
          <i id="sort-icon-year" data-lucide="chevrons-up-down" class="w-3 h-3 text-gray-300"></i>
        </div>
      </div>
    </div>
    <div id="song-ranking-container"></div>
  </div>

  <div id="tab-venue" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="bar-chart" class="w-4 h-4 text-aiko-red"></i> å¹´åˆ¥é–‹å‚¬å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="venue-live-count-chart" style="height:220px; max-height:220px"></canvas>
      </div>
    </div>
    <div class="card-base bg-white border-0 mb-0 rounded-b-none pb-4">
      <div class="flex gap-2 items-center">
        <div class="relative flex-1">
          <input type="text" id="venue-search-input" placeholder="ä¼šå ´ / éƒ½é“åºœçœŒã§æ¤œç´¢" class="w-full px-3 bg-gray-50 border-gray-200">
        </div>
        <button id="venue-clear-btn" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        <button id="venue-show-setlist-btn" class="action-btn setlist-btn" style="display: none;">å…¬æ¼”è¡¨ç¤º</button>
      </div>
    </div>
    <div class="venue-tabs mb-3">
      <div class="venue-tab active" data-venue-tab="venue" id="venue-tab-header">ä¼šå ´ãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
      <div class="venue-tab" data-venue-tab="region" id="region-tab-header">éƒ½é“åºœçœŒãƒ©ãƒ³ã‚­ãƒ³ã‚°</div>
    </div>
    <div id="venue-ranking-container" class="mt-2"></div>
    <div id="region-ranking-container" class="mt-2" style="display:none"></div>
  </div>
   
  <div id="tab-pattern" class="tab-content" style="display:none">
    <div class="mb-5">
      <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="disc" class="w-4 h-4 text-aiko-red"></i> ã‚¢ãƒ«ãƒãƒ åˆ¥æ¼”å¥å›æ•°</h3>
      <div class="card-base bg-white p-2">
        <canvas id="album-chart" style="height:300px; max-height:300px"></canvas>
      </div>
    </div>
    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ¬ ã‚ªãƒ¼ãƒ—ãƒ‹ãƒ³ã‚°æ›² TOP 10</h3><div id="opening-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ‘ ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«æ›² TOP 10</h3><div id="encore-songs" class="card-base bg-white p-2"></div></div>
    <div class="mb-5"><h3 class="font-bold mb-2 text-gray-700 text-base">ğŸ å¤§ãƒˆãƒªæ›² TOP 10</h3><div id="last-songs" class="card-base bg-white p-2"></div></div>
  </div>

  <div id="tab-records" class="tab-content" style="display:none">
    <div id="records-unregistered" class="card-base bg-white text-center py-10 hidden">
      <p class="text-gray-500 text-sm">
        ã“ã®æ©Ÿèƒ½ã¯ <a href="#" onclick="window.parent.postMessage({type: 'openMyLLDB'}, '*'); return false;" class="text-aiko-red underline font-bold">My LLDB</a> ã«ç™»éŒ²ã™ã‚‹ã¨ä½¿ãˆã‚‹ã‚ˆ
      </p>
    </div>

    <div id="records-content" class="hidden">
      <div class="mb-5">
        <h3 class="font-bold mb-2 text-gray-700 text-base flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4 text-aiko-red"></i> å¹´åˆ¥å‚æˆ¦å›æ•°</h3>
        <div class="card-base bg-white p-2">
          <canvas id="user-yearly-chart" style="height:220px; max-height:220px"></canvas>
        </div>
      </div>

      <div class="card-base bg-white border-0 p-4 mb-5 flex items-center justify-between overflow-hidden relative">
        <div class="flex-1">
          <h3 class="font-bold mb-3 text-gray-700 text-base flex items-center gap-2">
            <i data-lucide="award" class="w-4 h-4 text-aiko-red"></i> ã‚ãªãŸã®å‚æˆ¦å›æ•°: <span id="user-total-attended" class="text-lg text-aiko-red">0</span>
          </h3>
          <div id="user-category-counts" class="text-sm font-bold space-y-1"></div>
        </div>
        <div style="width: 100px; height: 100px;" class="flex-shrink-0">
          <canvas id="user-category-doughnut"></canvas>
        </div>
      </div>

      <div class="mb-3 flex items-center gap-2 px-1">
        <h3 class="font-bold text-gray-700 text-base flex items-center gap-2"><i data-lucide="music-2" class="w-4 h-4 text-aiko-red"></i> ã‚ãªãŸãŒè´ã„ãŸæ›²</h3>
      </div>

      <div class="card-base bg-white border-0 mb-4 p-3">
        <div class="flex gap-2 mb-3">
          <input type="text" id="record-song-search" placeholder="æ¥½æ›²åã§æ¤œç´¢" class="flex-1 px-3 bg-gray-50 border-gray-200" oninput="renderUserSongRanking()">
          <button onclick="document.getElementById('record-song-search').value=''; renderUserSongRanking()" class="action-btn clear-btn">ã‚¯ãƒªã‚¢</button>
        </div>
        <div class="flex justify-between items-center mb-2">
          <span class="text-gray-500 text-xs font-bold">å…¨æ¥½æ›²: <span id="user-total-songs" class="text-gray-800">0</span> æ›²</span>
          <div class="flex items-center gap-2">
            <span class="text-[12px] font-bold text-gray-500">ãƒ¡ãƒ‰ãƒ¬ãƒ¼è¾¼ã¿</span>
            <div class="relative inline-block align-middle select-none shrink-0">
              <input type="checkbox" id="user-medley-toggle" class="toggle-checkbox" checked onchange="renderUserSongRanking()" />
              <label for="user-medley-toggle" class="toggle-label" style="transform: scale(0.85);"></label>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end mb-3 px-1">
        <div class="flex gap-1 items-center shrink-0">
          <div onclick="switchUserSongSort('count')" class="flex items-center gap-0.5 bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-all">
            <span class="text-[11px] font-bold text-gray-600">è´ã„ãŸå›æ•°</span>
            <i id="user-sort-icon-count" data-lucide="chevron-down" class="w-3 h-3 text-aiko-red"></i>
          </div>
          <div onclick="switchUserSongSort('year')" class="flex items-center gap-0.5 bg-white px-2 py-1.5 rounded-lg shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-all">
            <span class="text-[11px] font-bold text-gray-600">(æœ€çµ‚å‚æˆ¦å¹´)</span>
            <i id="user-sort-icon-year" data-lucide="chevrons-up-down" class="w-3 h-3 text-gray-300"></i>
          </div>
        </div>
      </div>

      <div id="user-song-ranking-container"></div>
    </div>
  </div>
</main>

<div id="loading-container" style="position:fixed; top:0; left:0; width:100%; height:100%; background:#0f172a; z-index:9000; display:flex; align-items:center; justify-content:center;">
  <div class="text-center py-20 font-bold select-none text-white">
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-1" class="opacity-0">ç”·å­ãƒ¼!!</span> <span id="loading-text-2" class="opacity-0">å¥³å­ãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:42px; line-height:1.2;">
      <span id="loading-text-3" class="opacity-0">ãã†ã§ãªã„äººãƒ¼!!</span>
    </p>
    <p class="m-0 transition-opacity duration-300" style="font-size:56px; line-height:1.2; margin-top:16px;">
      <span id="loading-text-4" class="opacity-0">ãœãƒ¼</span><span id="loading-text-5" class="opacity-0">ã„ã‚“ã£...!!!</span>
    </p>
  </div>
</div>

<div id="modal-overlay" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

<div id="memo-modal" class="modal-overlay" style="display:none">
  <div class="modal-content">
    <span class="modal-close" onclick="closeMemoModal()">&times;</span>
    <h3 class="font-bold text-lg mb-4 text-gray-700">ğŸ“ å‚æˆ¦ãƒ¡ãƒ¢</h3>
    <div class="mb-6">
      <label class="block text-xs font-bold text-gray-500 mb-1">ã²ã¨ã“ã¨ãƒ¡ãƒ¢</label>
      <textarea id="memo-textarea" class="w-full p-3 border border-gray-300 rounded-lg text-sm h-40 focus:ring-2 focus:ring-aiko-red focus:border-transparent" placeholder="åº§å¸­ã€èª°ã¨è¡Œã£ãŸã‹ã€ãƒªãƒ³ã‚¯ãªã©..."></textarea>
    </div>
    <div class="flex gap-2">
      <button onclick="saveMemo()" class="flex-1 bg-[#E63946] text-white py-3 rounded-xl font-bold shadow">ä¿å­˜ã™ã‚‹</button>
      <button onclick="deleteMemo()" class="flex-none bg-gray-200 text-gray-600 py-3 px-4 rounded-xl font-bold">å‰Šé™¤</button>
    </div>
  </div>
</div>

<nav>
  <div class="flex w-full">
    <a href="#" class="tab-item active" data-tab="search"><i data-lucide="calendar-days"></i><span class="text-[10px] font-bold">å…¬æ¼”</span></a>
    <a href="#" class="tab-item" data-tab="song"><i data-lucide="music"></i><span class="text-[10px] font-bold">æ¥½æ›²</span></a>
    <a href="#" class="tab-item" data-tab="venue"><i data-lucide="map-pin"></i><span class="text-[10px] font-bold">å ´æ‰€</span></a>
    <a href="#" class="tab-item" data-tab="pattern"><i data-lucide="bar-chart-3"></i><span class="text-[10px] font-bold">å‚¾å‘</span></a>
    <a href="#" class="tab-item" data-tab="records"><i data-lucide="award"></i><span class="text-[10px] font-bold">è¨˜éŒ²</span></a>
  </div>
</nav>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec";
const CACHE_KEY = 'lldb_data_v4_4_records_fix';
const AIKO_BIRTH = new Date(1975, 10, 22);

let userUserData = { attendedLives: {} };
let appInitializedResolver, animationFinishedResolver;
const appInitializedPromise = new Promise(res => appInitializedResolver = res);
const animationFinishedPromise = new Promise(res => animationFinishedResolver = res);

document.addEventListener('DOMContentLoaded', () => {
  const CURRENT_VERSION = 'v4.4.8';
  const VERSION_KEY = 'lldb_installed_version';
  if (localStorage.getItem(VERSION_KEY) !== CURRENT_VERSION) {
    localStorage.clear();
    localStorage.setItem(VERSION_KEY, CURRENT_VERSION);
  }

  let isCachedLoaded = false;
  try { if (localStorage.getItem(CACHE_KEY)) isCachedLoaded = true; } catch (e) {}

  startLoadingAnimation(isCachedLoaded ? 'smart' : 'normal');
  try { lucide.createIcons(); setupRandomTriggers(); } catch(e) {}
  loadAllData(isCachedLoaded);

  Promise.all([appInitializedPromise, animationFinishedPromise]).then(() => finishLoading());
});

let allLiveRecords = [], songStats = {}, songStatsNoMedley = {}, songLastYears = {}, songLastYearsNoMedley = {}, songSortState = 'count-desc', patternStats = {}, albumData = [], songData = {}, chartInstances = {}, selectedVenueInfo = null, currentDisplayingRecord = null, lastScrollPosition = 0;

async function loadAllData(useCache = false) {
  if (useCache) {
    try {
      const cached = JSON.parse(localStorage.getItem(CACHE_KEY));
      if (cached) { initializeApp(cached); return; }
    } catch (e) {}
  }
  try {
    const res = await fetch(`${API_URL}?action=getAllData`);
    const data = await res.json();
    localStorage.setItem(CACHE_KEY, JSON.stringify(data));
    initializeApp(data);
  } catch (error) { handleError(error); }
}

function startLoadingAnimation(mode) {
  const delays = (mode === 'smart') 
    ? [{ id: 'loading-text-1', delay: 0 }, { id: 'loading-text-2', delay: 200 }, { id: 'loading-text-3', delay: 400 }, { id: 'loading-text-4', delay: 600 }, { id: 'loading-text-5', delay: 800 }]
    : [{ id: 'loading-text-1', delay: 1000 }, { id: 'loading-text-2', delay: 1900 }, { id: 'loading-text-3', delay: 2800 }, { id: 'loading-text-4', delay: 3800 }, { id: 'loading-text-5', delay: 4600 }];
  
  delays.forEach(item => {
    setTimeout(() => {
      const el = document.getElementById(item.id);
      if (el) el.classList.remove('opacity-0');
    }, item.delay);
  });
  setTimeout(() => animationFinishedResolver(), (mode === 'smart' ? 1200 : 5500));
}

function finishLoading() {
  startConfetti();
  document.getElementById('loading-container').classList.add('fade-out');
  setTimeout(() => { document.getElementById('loading-container').style.display = 'none'; }, 500);
  document.getElementById('main-content').style.opacity = '1';
}

function initializeApp(data) {
  allLiveRecords = data.liveRecords || [];
  albumData = data.albumData || [];
  songData = data.songData || {};
  
  const updateEl = document.getElementById('last-update-date');
  if (updateEl && data.lastUpdate) updateEl.textContent = data.lastUpdate;

  analyzeSongStats(allLiveRecords);
  analyzePatterns(allLiveRecords);
  populateFilters(allLiveRecords);
  setupEventListeners();
  applyFilters();
  
  renderLiveCountChart();
  renderAlbumChart();
  renderSongRanking(); 
  renderPatternStats();
  renderVenueRanking();
  renderVenueLiveCountChart();

  appInitializedResolver();
}

function analyzeSongStats(records) {
  songStats = {}; songStatsNoMedley = {}; songLastYears = {}; songLastYearsNoMedley = {};
  if (songData) {
    Object.keys(songData).forEach(name => {
      if (!name.includes('[') && !name.includes(']')) {
        songStats[name] = 0; songStatsNoMedley[name] = 0; songLastYears[name] = 0; songLastYearsNoMedley[name] = 0;
      }
    });
  }
  records.forEach(rec => {
    let inMedley = false;
    const yr = parseInt(rec.year);
    rec.setlist.forEach(s => {
      if (s === '__MEDLEY_START__') { inMedley = true; return; }
      if (s === '__MEDLEY_END__') { inMedley = false; return; }
      const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
      if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) {
        songStats[clean] = (songStats[clean] || 0) + 1;
        if (yr > (songLastYears[clean] || 0)) songLastYears[clean] = yr;
        if (!inMedley) {
          songStatsNoMedley[clean] = (songStatsNoMedley[clean] || 0) + 1;
          if (yr > (songLastYearsNoMedley[clean] || 0)) songLastYearsNoMedley[clean] = yr;
        }
      }
    });
  });
}

function analyzePatterns(records) {
  const o = {}, e = {}, l = {};
  records.forEach(rec => {
    const cleanSetlist = [];
    let inMedley = false;
    rec.setlist.forEach(s => {
      if (s === '__MEDLEY_START__') inMedley = true;
      else if (s === '__MEDLEY_END__') inMedley = false;
      else if (!inMedley) {
        const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
        if (clean && clean !== 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' && !clean.includes('[') && !clean.includes(']')) cleanSetlist.push(clean);
      }
    });
    if (cleanSetlist.length > 0) {
      o[cleanSetlist[0]] = (o[cleanSetlist[0]] || 0) + 1;
      l[cleanSetlist[cleanSetlist.length - 1]] = (l[cleanSetlist[cleanSetlist.length - 1]] || 0) + 1;
    }
    rec.setlist.forEach(s => {
      if (s.includes('_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«')) {
        const clean = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim();
        if (clean && !clean.includes('[') && !clean.includes(']')) e[clean] = (e[clean] || 0) + 1;
      }
    });
  });
  patternStats = { openingSongs: o, encoreSongs: e, lastSongs: l };
}

function populateFilters(records) {
  const ys = document.getElementById('year-select'), rs = document.getElementById('region-select');
  const years = new Set(), regions = new Set();
  records.forEach(r => { if (r.year) years.add(r.year); if (r.region) regions.add(r.region); });
  const opt = (s, data, suf) => {
    s.innerHTML = `<option value="">ã™ã¹ã¦ã®${suf}</option>` + 
      Array.from(data).sort((a,b) => suf === 'å¹´' ? b-a : a.localeCompare(b)).map(i => `<option value="${i}">${i}${suf==='å¹´'?'å¹´':''}</option>`).join('');
  };
  opt(ys, years, 'å¹´'); opt(rs, regions, 'éƒ½é“åºœçœŒ');
}

function applyFilters() {
  const search = document.getElementById('search-input').value.toLowerCase();
  const tour = document.getElementById('tour-select').value;
  const year = document.getElementById('year-select').value;
  const region = document.getElementById('region-select').value;
  const song = document.getElementById('song-filter-input').value.split('ã€€')[0].toLowerCase();
  const attendedOnly = document.getElementById('attended-filter-toggle').checked;

  const filtered = allLiveRecords.filter(rec => {
    if (attendedOnly && (!userUserData.attendedLives || !userUserData.attendedLives[rec.date])) return false;
    const tourName = rec.tourName.toLowerCase();
    const tMatch = !tour || (tour === 'pop' && tourName.includes('pop')) || (tour === 'rock' && tourName.includes('rock')) || (tour === 'aloha' && tourName.includes('aloha')) || (tour === 'other' && !/pop|rock|aloha/.test(tourName));
    const sMatch = !song || rec.setlist.some(s => s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«/g, '').replace(/#\d+$/g, '').trim().toLowerCase() === song);
    const searchMatch = !search || [rec.tourName, rec.venue, rec.region, rec.date].join(' ').toLowerCase().includes(search);
    return tMatch && sMatch && searchMatch && (!year || rec.year == year) && (!region || rec.region == region);
  });

  document.getElementById('display-count').textContent = filtered.length;
  document.getElementById('total-count').textContent = allLiveRecords.length;
  renderLiveList(filtered);
}

function renderLiveList(records) {
  const container = document.getElementById('live-list-container');
  container.innerHTML = records.length ? '' : '<p class="text-center text-gray-500 py-8 text-sm">è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
  records.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(rec => {
    const isAttended = userUserData.attendedLives && userUserData.attendedLives[rec.date];
    const card = document.createElement('div');
    card.className = 'card-base live-card cursor-pointer bg-white';
    card.innerHTML = `
      <div class="live-card-label ${rec.tourName.toLowerCase().includes('pop')?'pop':rec.tourName.toLowerCase().includes('rock')?'rock':'other'}">${rec.tourName.toLowerCase().includes('pop')?'POP':rec.tourName.toLowerCase().includes('rock')?'ROCK':'EVENT'}</div>
      <div class="flex items-center gap-2 mt-1">
        <p class="text-gray-500 font-medium text-xs">${rec.date}</p>
        ${isAttended ? '<span class="attended-badge"><i data-lucide="check" class="w-3 h-3"></i> å‚æˆ¦</span>' : ''}
      </div>
      <p class="font-bold mt-1 text-gray-800 text-lg leading-tight">${rec.tourName}</p>
      <p class="text-gray-600 text-sm mt-1">${rec.venue} (${rec.region})</p>`;
    card.onclick = () => showLiveDetail(rec);
    container.appendChild(card);
  });
  lucide.createIcons();
}

function showLiveDetail(rec) {
  lastScrollPosition = document.getElementById('app').scrollTop;
  document.body.classList.add('detail-view');
  currentDisplayingRecord = rec;
  document.querySelectorAll('.tab-content, nav').forEach(el => el.style.display = 'none');

  let backBtn = document.getElementById('back-button-fixed');
  if (!backBtn) {
    backBtn = document.createElement('div');
    backBtn.id = 'back-button-fixed';
    backBtn.className = 'back-button-circle';
    backBtn.innerHTML = '<i data-lucide="arrow-left"></i>';
    document.body.appendChild(backBtn);
    backBtn.onclick = hideDetailView;
  }
  backBtn.style.display = 'flex';

  const detail = document.getElementById('live-detail');
  detail.style.display = 'block';

  const isAttended = userUserData.attendedLives && userUserData.attendedLives[rec.date];
  const memo = isAttended ? userUserData.attendedLives[rec.date].memo : '';

  detail.innerHTML = `
    <div onclick="hideDetailView()" class="pt-2 pl-[70px] cursor-pointer">
      <h2 class="font-extrabold text-aiko-pink text-2xl leading-tight">${rec.tourName}</h2>
    </div>
    <div class="card-base bg-white mt-4">
      <p class="text-gray-500 text-xs font-semibold">é–‹å‚¬æ—¥</p><p class="font-bold text-lg">${rec.date} (${rec.dayOfWeek})</p>
      <div class="border-t my-3 border-gray-100"></div>
      <p class="text-gray-500 text-xs font-semibold">ä¼šå ´</p><p class="font-bold text-lg">${rec.venue} (${rec.region})</p>
    </div>
    <div class="attendance-toggle-container">
      <div class="attendance-toggle-label"><i data-lucide="${isAttended?'check-circle-2':'circle'}" class="w-5 h-5 ${isAttended?'text-green-600':'text-gray-300'}"></i><span>å‚æˆ¦è¨˜éŒ²</span></div>
      <div class="relative inline-block align-middle select-none">
        <input type="checkbox" id="detail-attendance-toggle" class="toggle-checkbox" ${isAttended?'checked':''} onchange="toggleAttendance(this.checked)"/>
        <label for="detail-attendance-toggle" class="toggle-label"></label>
      </div>
    </div>
    ${isAttended ? `<div class="user-memo-area clickable-item" onclick="openMemoModal()"><div class="memo-edit-btn">ç·¨é›†</div><div class="memo-content">${memo || 'ã‚¿ãƒƒãƒ—ã—ã¦ãƒ¡ãƒ¢ã‚’æ®‹ã™'}</div></div>` : ''}
    <div class="card-base bg-white mt-4"><h3 class="font-bold mb-3">ğŸµ ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆ</h3><div class="space-y-1">${rec.setlist.map((s,i) => s.startsWith('__') ? '' : `<div class="text-sm py-1 border-b border-gray-50">${s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«.*/,'')}</div>`).join('')}</div></div>`;
  
  lucide.createIcons();
  document.getElementById('app').scrollTop = 0;
}

function hideDetailView() {
  document.body.classList.remove('detail-view');
  document.getElementById('live-detail').style.display = 'none';
  document.getElementById('back-button-fixed').style.display = 'none';
  document.querySelector('nav').style.display = 'flex';
  applyFilters();
  const currentTab = document.querySelector('.tab-item.active').dataset.tab;
  document.getElementById(`tab-${currentTab}`).style.display = 'block';
  if (currentTab === 'search') document.getElementById('app').scrollTop = lastScrollPosition;
  currentDisplayingRecord = null;
}

function toggleAttendance(isChecked) {
  if (!userUserData.settings?.syncId) {
    document.getElementById('detail-attendance-toggle').checked = !isChecked;
    if(confirm('My LLDBã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚é–‹ãã¾ã™ã‹ï¼Ÿ')) window.parent.postMessage({ type: 'openMyLLDB' }, '*');
    return;
  }
  const dateId = currentDisplayingRecord.date;
  window.parent.postMessage({ type: 'updateUserLiveRecord', id: dateId, attended: isChecked, memo: (userUserData.attendedLives[dateId]?.memo || ''), link: '' }, '*');
  if(isChecked) { if(!userUserData.attendedLives[dateId]) userUserData.attendedLives[dateId] = {memo:''}; } else { delete userUserData.attendedLives[dateId]; }
  showLiveDetail(currentDisplayingRecord);
}

function openMemoModal() {
  document.getElementById('memo-textarea').value = userUserData.attendedLives[currentDisplayingRecord.date]?.memo || '';
  document.getElementById('memo-modal').style.display = 'flex';
}
function closeMemoModal() { document.getElementById('memo-modal').style.display = 'none'; }
function saveMemo() {
  const memo = document.getElementById('memo-textarea').value;
  userUserData.attendedLives[currentDisplayingRecord.date].memo = memo;
  window.parent.postMessage({ type: 'updateUserLiveRecord', id: currentDisplayingRecord.date, attended: true, memo: memo, link: '' }, '*');
  closeMemoModal();
  showLiveDetail(currentDisplayingRecord);
}
function deleteMemo() { if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) { document.getElementById('memo-textarea').value = ''; saveMemo(); } }

function switchToTab(tabId) {
  document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab-item[data-tab="${tabId}"]`).classList.add('active');
  document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
  document.getElementById(`tab-${tabId}`).style.display = 'block';
  if (tabId === 'records') renderRecordsTab();
  document.getElementById('app').scrollTop = 0;
  lucide.createIcons();
}

// --- è¨˜éŒ²ã‚¿ãƒ–å°‚ç”¨ãƒ­ã‚¸ãƒƒã‚¯ ---
let userSongSortState = 'count-desc';
function switchUserSongSort(key) {
  userSongSortState = userSongSortState.startsWith(key) ? (userSongSortState.endsWith('desc') ? key + '-asc' : key + '-desc') : key + '-desc';
  renderUserSongRanking();
}

function renderRecordsTab() {
  const isRegistered = userUserData.settings?.syncId;
  document.getElementById('records-unregistered').classList.toggle('hidden', !!isRegistered);
  document.getElementById('records-content').classList.toggle('hidden', !isRegistered);
  if (!isRegistered) return;

  const attendedDates = Object.keys(userUserData.attendedLives || {});
  const attendedRecords = allLiveRecords.filter(r => attendedDates.includes(r.date));
  document.getElementById('user-total-attended').textContent = attendedDates.length;

  const uYears = {}, cats = { pop: 0, rock: 0, aloha: 0, other: 0 }, uSongs = {};
  attendedRecords.forEach(rec => {
    uYears[rec.year] = (uYears[rec.year] || 0) + 1;
    const n = rec.tourName.toLowerCase();
    if (n.includes('pop')) cats.pop++; else if (n.includes('rock')) cats.rock++; else if (n.includes('aloha')) cats.aloha++; else cats.other++;
    
    let inM = false;
    rec.setlist.forEach(s => {
      if (s === '__MEDLEY_START__') { inM = true; return; }
      if (s === '__MEDLEY_END__') { inM = false; return; }
      const c = s.replace(/_ã‚¢ãƒ³ã‚³ãƒ¼ãƒ«.*/,'').trim();
      if (!c || c === 'ãƒ¡ãƒ‰ãƒ¬ãƒ¼' || c.includes('[')) return;
      if (!uSongs[c]) uSongs[c] = { count: 0, countNoM: 0, last: 0 };
      uSongs[c].count++;
      if(!inM) uSongs[c].countNoM++;
      if (parseInt(rec.year) > uSongs[c].last) uSongs[c].last = parseInt(rec.year);
    });
  });

  document.getElementById('user-category-counts').innerHTML = `<p class="text-pink-500">ãƒ» Pop: ${cats.pop}</p><p class="text-blue-500">ãƒ» Rock: ${cats.rock}</p><p class="text-yellow-500">ãƒ» Aloha: ${cats.aloha}</p>`;
  window.currentUserSongStats = uSongs;
  renderUserCharts(uYears, cats);
  renderUserSongRanking();
}

function renderUserCharts(uYears, cats) {
  const years = Object.keys(uYears).sort();
  if (chartInstances.userYearly) chartInstances.userYearly.destroy();
  chartInstances.userYearly = new Chart(document.getElementById('user-yearly-chart'), {
    type: 'bar',
    data: { labels: years, datasets: [{ data: years.map(y => uYears[y]), backgroundColor: '#FF69B4', borderRadius: 4 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
  });
  if (chartInstances.userCat) chartInstances.userCat.destroy();
  chartInstances.userCat = new Chart(document.getElementById('user-category-doughnut'), {
    type: 'doughnut',
    data: { datasets: [{ data: [cats.pop, cats.rock, cats.aloha, cats.other], backgroundColor: ['#FF69B4', '#3B82F6', '#EAB308', '#94A3B8'] }] },
    options: { cutout: '70%', plugins: { legend: { display: false } } }
  });
}

function renderUserSongRanking() {
  const container = document.getElementById('user-song-ranking-container');
  const search = document.getElementById('record-song-search').value.toLowerCase();
  const isM = document.getElementById('user-medley-toggle').checked;
  const stats = window.currentUserSongStats || {};

  const list = Object.entries(stats)
    .filter(([name]) => name.toLowerCase().includes(search))
    .map(([name, d]) => ({ name, count: isM ? d.count : d.countNoM, last: d.last }))
    .filter(i => i.count > 0)
    .sort((a,b) => userSongSortState.startsWith('count') ? (userSongSortState.endsWith('desc')?b.count-a.count:a.count-b.count) : (userSongSortState.endsWith('desc')?b.last-a.last:a.last-b.last));

  document.getElementById('user-total-songs').textContent = list.length;
  container.innerHTML = list.map((item, i) => `
    <div class="card-base p-3 mb-2 flex items-center bg-white" onclick="selectSong('${item.name.replace(/'/g, "\\'")}')">
      <span class="rank-number ${i<3?'text-aiko-pink':'text-gray-300'}">${i+1}</span>
      <span class="song-title">${item.name}</span>
      <span class="song-count">${item.count} <span>å›</span></span>
      <span class="text-[11px] text-gray-400 ml-2 w-14 text-right">(${item.last}å¹´)</span>
    </div>`).join('');
}

function selectSong(name) {
  document.getElementById('song-search-input').value = name;
  switchToTab('song');
  renderSongRanking();
}

function renderSongRanking() {
  const container = document.getElementById('song-ranking-container');
  const search = document.getElementById('song-search-input').value.toLowerCase();
  const isM = document.getElementById('medley-toggle').checked;
  const target = isM ? songStats : songStatsNoMedley;
  const sorted = Object.entries(target)
    .filter(([s]) => s.toLowerCase().includes(search))
    .sort((a,b) => b[1] - a[1]);
  container.innerHTML = sorted.map((item, i) => `<div class="card-base p-3 mb-2 flex items-center bg-white"><span class="rank-number ${i<3?'text-aiko-pink':'text-gray-300'}">${i+1}</span><span class="song-title">${item[0]}</span><span class="song-count">${item[1]} <span>å›</span></span></div>`).join('');
}

function updateSongSort(key) { songSortState = key + '-desc'; renderSongRanking(); }
function renderLiveCountChart() {} 
function renderAlbumChart() {}
function renderPatternStats() {}
function renderVenueRanking() {}
function renderVenueLiveCountChart() {}

function setupEventListeners() {
  ['search-input', 'tour-select', 'year-select', 'region-select'].forEach(id => document.getElementById(id).addEventListener('input', applyFilters));
  document.getElementById('clear-all-btn').onclick = () => { ['search-input', 'tour-select', 'year-select', 'region-select'].forEach(id => document.getElementById(id).value = ''); applyFilters(); };
  document.querySelectorAll('.tab-item').forEach(t => t.onclick = (e) => { e.preventDefault(); switchToTab(t.dataset.tab); });
}

function startConfetti() {
  const canvas = document.getElementById('confetti-canvas'), ctx = canvas.getContext('2d');
  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
  const ps = Array.from({length: 50}, () => ({ x: Math.random()*canvas.width, y: -20, r: Math.random()*5+2, color: ['#FF69B4','#FFD700','#00BFFF'][Math.floor(Math.random()*3)], vy: Math.random()*3+2 }));
  function animate() {
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ps.forEach(p => { p.y += p.vy; ctx.fillStyle = p.color; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, Math.PI*2); ctx.fill(); });
    if (ps.some(p => p.y < canvas.height)) requestAnimationFrame(animate);
  }
  animate();
}

function handleError(e) { console.error(e); }
function setupRandomTriggers() {}
function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

window.addEventListener('message', (e) => {
  if (e.data.type === 'userDataUpdated') { userUserData = e.data.data; applyFilters(); if(currentDisplayingRecord) showLiveDetail(currentDisplayingRecord); }
});
</script>
</body>
</html>
