<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="LLDB Song Helper">
    <meta name="application-name" content="LLDB Song Helper">
    
    <link rel="apple-touch-icon" href="https://unavatar.io/twitter/noki_dochibi">
    <link rel="icon" href="https://unavatar.io/twitter/noki_dochibi">

    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0D09G3X4F1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-0D09G3X4F1', { 'send_page_view': false });
    </script>

    <title>LLDB Song Helper</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* =========================================
           1. Base & Theme Colors
           ========================================= */
        :root {
            --bg-color: #F8F9FA;
            --main-orange: #F4A261;
            --main-pink: #ec4899;
            --bubble-color: #F4A261;
            --nav-height: 85px;
        }

        body { 
            font-family: 'Noto Sans JP', sans-serif; 
            background-color: var(--bg-color);
            transition: background-color 0.3s ease, color 0.3s ease; 
            overflow: hidden;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .send-btn-active:active { transform: scale(0.9); }
        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        
        .pulse-text { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }

        .message-row { scroll-margin-top: 6rem; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.25, 1, 0.5, 1) forwards; }

        .highlight-text {
            color: #ea580c;
            font-weight: bold;
            background-color: #fff7ed;
            padding: 0 2px;
            border-radius: 2px;
        }

        /* å¹ãå‡ºã— (Default) */
        .bubble { position: relative; border-radius: 1.2rem; transition: background-color 0.3s, color 0.3s; }
        
        .bubble-right::before {
            content: ""; position: absolute; top: 10px; right: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 0 6px 10px;
            border-color: transparent transparent transparent var(--bubble-color);
        }
        
        .bubble-left::before {
            content: ""; position: absolute; top: 10px; left: -8px; width: 0; height: 0;
            border-style: solid; border-width: 6px 10px 6px 0;
            border-color: transparent #ffffff transparent transparent;
        }

        /* =========================================
           2. Footer & Tabs
           ========================================= */
        footer {
            background-color: white;
            border-top: 1px solid #e5e7eb;
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 30;
            box-shadow: 0 -4px 6px -1px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            padding-bottom: 0;
            transition: transform 0.3s ease;
        }

        /* å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ */
        #search-form {
            padding: 10px 14px;
            background-color: rgba(255,255,255,0.98);
            border-bottom: 1px solid #f3f4f6;
            transition: height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
            overflow: hidden;
        }
        /* ä¸€è¦§ã‚¿ãƒ–è¡¨ç¤ºæ™‚ã¯ãƒ•ã‚©ãƒ¼ãƒ ã‚’éš ã™ã‚¯ãƒ©ã‚¹ */
        #search-form.hidden-form {
            height: 0;
            padding: 0;
            opacity: 0;
            border-bottom: none;
        }

        textarea#search-input {
            resize: none;
            overflow: hidden;
            min-height: 24px;
            max-height: 120px;
            line-height: 1.5;
            padding-top: 8px;
            padding-bottom: 8px;
        }
        textarea#search-input:focus { overflow-y: auto; }

        #footer-tab-area {
            display: flex;
            width: 100%;
            background-color: white;
            height: calc(var(--nav-height) + env(safe-area-inset-bottom));
            padding-bottom: env(safe-area-inset-bottom);
        }

        .tab-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 12px;
            gap: 4px;
            color: #94a3b8;
            background-color: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            height: 100%;
        }

        .tab-btn.active { font-weight: bold; color: var(--main-orange); }
        body.theme-shiritori .tab-btn.active { color: var(--main-pink); }
        .tab-btn.active svg { stroke-width: 2.5px; }

        /* Request UI */
        .letter-card {
            background: white; border-radius: 20px;
            border: 1px solid #f1f5f9; box-shadow: 0 4px 12px rgba(0,0,0,0.03);
            overflow: hidden; margin-bottom: 20px;
        }
        .letter-q { background-color: #fffaf5; padding: 16px; border-bottom: 1px dashed #fed7aa; }
        .letter-a { padding: 16px; background-color: white; }

        /* Dark Mode */
        body.dark-mode { background-color: #0f172a; color: #e2e8f0; }
        body.dark-mode footer { background-color: #1e293b; border-color: #334155; }
        body.dark-mode #search-form { background-color: #1e293b; border-bottom-color: #334155; }
        body.dark-mode .bubble-left { background-color: #334155; color: #f1f5f9; }
        body.dark-mode .bubble-left::before { border-color: transparent #334155 transparent transparent; }
        body.dark-mode .letter-card { background-color: #1e293b; border-color: #334155; }
        body.dark-mode .letter-q { background-color: #334155; border-bottom-color: #475569; }
        body.dark-mode .bg-gray-100 { background-color: #334155; }

        /* Shiritori Hints */
        .hint-btn {
            display: inline-flex; align-items: center; gap: 4px;
            background-color: rgba(236, 72, 153, 0.1); color: #ec4899;
            font-size: 11px; font-weight: bold; padding: 6px 12px;
            border-radius: 9999px; margin-top: 8px; cursor: pointer;
            border: 1px solid rgba(236, 72, 153, 0.2); transition: all 0.2s;
        }
        .hint-btn:active { transform: scale(0.95); background-color: rgba(236, 72, 153, 0.2); }
        .hint-list {
            display: none; flex-wrap: wrap; gap: 6px; margin-top: 10px;
            animation: fadeIn 0.3s ease-out;
        }
        .hint-item {
            background-color: #334155; color: #e2e8f0;
            padding: 6px 12px; border-radius: 8px; font-size: 12px;
            cursor: pointer; border: 1px solid #475569; transition: background-color 0.2s;
        }
        .hint-item:hover { background-color: #475569; }

        /* Modal Transitions */
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.2s ease-out, transform 0.2s ease-out; }
    </style>
</head>
<body id="app-body" class="theme-lyrics h-screen flex flex-col transition-colors duration-300">

    <main id="chat-container-lyrics" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>aikoã®æ›²ã‹ã‚‰æ¢ã—ã¦ãã‚‹ã‚ˆï¼
                </p>
            </div>
        </div>
    </main>

    <main id="chat-container-title" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">
                    æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ã­ã€‚<br>ãƒªãƒªãƒ¼ã‚¹æƒ…å ±ã‚„åéŒ²æ›²é †ã‚’æ•™ãˆã‚‹ã‚ˆğŸ’¿
                </p>
            </div>
        </div>
    </main>

    <main id="container-list" class="flex-1 overflow-hidden relative hidden bg-white">
        <div id="filter-bar" class="hidden px-4 py-2 bg-orange-50 border-b border-orange-100 flex items-center justify-between text-xs text-orange-700">
            <span id="active-filter-count">ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨ä¸­</span>
            <button onclick="clearAllFilters()" class="text-orange-600 underline font-medium">å…¨ãƒ•ã‚£ãƒ«ã‚¿è§£é™¤</button>
        </div>

        <div class="h-full overflow-auto pb-32"> 
            <!-- table-fixed ã«å¤‰æ›´ã—ã€å„ã‚«ãƒ©ãƒ ã®å¹…ã‚’å³å¯†ã«æŒ‡å®š -->
            <table class="w-full text-left border-collapse table-fixed">
                <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm text-xs text-gray-500 uppercase font-semibold">
                    <tr>
                        <th class="w-[7%] p-1 text-center text-gray-400 align-middle">
                            #
                        </th>
                        <th onclick="openFilterModal('era')" class="w-[30%] p-1 whitespace-nowrap cursor-pointer hover:bg-gray-100 active:bg-gray-200 transition-colors align-middle">
                            <div class="flex items-center gap-1">æ™‚æœŸ <i id="icon-filter-era" data-lucide="filter" class="w-3 h-3 text-gray-300 transition-colors flex-shrink-0"></i></div>
                        </th>
                        <th onclick="openFilterModal('title')" class="w-[33%] p-1 whitespace-nowrap cursor-pointer hover:bg-gray-100 active:bg-gray-200 transition-colors align-middle">
                            <div class="flex items-center gap-1">æ›²å <i id="icon-filter-title" data-lucide="filter" class="w-3 h-3 text-gray-300 transition-colors flex-shrink-0"></i></div>
                        </th>
                        <th onclick="openFilterModal('arranger')" class="w-[17%] p-1 whitespace-nowrap cursor-pointer hover:bg-gray-100 active:bg-gray-200 transition-colors align-middle">
                            <div class="flex items-center gap-1">ç·¨æ›² <i id="icon-filter-arranger" data-lucide="filter" class="w-3 h-3 text-gray-300 transition-colors flex-shrink-0"></i></div>
                        </th>
                        <th onclick="openFilterModal('duration')" class="w-[13%] p-1 text-right whitespace-nowrap cursor-pointer hover:bg-gray-100 active:bg-gray-200 transition-colors align-middle">
                            <div class="flex items-center justify-end gap-1">æ™‚é–“ <i id="icon-filter-duration" data-lucide="filter" class="w-3 h-3 text-gray-300 transition-colors flex-shrink-0"></i></div>
                        </th>
                    </tr>
                </thead>
                <tbody id="song-list-body" class="text-sm divide-y divide-gray-100">
                </tbody>
            </table>
            <div id="list-loading" class="text-center py-20 text-gray-400 text-xs">
                ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    </main>

    <main id="chat-container-request" class="flex-1 overflow-y-auto p-4 no-scrollbar pb-48 hidden">
        <div class="mb-6">
            <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                <span class="text-2xl">ğŸ“‹</span> ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
            </h2>
            <div class="bg-orange-50 border border-orange-100 rounded-xl p-3 mt-3 flex items-start gap-2">
                <i data-lucide="shield-check" class="w-4 h-4 text-orange-500 mt-0.5 flex-shrink-0"></i>
                <p class="text-[11px] text-orange-700 leading-relaxed">
                    Song HelperãŒèª¿æŸ»ä¾é ¼ã‚„æ”¹å–„è¦æœ›ã€è³ªå•ãªã©ã«ç­”ãˆã‚‹ã‚ˆã€‚æ¥½ã—ãä½¿ã£ã¦ã„ãŸã ããŸã‚ã«ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ²è¼‰ã—ãªã„å ´åˆã‚‚ã‚ã‚‹ã‚ˆğŸŒ¸
                </p>
            </div>
        </div>
        <div id="request-list" class="space-y-4">
            <div class="text-center py-10 text-gray-400 text-xs animate-pulse" id="request-loading">
                ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...
            </div>
        </div>
    </main>

    <main id="chat-container-shiritori" class="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar pb-48 hidden"> 
        <div class="flex items-start space-x-2">
            <img class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()" alt="icon">
            <div class="bubble bubble-left bg-white p-3 shadow-sm max-w-[80%]">
                <p class="text-sm leading-relaxed">ã•ãã€ã—ã‚Šã¨ã‚Šã®æ™‚é–“ã ã€‚<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã¿ã‚ˆã€‚</p>
            </div>
        </div>
    </main>

    <footer>
        <form id="search-form">
            <div class="relative flex items-end w-full bg-gray-100 rounded-[24px] px-4 py-1 focus-within:bg-white focus-within:ring-1 focus-within:ring-orange-200 border border-transparent focus-within:border-orange-300 transition-all shadow-inner">
                <textarea id="search-input" rows="1"
                    class="flex-1 bg-transparent border-none focus:outline-none text-[15px] placeholder-gray-400 min-w-0"
                    placeholder="ä¾‹ï¼šã‚ã‚Œã¯" required autocomplete="off"></textarea>
                <button type="submit" id="submit-btn"
                    class="send-btn-active ml-2 text-orange-500 p-1.5 rounded-full hover:bg-orange-100 transition-colors flex-shrink-0 mb-1.5">
                    <i data-lucide="send" class="w-5 h-5 fill-current"></i>
                </button>
            </div>
        </form>

        <div id="footer-tab-area">
            <button id="tab-lyrics" data-tab="lyrics" onclick="switchTab('lyrics')" class="tab-btn active">
                <i data-lucide="music" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒ•ãƒ¬ãƒ¼ã‚º</span>
            </button>
            <div class="w-[1px] bg-gray-50 my-3"></div>
            <button id="tab-title" data-tab="title" onclick="switchTab('title')" class="tab-btn">
                <i data-lucide="disc" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">æ¥½æ›²</span>
            </button>
            <div class="w-[1px] bg-gray-50 my-3"></div>
            <button id="tab-list" data-tab="list" onclick="switchTab('list')" class="tab-btn">
                <i data-lucide="list-music" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ä¸€è¦§</span>
            </button>
            <div class="w-[1px] bg-gray-50 my-3"></div>
            <button id="tab-request" data-tab="request" onclick="switchTab('request')" class="tab-btn">
                <i data-lucide="clipboard-list" class="w-6 h-6"></i>
                <span class="text-[10px] font-bold">ãƒªã‚¯ã‚¨ã‚¹ãƒˆ</span>
            </button>
        </div>
    </footer>

    <!-- Filter Modal -->
    <div id="filter-modal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeFilterModal()"></div>
        <div class="absolute bottom-0 left-0 right-0 bg-white rounded-t-2xl max-h-[85vh] flex flex-col shadow-xl transform transition-transform duration-300 translate-y-full" id="filter-modal-content">
            <!-- Header -->
            <div class="bg-orange-400 p-4 rounded-t-2xl flex items-center gap-3 text-white">
                <img class="bot-icon w-10 h-10 rounded-full border-2 border-white bg-white flex-shrink-0" alt="icon">
                <div>
                    <p id="filter-helper-msg" class="font-bold text-sm">ç·¨æ›²è€…ã‚’é¸ã‚“ã§ã­ï¼</p>
                    <p class="text-xs opacity-90">è¤‡æ•°é¸æŠã§ãã‚‹ã‚ˆ</p>
                </div>
                <button onclick="closeFilterModal()" class="ml-auto p-1 hover:bg-white/20 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <!-- Tools Bar -->
            <div class="flex items-center justify-between px-4 py-2 border-b border-gray-100 bg-gray-50 text-xs">
                <span class="font-bold text-gray-500" id="filter-column-name">COLUMN</span>
                <div class="flex gap-3">
                    <button onclick="toggleAllFilters(true)" class="text-orange-500 font-medium">å…¨é¸æŠ</button>
                    <button onclick="toggleAllFilters(false)" class="text-gray-500">å…¨è§£é™¤</button>
                </div>
            </div>

            <!-- Sort Buttons -->
            <div class="px-4 py-3 border-b border-gray-100 flex gap-2 justify-center bg-white">
                <button onclick="applySort('asc')" class="flex-1 py-2 px-3 bg-gray-50 hover:bg-orange-50 text-gray-600 hover:text-orange-600 rounded-lg text-xs font-bold border border-gray-200 transition flex items-center justify-center gap-2">
                    <i data-lucide="arrow-up" class="w-3 h-3"></i> æ˜‡é †
                </button>
                <button onclick="applySort('desc')" class="flex-1 py-2 px-3 bg-gray-50 hover:bg-orange-50 text-gray-600 hover:text-orange-600 rounded-lg text-xs font-bold border border-gray-200 transition flex items-center justify-center gap-2">
                    <i data-lucide="arrow-down" class="w-3 h-3"></i> é™é †
                </button>
            </div>
            
            <!-- List Content -->
            <div id="filter-options-list" class="flex-1 overflow-y-auto p-2 space-y-1">
            </div>

            <!-- OK Button -->
            <div class="p-4 border-t border-gray-100 bg-white pb-safe">
                <button onclick="applyFilter()" class="w-full bg-orange-500 text-white font-bold py-3 rounded-xl shadow hover:bg-orange-600 active:scale-95 transition-transform">
                    OK
                </button>
            </div>
        </div>
    </div>

    <!-- Readme Modal -->
    <div id="readme-modal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="toggleModal(false)"></div>
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white w-[90%] max-w-sm rounded-2xl shadow-xl p-6 transition-all scale-100">
            <div class="flex justify-between items-start mb-4 border-b border-gray-50 pb-3">
                <h2 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                    <span class="bg-orange-100 text-orange-500 p-1.5 rounded-lg">ğŸŒ·</span>
                    About App
                </h2>
                <button onclick="toggleModal(false)" class="text-gray-400 hover:text-gray-600 p-1 bg-gray-50 rounded-full">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div class="space-y-6 text-sm text-gray-600 leading-relaxed overflow-y-auto max-h-[60vh] px-1 pb-2 no-scrollbar">
                <div class="text-center mb-2">
                    <p class="text-[10px] font-bold text-orange-400 tracking-widest mb-1">WELCOME</p>
                    <p class="text-gray-700 font-medium">ãŠèŠ±ã¡ã‚ƒã‚“ã®ãŸã‚ã®<br>ãƒã‚±ãƒƒãƒˆè¾æ›¸ã§ã™ğŸŒ·</p>
                </div>
                <div class="space-y-4">
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="music" class="w-4 h-4"></i> ãƒ•ãƒ¬ãƒ¼ã‚ºã‹ã‚‰æ¢ã™</h3>
                        <p class="text-xs leading-5">èª¿ã¹ãŸã„ãƒ•ãƒ¬ãƒ¼ã‚ºã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®æ­Œè©ãŒå«ã¾ã‚Œã‚‹æ›²ã‚’æ¢ã—ã¾ã™ã€‚</p>
                    </div>
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="disc" class="w-4 h-4"></i> æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã‚’è¦‹ã‚‹</h3>
                        <p class="text-xs leading-5">æ›²åã‚„ã‚¢ãƒ«ãƒãƒ åã‹ã‚‰ã€è©³ç´°ãªæƒ…å ±ã‚’æ•™ãˆã¾ã™ã€‚</p>
                    </div>
                    <div class="bg-orange-50/50 p-4 rounded-xl border border-orange-100">
                        <h3 class="font-bold text-orange-600 flex items-center gap-2 mb-2"><i data-lucide="list-music" class="w-4 h-4"></i> ä¸€è¦§ãƒªã‚¹ãƒˆ (New)</h3>
                        <p class="text-xs leading-5">å…¨æ›²ãƒªã‚¹ãƒˆã‚’è¡¨ç¤ºã€‚æ™‚æœŸã‚„ç·¨æ›²è€…ãªã©ã§çµã‚Šè¾¼ã¿ãŒã§ãã¾ã™ã€‚</p>
                    </div>
                </div>
                <div class="text-center pt-6 border-t border-gray-100">
                    <p class="text-[10px] text-gray-400 mb-2">Developed by @noki_dochibi</p>
                    <p class="text-[10px] text-gray-300 mt-4 font-mono tracking-wider">v2.3.1</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirm Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm transition-opacity" onclick="closeConfirmModal()"></div>
        <div class="bg-white rounded-2xl shadow-xl p-6 w-[85%] max-w-sm relative transform transition-all scale-100 animate-fade-in">
            <div class="flex flex-col items-center text-center gap-3">
                <div class="w-12 h-12 rounded-full bg-orange-100 flex items-center justify-center">
                    <i data-lucide="search" class="w-6 h-6 text-orange-500"></i>
                </div>
                <h3 class="font-bold text-gray-800 text-lg">èª¿ã¹ã¦ã¿ã‚‹ï¼Ÿ</h3>
                <p class="text-sm text-gray-600 leading-relaxed">
                    ã€Œ<span id="confirm-song-title" class="font-bold text-orange-600"></span>ã€<br>ã«ã¤ã„ã¦è©³ã—ãæ¤œç´¢ã—ã¾ã™ã‹ï¼Ÿ
                </p>
                <div class="flex gap-3 w-full mt-2">
                    <button onclick="closeConfirmModal()" class="flex-1 py-2.5 rounded-xl bg-gray-100 text-gray-600 font-bold text-sm">ã‚„ã‚ã‚‹</button>
                    <button onclick="executeSearchFromList()" class="flex-1 py-2.5 rounded-xl bg-orange-500 text-white font-bold text-sm shadow-md">ã¯ã„</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-gray-800/80 backdrop-blur text-white text-xs py-2 px-4 rounded-full opacity-0 transition-opacity duration-300 pointer-events-none z-50 shadow-lg">
        ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼
    </div>

    <script>
        const APP_VERSION = 'v2.3.1';
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbzy7CNn83anQMEsvNxyK3zHMtTRtjHk6XZ-jWBNllRNxcXv41hKw-TenGoGjfpps6rLUw/exec"; 
        const ICON_URL = `https://unavatar.io/twitter/noki_dochibi?v=${APP_VERSION}`;

        let currentMode = 'lyrics'; 
        let lastMode = 'lyrics'; 
        let isDarkMode = false; 
        
        // List Mode State
        let allSongs = [];
        let filteredSongs = [];
        let activeFilters = { era: [], title: [], arranger: [], duration: [] };
        let currentFilterColumn = '';
        let currentSort = { column: null, order: 'asc' }; // ã‚½ãƒ¼ãƒˆçŠ¶æ…‹
        let targetSongForSearch = ''; // æ¤œç´¢å¯¾è±¡ã®ä¸€æ™‚ä¿å­˜ç”¨

        const LOADING_MESSAGES = {
            lyrics: ["aikoã‹ã‚‰ã®telepathyã‚’å—ä¿¡ä¸­...", "ãã‚“ãªã“ã¨ã‚ˆã‚Šãƒ‘ãƒ¼ãƒ†ã‚£æŠœã‘å‡ºã•ãªã„ï¼Ÿ"],
            title: ["ãŠã£ï¼ãã®æ›²ãªã‚‰ç¢ºã‹ã­...", "ä¿ºã‚‚ãã‚Œå¥½ãã ã‚ˆï¼å¾…ã£ã¦ã¦..."],
            shiritori: ["ä¿ºã«å‹è² ã‚’ä»•æ›ã‘ã‚‹ã¨ã¯ã„ã„åº¦èƒ¸ã ã€‚", "ãªã‚‹ã»ã©ã€ãã†æ¥ãŸã‹..."],
            request: ["ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å—ã‘ä»˜ã‘ã¦ã„ã¾ã™ğŸ“®"],
            list: ["ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™..."]
        };

        const dom = {
            body: document.getElementById('app-body'),
            containers: {
                lyrics: document.getElementById('chat-container-lyrics'),
                title: document.getElementById('chat-container-title'),
                request: document.getElementById('chat-container-request'),
                shiritori: document.getElementById('chat-container-shiritori'),
                list: document.getElementById('container-list')
            },
            searchForm: document.getElementById('search-form'),
            searchInput: document.getElementById('search-input'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('readme-modal'),
            tabBtns: document.querySelectorAll('.tab-btn'),
            botIcons: document.querySelectorAll('.bot-icon'),
            requestList: document.getElementById('request-list'),
            footerTabs: document.getElementById('footer-tab-area')
        };

        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            dom.botIcons.forEach(img => img.src = ICON_URL);
            fetchRequests(); 
            setupAutoResizeTextarea();
        });

        function setupAutoResizeTextarea() {
            const el = dom.searchInput;
            el.addEventListener('input', () => {
                el.style.height = 'auto'; 
                el.style.height = (el.scrollHeight) + 'px';
            });
        }

        function resetTextareaHeight() {
            const el = dom.searchInput;
            el.style.height = 'auto';
        }

        window.switchTab = function(mode) {
            if (currentMode === mode) return;
            currentMode = mode;
            
            dom.tabBtns.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === mode);
            });

            Object.keys(dom.containers).forEach(key => {
                dom.containers[key].classList.toggle('hidden', key !== mode);
            });

            if (mode === 'shiritori') {
                document.documentElement.style.setProperty('--bubble-color', '#ec4899');
            } else {
                document.documentElement.style.setProperty('--bubble-color', '#F4A261');
            }

            // ãƒ¢ãƒ¼ãƒ‰ã”ã¨ã®ãƒ•ã‚©ãƒ¼ãƒ åˆ¶å¾¡
            if (mode === 'list') {
                dom.searchForm.classList.add('hidden-form'); // ãƒ•ã‚©ãƒ¼ãƒ éš ã™
                if (allSongs.length === 0) loadSongsData(); // åˆå›ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ‰
            } else {
                dom.searchForm.classList.remove('hidden-form'); // ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
                if (mode === 'lyrics') {
                    dom.searchInput.placeholder = "ä¾‹ï¼šã‚ã‚Œã¯";
                } else if (mode === 'title') {
                    dom.searchInput.placeholder = "ä¾‹ï¼šãƒãƒ‹ãƒ¼ãƒ†ãƒ¼ãƒ«";
                } else if (mode === 'request') {
                    dom.searchInput.placeholder = "èª¿æŸ»ã‚„æ”¹å–„ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ›¸ã„ã¦ã­ğŸ“®";
                    fetchRequests();
                } else if (mode === 'shiritori') {
                    dom.searchInput.placeholder = "æ›²åã‚’å…¥åŠ›ã—ã¦ã­";
                }
                
                const activeContainer = dom.containers[mode];
                if (mode === 'request') {
                    activeContainer.scrollTop = 0;
                } else {
                    activeContainer.scrollTop = activeContainer.scrollHeight;
                }
            }
        };

        window.activateSecretMode = function() {
            if (currentMode === 'shiritori') {
                isDarkMode = false;
                dom.body.classList.remove('dark-mode');
                dom.body.classList.remove('theme-shiritori');
                dom.body.classList.add('theme-lyrics');
                dom.footerTabs.style.display = 'flex';
                switchTab(lastMode);
            } else {
                safeTrackEvent('unlock_achievement', { achievement_id: 'secret_mode_activated' });
                lastMode = currentMode;
                isDarkMode = true;
                dom.body.classList.add('dark-mode');
                dom.body.classList.remove('theme-lyrics');
                dom.body.classList.add('theme-shiritori');
                dom.footerTabs.style.display = 'none';
                switchTab('shiritori');
            }
        };

        window.restartShiritori = function() {
            addMessage("æœ›ã‚€ã¨ã“ã‚ã ï¼<br>æœ€åˆã®æ›²åã‚’å…¥åŠ›ã—ã¦ã¿ã‚ˆã€‚", 'bot', true);
            dom.searchInput.focus();
        };

        dom.searchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const query = dom.searchInput.value.trim();
            if (!query) return;

            safeTrackEvent('search', { search_term: query, search_category: currentMode });

            if (currentMode === 'request') {
                if (!confirm("ã“ã®å†…å®¹ã§é€ä¿¡ã—ã¾ã™ã‹ï¼Ÿ")) return;
                handleRequestPost(query);
                dom.searchInput.value = '';
                resetTextareaHeight(); 
                return;
            }

            addMessage(query, 'user');
            dom.searchInput.value = '';
            resetTextareaHeight(); 
            const loadingId = addLoading();

            try {
                const response = await fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=${currentMode}`);
                const data = await response.json();
                removeLoading(loadingId);

                if (data.status === 'success') {
                    if (currentMode === 'lyrics') handleLyricsResults(data);
                    else if (currentMode === 'title') handleTitleResults(data);
                    else handleShiritoriResults(data);
                } else {
                    addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„...", 'bot');
                }
            } catch (error) {
                removeLoading(loadingId);
                addMessage("é€šä¿¡å¤±æ•—ï¼ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
                safeTrackEvent('exception', { description: error.message, fatal: false });
            }
        });

        window.sendShiritoriAnswer = function(answer) {
             const query = answer;
             if (!query) return;
             addMessage(query, 'user');
             const loadingId = addLoading();
             dom.searchInput.value = '';
             resetTextareaHeight();
             fetch(`${GAS_API_URL}?q=${encodeURIComponent(query)}&mode=shiritori`)
                .then(res => res.json())
                .then(data => {
                    removeLoading(loadingId);
                    if (data.status === 'success') handleShiritoriResults(data);
                    else addMessage("ã”ã‚ã‚“ã­ã€ã†ã¾ãæ¢ã›ãªã‹ã£ãŸã¿ãŸã„...", 'bot');
                })
                .catch(err => {
                    removeLoading(loadingId);
                    addMessage("é€šä¿¡å¤±æ•—ï¼ã‚‚ã†ä¸€åº¦è©¦ã—ã¦ã¿ã¦ï¼", 'bot');
                    safeTrackEvent('exception', { description: err.message, fatal: false });
                });
        };

        async function handleRequestPost(query) {
            const card = document.createElement('div');
            card.className = "letter-card animate-fade-in border-dashed bg-orange-50/20";
            card.innerHTML = `
                <div class="letter-q bg-transparent border-none">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">ç¢ºèªä¸­</span>
                        <span class="text-[10px] text-gray-400">ãŸã ã„ã¾</span>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed font-bold">${query.replace(/\n/g, '<br>')}</p>
                    <p class="text-[10px] text-gray-400 mt-2 italic">â€»ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚å†…å®¹ã‚’ç¢ºèªã—ãŸå¾Œã«å…¨ä½“ã¸å…¬é–‹ã•ã‚Œã¾ã™ğŸŒ¸</p>
                </div>
            `;
            dom.requestList.insertBefore(card, dom.requestList.firstChild);
            showToast("ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã£ãŸã‚ˆï¼ğŸ“®");
            dom.containers.request.scrollTop = 0;

            try {
                await fetch(`${GAS_API_URL}?action=postRequest&q=${encodeURIComponent(query)}`);
            } catch(e) { 
                console.error("Post failed", e); 
                safeTrackEvent('exception', { description: "postRequest: " + e.message, fatal: false });
            }
        }

        async function fetchRequests() {
            try {
                const res = await fetch(`${GAS_API_URL}?action=getRequests`);
                const json = await res.json();
                if (json.status === 'success') renderRequests(json.data);
            } catch(e) { 
                console.error("Fetch failed", e); 
                safeTrackEvent('exception', { description: "fetchRequests: " + e.message, fatal: false });
            }
        }

        function renderRequests(data) {
            if (data.length === 0) {
                dom.requestList.innerHTML = '<p class="text-center py-10 text-gray-400 text-xs">ã¾ã ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                return;
            }
            dom.requestList.innerHTML = data.map(item => `
                <div class="letter-card animate-fade-in">
                    <div class="letter-q">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="text-[10px] font-bold bg-orange-100 text-orange-600 px-2 py-0.5 rounded-full">æ²è¼‰ä¸­</span>
                            <span class="text-[10px] text-gray-400">${item.date}</span>
                        </div>
                        <p class="text-sm text-gray-700 leading-relaxed font-bold">${item.question.replace(/\n/g, '<br>')}</p>
                    </div>
                    <div class="letter-a">
                        <div class="flex items-start gap-3">
                            <img src="${ICON_URL}" class="w-8 h-8 rounded-full border border-gray-100">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-[10px] font-bold text-gray-800">Song Helper</span>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">
                                    ${item.answer ? item.answer.replace(/\n/g, '<br>') : '<span class="text-gray-300 italic">å›ç­”ã‚’ãŠå¾…ã¡ãã ã•ã„...ğŸŒ¸</span>'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            dom.containers.request.scrollTop = 0;
        }

        function handleLyricsResults(data) {
            if (!data.results || data.results.length === 0) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­Œè©ã‚«ãƒ¼ãƒ‰ã¨åŒã˜è¡¨è¨˜ã«ã—ã¦ã¿ã¦ï¼`, 'bot');
                return;
            }
            let html = '<div class="flex flex-col animate-fade-in">';
            if (data.fuzzy_type) {
                html += `<div class="bg-orange-100/50 border border-orange-200 rounded-lg p-2.5 mb-3 text-xs text-orange-700">
                    ã€Œ<span class="font-bold">${data.query}</span>ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‘ã©ã€<br>
                    ã€Œ<span class="font-bold text-orange-600">${data.actual_query}</span>ã€ã§è¦‹ã¤ã‹ã£ãŸã‚ˆï¼ (${data.fuzzy_type})
                </div>`;
            }
            const highlightWord = data.fuzzy_type ? data.actual_query : data.query;
            data.results.forEach((item, index) => {
                const borderClass = index < data.results.length - 1 ? 'border-b border-dashed border-gray-100' : '';
                const highlighted = item.phrase.replace(new RegExp(`(${highlightWord})`, 'gi'), '<span class="highlight-text">$1</span>');
                html += `<div onclick="copyToClipboard('${item.display_text.replace(/'/g, "\\'")}')" class="${borderClass} py-3 cursor-pointer hover:bg-orange-50/30 transition select-none">
                    <p class="text-sm text-gray-700 leading-relaxed">${highlighted} <span class="text-xs text-gray-400 ml-1">ï¼ˆ${item.title}ï¼‰</span></p>
                </div>`;
            });
            const uniqueSongs = new Set(data.results.map(item => item.title)).size;
            html += `<div class="mt-3 pt-2 border-t border-dashed border-orange-200">
                <div class="flex justify-between items-center mb-2">
                    <p class="text-[10px] text-gray-400 font-bold">${uniqueSongs}æ›² / è¨ˆ${data.results.length}ç®‡æ‰€</p>
                    <button onclick="copyToClipboard('${data.results.map(r=>r.display_text).join('\\n').replace(/'/g,"\\'")}')" class="text-[10px] text-orange-500 bg-orange-50 px-2 py-1 rounded-full border border-orange-100">ã¾ã¨ã‚ã¦ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div class="flex justify-center">
                    <button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button>
                </div>
            </div></div>`;
            addMessage(html, 'bot', true);
            lucide.createIcons();
        }

        function handleTitleResults(data) {
             if ((!data.songs || data.songs.length === 0) && (!data.albums || data.albums.length === 0)) {
                addMessage(`ã€Œ${data.query}ã€ã¯è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸã‚ˆã€‚æ­£å¼åç§°ã§æ•™ãˆã¦ã­ï¼`, 'bot');
                return;
            }
            let html = '<div class="flex flex-col gap-4 animate-fade-in">';
            if (data.songs && data.songs.length > 0) {
                if (data.albums && data.albums.length > 0) html += '<div class="text-xs font-bold text-orange-500 border-b border-orange-100 pb-1">ğŸµ æ›²ã®æ¤œç´¢çµæœ</div>';
                data.songs.forEach((song, idx) => {
                    const hasDivider = idx > 0 ? 'border-t border-orange-100 pt-4' : '';
                    const ageText = song.age_at_release ? `ãƒªãƒªãƒ¼ã‚¹æ™‚ã®aikoã¯<span class="font-bold text-orange-600">${song.age_at_release}æ­³</span>ã ã‚ˆã€‚` : '';
                    const songLink = song.link_url ? `<a href="${song.link_url}" target="_blank" class="text-orange-600 underline font-bold hover:text-orange-400">${song.title}</a>` : `<span class="font-bold text-gray-800">${song.title}</span>`;
                    
                    html += `<div class="${hasDivider}">
                        <div class="mb-2 text-base">${songLink} <span class="text-xs text-gray-400">(${song.reading || ''})</span></div>
                        <div class="text-sm text-gray-700 space-y-2 leading-relaxed bg-orange-50/50 p-3 rounded-lg border border-orange-100">
                            ${song.single_info ? `<p>ğŸ’¿ ${song.single_info}</p>` : ''}
                            ${song.album_info ? `<p>ğŸ’¿ ${song.album_info}</p>` : '<p class="text-gray-300 italic">ğŸ’¿ ã‚¢ãƒ«ãƒãƒ æœªåéŒ²</p>'}
                            <div class="pt-2 border-t border-orange-100 text-xs text-gray-600">
                                <p>ğŸ¼ ç·¨æ›²ï¼š${song.arranger || 'ä¸æ˜'}</p>
                                <p>â± å†ç”Ÿæ™‚é–“ï¼š${song.duration || 'ä¸æ˜'}</p>
                                <p>ğŸ¥ BPMï¼š${song.bpm || 'ç¢ºèªä¸­'}</p>
                            </div>
                            <p class="pt-1 text-xs text-orange-700 font-medium">${ageText}</p>
                        </div>
                    </div>`;
                });
            }
            if (data.albums && data.albums.length > 0) {
                if (data.songs && data.songs.length > 0) html += '<div class="text-xs font-bold text-orange-500 border-b border-orange-100 pb-1">ğŸ’¿ åéŒ²ãƒ‡ã‚£ã‚¹ã‚¯æƒ…å ±</div>';
                data.albums.forEach((disk) => {
                    const songList = disk.songs.map((s, i) => `<li class="py-1 border-b border-orange-50 last:border-0 flex gap-2"><span class="text-orange-400 w-6 text-right font-mono text-xs pt-0.5">${s.order}.</span><span>${s.title}</span></li>`).join('');
                    html += `<div class="bg-orange-50/50 rounded-xl p-4 border border-orange-100">
                        <h3 class="font-bold text-orange-700 mb-1">ğŸ’¿ ${disk.disk_name}</h3>
                        <p class="text-xs text-gray-500 mb-3">${disk.release_date} ç™ºå£²</p>
                        <ul class="text-sm text-gray-700 list-none">${songList}</ul>
                    </div>`;
                });
            }
            html += '</div>';
            html += `<div class="flex justify-center mt-3 pt-2"><button onclick="this.closest('.message-row').scrollIntoView({behavior:'smooth', block:'start'})" class="text-[10px] text-orange-300 hover:text-orange-500 flex items-center gap-1 transition px-2 py-1 rounded-full hover:bg-white"><i data-lucide="arrow-up" class="w-3 h-3"></i> ã“ã®å›ç­”ã®ãƒˆãƒƒãƒ—ã¸ç§»å‹•</button></div>`;
            addMessage(html, 'bot', true);
            lucide.createIcons();
        }

        function handleShiritoriResults(data) {
            let messageContent = data.message;
            if (data.result === 'continue' && data.all_candidates && data.all_candidates.length > 0) {
                const listId = `list-${Date.now()}`;
                messageContent += `
                    <div class="mt-2">
                        <button class="hint-btn" onclick="document.getElementById('${listId}').style.display='flex'; this.style.display='none';">
                            <span>ğŸ’¡ ãƒ’ãƒ³ãƒˆã‚’è¦‹ã‚‹</span>
                        </button>
                        <div id="${listId}" class="hint-list">
                            ${data.all_candidates.map(song => 
                                `<div class="hint-item" onclick="sendShiritoriAnswer('${song.replace(/'/g, "\\'")}')">${song}</div>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            if (data.result === 'unknown_song') {
                addMessage(data.message, 'bot');
                safeTrackEvent('level_end', { level_name: 'shiritori', success: false, method: 'unknown_song' });
            } else {
                if (data.result === 'user_win' || data.result === 'user_lose') {
                    const isWin = (data.result === 'user_win');
                    safeTrackEvent('level_end', { level_name: 'shiritori', success: isWin });
                    messageContent += `
                        <div class="mt-4 pt-3 border-t border-gray-600/50">
                            <p class="text-xs text-gray-300 mb-2 font-bold">ã‚‚ã†ä¸€åº¦éŠã¶ï¼Ÿ</p>
                            <div class="flex gap-2">
                                <button onclick="restartShiritori()" class="flex-1 bg-pink-500 hover:bg-pink-600 text-white text-xs py-2 px-3 rounded-lg transition font-bold shadow-sm">ã‚‚ã†ä¸€åº¦å‹è² ï¼</button>
                                <button onclick="activateSecretMode()" class="flex-1 bg-slate-600 hover:bg-slate-500 text-white text-xs py-2 px-3 rounded-lg transition font-bold shadow-sm">ã¾ãŸä»Šåº¦ğŸ‘‹</button>
                            </div>
                        </div>
                    `;
                    addMessage(messageContent, 'bot', true);
                } else {
                    addMessage(messageContent, 'bot', true);
                }
            }
        }

        function addMessage(content, type, isHtml = false) {
            const container = dom.containers[currentMode];
            const div = document.createElement('div');
            div.className = `flex items-start space-x-2 message-row ${type === 'user' ? 'justify-end' : ''}`;
            const bubbleClass = type === 'user' ? 'bubble bubble-right text-white' : 'bubble bubble-left bg-white text-gray-800';
            
            let userStyle = '';
            if (type === 'user') {
                userStyle = 'style="background-color: var(--bubble-color);"';
            }

            const iconHtml = type === 'bot' ? `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()">` : '';
            div.innerHTML = type === 'bot' 
                ? `${iconHtml}<div class="${bubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm leading-relaxed">${content}</div>` 
                : `<div class="${bubbleClass} px-4 py-3 shadow-sm max-w-[85%] text-sm leading-relaxed" ${userStyle}>${content}</div>`;
            
            container.appendChild(div);
            scrollToBottom();
        }

        function addLoading() {
            const id = 'loading-' + Date.now();
            const container = dom.containers[currentMode];
            const div = document.createElement('div');
            div.id = id;
            div.className = "flex items-start space-x-2";
            const msg = LOADING_MESSAGES[currentMode][Math.floor(Math.random() * LOADING_MESSAGES[currentMode].length)];
            div.innerHTML = `<img src="${ICON_URL}" class="bot-icon w-10 h-10 rounded-full border border-gray-200 bg-white flex-shrink-0 shadow-sm z-10 trigger-secret cursor-pointer" onclick="activateSecretMode()"><div class="bubble bubble-left bg-white px-4 py-3 shadow-sm"><p class="text-sm text-gray-500 pulse-text">${msg}</p></div>`;
            container.appendChild(div);
            scrollToBottom();
            return id;
        }

        function removeLoading(id) { const el = document.getElementById(id); if (el) el.remove(); }
        function scrollToBottom() { const c = dom.containers[currentMode]; c.scrollTop = c.scrollHeight; }
        
        window.toggleModal = function(show) {
            if (show) dom.modal.classList.remove('hidden');
            else dom.modal.classList.add('hidden');
            lucide.createIcons();
        };

        function copyToClipboard(text) {
            const cleanText = text.replace(/<br>/g, '\n');
            if (navigator.clipboard) navigator.clipboard.writeText(cleanText).then(() => showToast("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼"));
            else {
                const ta = document.createElement('textarea');
                ta.value = cleanText; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
                showToast("ã‚³ãƒ”ãƒ¼ã—ãŸã‚ˆï¼");
            }
            safeTrackEvent('share', { method: 'clipboard', content_type: 'lyrics_phrase', item_name: text.substring(0, 20) });
        }

        // --- List Feature (New) ---

        function loadSongsData() {
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
            const cached = localStorage.getItem('lldb_song_list');
            const version = localStorage.getItem('lldb_song_version');
            const loadingEl = document.getElementById('list-loading');
            
            if (cached) {
                try {
                    allSongs = JSON.parse(cached);
                    renderSongList();
                    loadingEl.classList.add('hidden');
                } catch(e) {}
            }

            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
            fetch(`${GAS_API_URL}?action=get_data`) 
                .then(res => res.json())
                .then(data => {
                    if (data && data.songList) {
                        allSongs = data.songList;
                        if (!version || version != data.version) {
                            localStorage.setItem('lldb_song_list', JSON.stringify(allSongs));
                            localStorage.setItem('lldb_song_version', data.version);
                            renderSongList();
                        }
                        loadingEl.classList.add('hidden');
                    } else {
                        // ãƒ‡ãƒ¼ã‚¿å½¢å¼ãŒä¸æ­£ã€ã¾ãŸã¯ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                        console.error('Data error:', data);
                        if (!cached) {
                            loadingEl.innerText = "ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
                            loadingEl.classList.remove('hidden');
                        }
                    }
                })
                .catch(err => {
                    console.error('List fetch error', err);
                    if (!cached) {
                        loadingEl.innerText = "èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ";
                        loadingEl.classList.remove('hidden');
                    }
                });
        }

        function getDurationBucket(timeStr) {
            if (!timeStr || timeStr === '-' || timeStr === 'ä¸æ˜') return 'Unknown';
            const parts = timeStr.split(':');
            const min = parseInt(parts[0]);
            if (isNaN(min)) return 'Unknown';
            if (min === 0) return '~0:59';
            if (min >= 6) return '6:00~';
            return `${min}:00~${min}:59`;
        }

        function renderSongList() {
            const tbody = document.getElementById('song-list-body');
            tbody.innerHTML = '';

            // 1. ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            filteredSongs = allSongs.filter(song => {
                if (activeFilters.era.length > 0 && !activeFilters.era.includes(song.era)) return false;
                if (activeFilters.arranger.length > 0 && !activeFilters.arranger.includes(song.arranger)) return false;
                if (activeFilters.title.length > 0 && !activeFilters.title.includes(song.title)) return false;
                if (activeFilters.duration.length > 0) {
                    const bucket = getDurationBucket(song.duration);
                    if (!activeFilters.duration.includes(bucket)) return false;
                }
                return true;
            });

            // 2. ã‚½ãƒ¼ãƒˆå‡¦ç†
            if (currentSort.column) {
                filteredSongs.sort((a, b) => {
                    let valA = a[currentSort.column] || '';
                    let valB = b[currentSort.column] || '';
                    
                    // æ™‚é–“ã®å ´åˆã¯ '4:30' ãªã©ã‚’æ¯”è¼ƒå¯èƒ½ãªæ•°å€¤ã«ã™ã‚‹ç‰¹åˆ¥å‡¦ç†
                    if (currentSort.column === 'duration') {
                        valA = parseDuration(valA);
                        valB = parseDuration(valB);
                    }
                    // â˜…è¿½åŠ : æ›²åã®ç‰¹åˆ¥å‡¦ç†ï¼ˆèª­ã¿ä»®åå„ªå…ˆï¼‰
                    else if (currentSort.column === 'title') {
                        // readingãŒã‚ã‚Œã°ãã‚Œã‚’ã€ãªã‘ã‚Œã°titleã‚’ä½¿ç”¨
                        valA = (a.reading || a.title).toString();
                        valB = (b.reading || b.title).toString();
                    }

                    if (valA < valB) return currentSort.order === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.order === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // 3. ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®æ›´æ–°
            updateHeaderIcons();
            
            // Filter Bar Toggle
            const hasFilter = Object.values(activeFilters).some(arr => arr.length > 0);
            document.getElementById('filter-bar').classList.toggle('hidden', !hasFilter);

            if (filteredSongs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-400 text-xs">æ¡ä»¶ã«åˆã†æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</td></tr>';
                return;
            }

            // 4. æç”»
            filteredSongs.forEach((song, index) => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-orange-50 transition-colors border-b border-gray-100 group cursor-pointer active:scale-[0.99] transition-transform'; 
                
                tr.onclick = () => openConfirmModal(song.title);

                tr.innerHTML = `
                    <td class="p-1 text-sm text-gray-400 align-middle text-center font-mono">
                        ${index + 1}
                    </td>
                    <td class="p-1 text-sm text-gray-600 align-middle whitespace-normal leading-tight">
                        ${song.era}
                    </td>
                    <td class="p-1 text-sm text-gray-800 align-middle break-all font-bold leading-tight">
                        ${song.title}
                    </td>
                    <td class="p-1 text-sm text-gray-600 align-middle whitespace-normal leading-tight">
                        ${song.arranger}
                    </td>
                    <td class="p-1 text-right text-sm text-gray-600 align-middle whitespace-nowrap font-mono">
                        ${song.duration}
                    </td>
                `;
                tbody.appendChild(tr);
            });
            lucide.createIcons();
        }

        // ã‚½ãƒ¼ãƒˆç”¨ã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        function parseDuration(timeStr) {
            if (!timeStr || timeStr === '-' || timeStr === 'ä¸æ˜') return 0;
            const parts = timeStr.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1] || 0);
        }

        // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³æ›´æ–°
        function updateHeaderIcons() {
            const map = { era: 'icon-filter-era', title: 'icon-filter-title', arranger: 'icon-filter-arranger', duration: 'icon-filter-duration' };
            
            Object.keys(map).forEach(key => {
                const iconEl = document.getElementById(map[key]);
                if (!iconEl) return;
                
                const isActive = activeFilters[key].length > 0;
                const isSorted = currentSort.column === key;

                iconEl.classList.remove('text-gray-300', 'text-black', 'fill-black', 'text-orange-500');

                if (isActive) {
                    iconEl.classList.add('text-black', 'fill-black');
                } else if (isSorted) {
                    iconEl.classList.add('text-orange-500');
                } else {
                    iconEl.classList.add('text-gray-300');
                }
            });
            lucide.createIcons();
        }

        // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ
        function applySort(order) {
            currentSort = { column: currentFilterColumn, order: order };
            renderSongList();
            closeFilterModal();
        }

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
        function openConfirmModal(title) {
            targetSongForSearch = title;
            document.getElementById('confirm-song-title').textContent = title;
            document.getElementById('confirm-modal').classList.remove('hidden');
        }

        function closeConfirmModal() {
            document.getElementById('confirm-modal').classList.add('hidden');
            targetSongForSearch = '';
        }

        function executeSearchFromList() {
            if (!targetSongForSearch) return;
            
            const title = targetSongForSearch;
            closeConfirmModal();

            switchTab('title');
            
            setTimeout(() => {
                dom.searchInput.value = title;
                dom.searchForm.dispatchEvent(new Event('submit', { cancelable: true }));
            }, 100); 
        }

        // Filter Modal Logic
        window.openFilterModal = function(column) {
            currentFilterColumn = column;
            const modal = document.getElementById('filter-modal');
            const content = document.getElementById('filter-modal-content');
            const list = document.getElementById('filter-options-list');
            const helperMsg = document.getElementById('filter-helper-msg');
            const colNameDisplay = document.getElementById('filter-column-name');

            let options = new Set();
            let msg = "";
            let colLabel = "";

            if (column === 'era') {
                allSongs.forEach(s => options.add(s.era));
                msg = "ã‚¢ãƒ«ãƒãƒ ã«å«ã¾ã‚Œã‚‹è¡¨é¡Œæ›²ã®ã‚«ãƒƒãƒ—ãƒªãƒ³ã‚°ã‚‚å«ã‚“ã§ã‚‹ã‚ˆ";
                colLabel = "æ™‚æœŸ (ALBUM)";
            } else if (column === 'arranger') {
                allSongs.forEach(s => options.add(s.arranger));
                msg = "ç·¨æ›²è€…ã‚’é¸ã‚“ã§ã­ï¼";
                colLabel = "ç·¨æ›²è€… (ARRANGER)";
            } else if (column === 'duration') {
                allSongs.forEach(s => options.add(getDurationBucket(s.duration)));
                msg = "æ›²ã®é•·ã•ã§çµã‚Šè¾¼ã‚ã‚‹ã‚ˆã€‚";
                colLabel = "å†ç”Ÿæ™‚é–“ (DURATION)";
            } else if (column === 'title') {
                allSongs.forEach(s => options.add(s.title));
                msg = "ï¼ˆã“ã“ã¯ã¿ã‚“ãªã‚ã¾ã‚Šä½¿ã‚ãªã„ã‹ã‚‚ï¼‰";
                colLabel = "æ›²å (TITLE)";
            }

            const sortedOptions = Array.from(options).sort();

            list.innerHTML = sortedOptions.map(opt => {
                const isChecked = activeFilters[column].includes(opt);
                return `
                    <label class="flex items-center p-3 bg-white border-b border-gray-50 active:bg-gray-50 transition-colors cursor-pointer">
                        <input type="checkbox" value="${opt}" class="filter-checkbox w-5 h-5 text-orange-500 rounded focus:ring-orange-500 border-gray-300" ${isChecked ? 'checked' : ''}>
                        <span class="ml-3 text-sm text-gray-700">${opt}</span>
                    </label>
                `;
            }).join('');

            helperMsg.innerHTML = msg;
            colNameDisplay.textContent = colLabel;
            
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.style.transform = 'translateY(0)';
            }, 10);
        };

        window.closeFilterModal = function() {
            const modal = document.getElementById('filter-modal');
            const content = document.getElementById('filter-modal-content');
            content.style.transform = 'translateY(100%)';
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        };

        window.toggleAllFilters = function(check) {
            document.querySelectorAll('.filter-checkbox').forEach(cb => cb.checked = check);
        };

        window.applyFilter = function() {
            const checkboxes = document.querySelectorAll('.filter-checkbox:checked');
            const selectedValues = Array.from(checkboxes).map(cb => cb.value);
            activeFilters[currentFilterColumn] = selectedValues;
            renderSongList();
            closeFilterModal();
        };

        window.clearAllFilters = function() {
            activeFilters = { era: [], title: [], arranger: [], duration: [] };
            renderSongList();
        };

        function showToast(msg) {
            dom.toast.textContent = msg; dom.toast.classList.remove('opacity-0');
            setTimeout(() => dom.toast.classList.add('opacity-0'), 2000);
        }

        function safeTrackEvent(eventName, params) {
            try {
                if (typeof gtag === 'function') {
                    gtag('event', eventName, params);
                }
            } catch (e) {
                console.warn('GA4 Tracking Error:', e);
            }
        }
    </script>
</body>
</html>
